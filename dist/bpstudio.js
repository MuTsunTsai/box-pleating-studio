!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.BPStudio=e()}(this,(function(){var t=this&&this.__decorate||function(t,e,i,s){var n,r=arguments.length,o=r<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,s);else for(var h=t.length-1;h>=0;h--)(n=t[h])&&(o=(r<3?n(o):r>3?n(e,i,o):n(e,i))||o);return r>3&&o&&Object.defineProperty(e,i,o),o};if("object"!=typeof Shrewd)throw new Error("BPStudio requires Shrewd.");const{shrewd:e}=Shrewd;let i=0;const s=!1;function n(t){return e({comparer:(t,e,i)=>{if(t===e)return!0;let s=Shrewd.comparer.unorderedArray(t,e);return s}})}function r(t){return e({comparer:(t,e,i)=>{if(t===e)return!0;if(!t!=!e)return!1;if(!t)return!0;let s=f.compare(t,e);return s}})}Shrewd.option.debug=s,Shrewd.option.autoCommit=!1;let o=!1;function h(t,e,i){if(i)return i.enumerable=!1,i;Object.defineProperty(t,e,{set(t){Object.defineProperty(this,e,{value:t,writable:!0,configurable:!1})},configurable:!0})}function l(...t){if(1==t.length)return(e,i)=>a(e,i,t[0]);a(t[0],t[1],{})}function a(t,i,s){e({validator(t){var e,n;let r=d.get(this);r||d.set(this,r={});let o=null===(n=null===(e=s.validator)||void 0===e?void 0:e.apply(this,[t]))||void 0===n||n;return o&&(i in r&&r[i]!=t&&this.design.history.fieldChange(this,i,r[i],t),r[i]=t),o}})(t,i)}const d=new WeakMap;function u(t,e,i){let s=i.get;return{get(){let t=c.get(this);return t||c.set(this,t={}),e in t?t[e]:t[e]=s.apply(this)},enumerable:!1,configurable:!1}}const c=new WeakMap;class p{get axisParallels(){let t=this.shape.contour.find((t=>t.isIntegral)),e=this.direction,i=e.rotate90().normalize(),s=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY;for(let e of this.shape.contour){let r=e.sub(t).dot(i);r>n&&(n=r),r<s&&(s=r)}let r=[];for(let o=Math.ceil(s);o<=Math.floor(n);o++){let s=t.add(i.scale(new w(o))),n=[];for(let t of this.shape.ridges){let i=t.intersection(s,e);if(i&&!i.eq(n[0])&&n.push(i),2==n.length)break}2==n.length&&r.push(new jt(...n))}return r}}t([u],p.prototype,"axisParallels",null);let g=class{constructor(t){this._disposed=!1,this._disposeWith=t}disposeEvent(){this._disposed&&(Shrewd.terminate(this),this.onDispose())}get shouldDispose(){return!!this._disposeWith&&this._disposeWith._disposed}dispose(){this._disposed=!0}onDispose(){delete this._disposeWith}get disposed(){return this._disposed}};var f;t([e({renderer(t){return t||this.shouldDispose}})],g.prototype,"_disposed",void 0),t([e],g.prototype,"disposeEvent",null),g=t([e],g),function(t){function e(t,e){return{combined:i(!1).combine(t.segments,t.inverted,e.segments,e.inverted),inverted1:t.inverted,inverted2:e.inverted}}function i(t){function e(t,e,i){return{start:t,end:e,myFill:{above:i.myFill.above,below:i.myFill.below},otherFill:null}}var i=r.create();function n(t,e){i.insertBefore(t,(function(i){return i===t?0:function(t,e,i,n,r,o){var h=s.pointsCompare(e,r);return 0!==h?h:s.pointsSame(i,o)?0:t!==n?t?1:-1:s.pointAboveOrOnLine(i,n?r:o,n?o:r)?1:-1}(t.isStart,t.pt,e,i.isStart,i.pt,i.other.pt)}))}function o(t,e){var i=function(t,e){var i=r.node({isStart:!0,pt:t.start,seg:t,primary:e,other:null,status:null});return n(i,t.end),i}(t,e);return function(t,e,i){var s=r.node({isStart:!1,pt:e.end,seg:e,primary:i,other:t,status:null});t.other=s,n(s,t.pt)}(i,t,e),i}function h(t,i){var s=e(i,t.seg.end,t.seg);return function(t,e){t.other.remove(),t.seg.end=e,t.other.pt=e,n(t.other,t.pt)}(t,i),o(s,t.primary)}function l(e,n){var o=r.create();function l(t){return o.findTransition({ev:t},(function(e){return e.ev===t?0:-(i=t,n=e.ev,r=i.seg.start,o=i.seg.end,h=n.seg.start,l=n.seg.end,s.pointsCollinear(r,h,l)?s.pointsCollinear(o,h,l)||s.pointAboveOrOnLine(o,h,l)?1:-1:s.pointAboveOrOnLine(r,h,l)?1:-1);var i,n,r,o,h,l}))}function a(t,e){var i=t.seg,n=e.seg,r=i.start,o=i.end,l=n.start,a=n.end,d=s.linesIntersect(r,o,l,a);if(!1===d){if(!s.pointsCollinear(r,o,l))return!1;if(s.pointsSame(r,a)||s.pointsSame(o,l))return!1;var u=s.pointsSame(r,l),c=s.pointsSame(o,a);if(u&&c)return e;var p=!u&&s.pointBetween(r,l,a),g=!c&&s.pointBetween(o,l,a);if(u)return g?h(e,o):h(t,a),e;p&&(c||(g?h(e,o):h(t,a)),h(e,r))}else 0===d.alongA&&(-1===d.alongB?h(t,l):0===d.alongB?h(t,d.pt):1===d.alongB&&h(t,a)),0===d.alongB&&(-1===d.alongA?h(e,r):0===d.alongA?h(e,d.pt):1===d.alongA&&h(e,o));return!1}for(var d=[];!i.isEmpty();){var u=i.getHead();if(u.isStart){var c=l(u),p=c.before?c.before.ev:null,g=c.after?c.after.ev:null;function f(){if(p){var t=a(u,p);if(t)return t}return!!g&&a(u,g)}var y,v=f();if(v){var _;if(t)(_=null===u.seg.myFill.below||u.seg.myFill.above!==u.seg.myFill.below)&&(v.seg.myFill.above=!v.seg.myFill.above);else v.seg.otherFill=u.seg.myFill;u.other.remove(),u.remove()}if(i.getHead()!==u)continue;if(t)_=null===u.seg.myFill.below||u.seg.myFill.above!==u.seg.myFill.below,u.seg.myFill.below=g?g.seg.myFill.above:e,u.seg.myFill.above=_?!u.seg.myFill.below:u.seg.myFill.below;else if(null===u.seg.otherFill)y=g?u.primary===g.primary?g.seg.otherFill.above:g.seg.myFill.above:u.primary?n:e,u.seg.otherFill={above:y,below:y};u.other.status=c.insert(r.node({ev:u}))}else{var m=u.status;if(null===m)throw new Error("PolyBool: Zero-length segment detected; your epsilon is probably too small or too large");var x=o.getIndex(m);if(x>0&&x<o.nodes.length-1){var w=o.nodes[x-1],b=o.nodes[x+1];a(w.ev,b.ev)}if(m.remove(),!u.primary){var S=u.seg.myFill;u.seg.myFill=u.seg.otherFill,u.seg.otherFill=S}d.push(u.seg)}i.getHead().remove()}return d}return t?{addRegion:function(t){for(var e,i=t[t.length-1],n=0;n<t.length;n++){e=i,i=t[n];var r=s.pointsCompare(e,i);0!==r&&o({start:r<0?e:i,end:r<0?i:e,myFill:{above:null,below:null},otherFill:null},!0)}},calculate:function(t){return l(t,!1)}}:{combine:function(t,i,s,n){return t.forEach((function(t){o(e(t.start,t.end,t),!0)})),s.forEach((function(t){o(e(t.start,t.end,t),!1)})),l(i,n)}}}let s,n,r;function o(t){var e=[],i=[];return t.forEach((function(t){var n=t.start,r=t.end;if(s.pointsSame(n,r))console.warn("PolyBool: Warning: Zero-length segment detected; your epsilon is probably too small or too large");else{for(var o={index:0,matches_head:!1,matches_pt1:!1},h={index:0,matches_head:!1,matches_pt1:!1},l=o,a=0;a<e.length;a++){var d=(f=e[a])[0],u=(f[1],f[f.length-1]);f[f.length-2];if(s.pointsSame(d,n)){if(S(a,!0,!0))break}else if(s.pointsSame(d,r)){if(S(a,!0,!1))break}else if(s.pointsSame(u,n)){if(S(a,!1,!0))break}else if(s.pointsSame(u,r)&&S(a,!1,!1))break}if(l!==o){if(l===h){var c=o.index,p=o.matches_pt1?r:n,g=o.matches_head,f=e[c],y=g?f[0]:f[f.length-1],v=g?f[1]:f[f.length-2],_=g?f[f.length-1]:f[0],m=g?f[f.length-2]:f[1];return s.pointsCollinear(v,y,p)&&(g?f.shift():f.pop(),y=v),s.pointsSame(_,p)?(e.splice(c,1),s.pointsCollinear(m,_,y)&&(g?f.pop():f.shift()),void i.push(f)):void(g?f.unshift(p):f.push(p))}var x=o.index,w=h.index,b=e[x].length<e[w].length;o.matches_head?h.matches_head?b?(M(x),q(x,w)):(M(w),q(w,x)):q(w,x):h.matches_head?q(x,w):b?(M(x),q(w,x)):(M(w),q(x,w))}else e.push([n,r])}function S(t,e,i){return l.index=t,l.matches_head=e,l.matches_pt1=i,l===o?(l=h,!1):(l=null,!0)}function M(t){e[t].reverse()}function q(t,i){var n=e[t],r=e[i],o=n[n.length-1],h=n[n.length-2],l=r[0],a=r[1];s.pointsCollinear(h,o,l)&&(n.pop(),o=h),s.pointsCollinear(o,l,a)&&r.shift(),e[t]=n.concat(r),e.splice(i,1)}})),i}t.compare=function(t,i){if(!t&&i)return!1;let s=e(t,i);return 0==(r=s,{segments:n.xor(r.combined),inverted:r.inverted1!==r.inverted2}).segments.length;var r},t.union=function(t){for(var i,s=t[0],r=1;r<t.length;r++){var o=e(s,t[r]);i=o,s={segments:n.union(i.combined),inverted:i.inverted1||i.inverted2}}return s},t.difference=function(t,i){let s=e(t,i);return r=s,{segments:n.difference(r.combined),inverted:r.inverted1&&!r.inverted2};var r},t.segments=function(t){var e=i(!0);return t.regions.forEach(e.addRegion),{segments:e.calculate(t.inverted),inverted:t.inverted}},t.polygon=function(t){return{regions:o(t.segments),inverted:t.inverted}},function(t){const e=1e-10;function i(t,i){return Math.abs(t[0]-i[0])<e}function s(t,i){return Math.abs(t[1]-i[1])<e}t.pointAboveOrOnLine=function(t,i,s){var n=i[0],r=i[1],o=s[0],h=s[1],l=t[0];return(o-n)*(t[1]-r)-(h-r)*(l-n)>=-e},t.pointBetween=function(t,i,s){var n=t[1]-i[1],r=s[0]-i[0],o=t[0]-i[0],h=s[1]-i[1],l=o*r+n*h;return!(l<e)&&!(l-(r*r+h*h)>-e)},t.pointsSameX=i,t.pointsSameY=s,t.pointsSame=function(t,e){return i(t,e)&&s(t,e)},t.pointsCompare=function(t,e){return i(t,e)?s(t,e)?0:t[1]<e[1]?-1:1:t[0]<e[0]?-1:1},t.pointsCollinear=function(t,i,s){var n=t[0]-i[0],r=t[1]-i[1],o=i[0]-s[0],h=i[1]-s[1];return Math.abs(n*h-o*r)<e},t.linesIntersect=function(t,i,s,n){var r=i[0]-t[0],o=i[1]-t[1],h=n[0]-s[0],l=n[1]-s[1],a=r*l-o*h;if(Math.abs(a)<e)return!1;var d=t[0]-s[0],u=t[1]-s[1],c=(h*u-l*d)/a,p=(r*u-o*d)/a,g={alongA:0,alongB:0,pt:[t[0]+c*r,t[1]+c*o]};return g.alongA=c<=-e?-2:c<e?-1:c-1<=-e?0:c-1<e?1:2,g.alongB=p<=-e?-2:p<e?-1:p-1<=-e?0:p-1<e?1:2,g},t.pointInsideRegion=function(t,i){for(var s=t[0],n=t[1],r=i[i.length-1][0],o=i[i.length-1][1],h=!1,l=0;l<i.length;l++){var a=i[l][0],d=i[l][1];d-n>e!=o-n>e&&(r-a)*(n-d)/(o-d)+a-s>e&&(h=!h),r=a,o=d}return h}}(s||(s={})),function(t){function e(t,e){var i=[];return t.forEach((function(t){var s=(t.myFill.above?8:0)+(t.myFill.below?4:0)+(t.otherFill&&t.otherFill.above?2:0)+(t.otherFill&&t.otherFill.below?1:0);0!==e[s]&&i.push({start:t.start,end:t.end,myFill:{above:1===e[s],below:2===e[s]},otherFill:null})})),i}t.union=function(t){return e(t,[0,2,1,0,2,2,0,0,1,0,1,0,0,0,0,0])},t.difference=function(t){return e(t,[0,0,0,0,2,0,2,0,1,1,0,0,0,1,2,0])},t.xor=function(t){return e(t,[0,2,1,0,2,0,0,1,1,0,0,2,0,1,2,0])}}(n||(n={})),function(t){t.create=function(){var t={nodes:[],exists:function(e){return t.nodes.includes(e)},getIndex:function(e){return t.nodes.indexOf(e)},isEmpty:function(){return 0===t.nodes.length},getHead:function(){return t.nodes[0]},insertBefore:function(e,i){t.findTransition(e,i).insert(e)},findTransition:function(e,i){var s=function(t){return function(e,i,s,n){for(s||(s=0),n||(n=e.length);s<n;){var r=s+n>>>1;t(e[r],i)>0?n=r:s=r+1}return s}}((function(t,e){return i(e)-i(t)}))(t.nodes,e);return{before:0===s?null:t.nodes[s-1],after:t.nodes[s]||null,insert:function(e){return t.nodes.splice(s,0,e),e.remove=function(){t.nodes.splice(t.nodes.indexOf(e),1)},e}}}};return t},t.node=function(t){return t}}(r||(r={}))}(f||(f={}));class y extends p{constructor(t){super(),ee(this,t)}get _points(){let{ox:t,oy:e,u:i,v:s}=this,n=[A.ZERO,new A(i,t+i),new A(e+i+s,t+i+s),new A(e+s,s)];return n.forEach((t=>t.addBy(this._shift))),n}get _shift(){var t,e,i,s,n,r,o,h;return new $((null!==(e=null===(t=this.shift)||void 0===t?void 0:t.x)&&void 0!==e?e:0)+(null!==(s=null===(i=this._offset)||void 0===i?void 0:i.x)&&void 0!==s?s:0),(null!==(r=null===(n=this.shift)||void 0===n?void 0:n.y)&&void 0!==r?r:0)+(null!==(h=null===(o=this._offset)||void 0===o?void 0:o.y)&&void 0!==h?h:0))}get shape(){let t=this._points.concat(),e=t.map(((t,e,i)=>new jt(t,i[(e+1)%i.length])));return(this.detours||[]).forEach((i=>{let s=i.map((t=>new A(t.x,t.y).addBy(this._shift))),n=s[0],r=s[s.length-1],o=[];for(let t=0;t<s.length-1;t++)o.push(new jt(s[t],s[t+1]));let h=e.length;for(let i=0;i<h;i++){let l=e[i].p1.eq(n);if(l||e[i].contains(n)){for(let a=1;a<h;a++){let d=(a+i)%h;if(e[d].p1.eq(r)||e[d].contains(r)){let u=d<i?h-i:a+1,c=a+1-u,p=s.concat();return o.push(new jt(r,e[d].p2)),l||(p.unshift(e[i].p1),o.unshift(new jt(e[i].p1,n))),t.splice(i,u,...p),e.splice(i,u,...o),t.splice(0,c),void e.splice(0,c)}}debugger}}})),{contour:t,ridges:e}}get anchors(){let t=this._points,{contour:e}=this.shape;return[e.some((e=>e.eq(t[0])))?t[0]:null,e.includes(t[1])?t[1]:null,e.some((e=>e.eq(t[2])))?t[2]:null,e.includes(t[3])?t[3]:null]}get direction(){let{oy:t,v:e}=this;return new $(t+e,e).doubleAngle()}get sx(){return this.oy+this.u+this.v}get sy(){return this.ox+this.u+this.v}get rank(){let t=Xt.reduce(this.oy+this.v,this.oy)[0],e=Xt.reduce(this.ox+this.u,this.ox)[0];return Math.max(t,e)}reverse(t,e){let{shift:i,detours:s,sx:n,sy:r}=this;i=i||{x:0,y:0};let o={x:t-n-i.x,y:e-r-i.y};(o.x||o.y)&&(this.shift=o),null==s||s.forEach((t=>t.forEach((t=>{t.x=n-t.x,t.y=r-t.y}))))}shrink(t=2){return c.delete(this),this.ox/=t,this.oy/=t,this.u/=t,this.v/=t,this}offset(t){!t||this._offset&&this._offset.x==t.x&&this._offset.y==t.y||(this._offset=t,c.delete(this))}addDetour(t){t=ie(t);for(let e=0;e<t.length-1;e++)t[e].x==t[e+1].x&&t[e].y==t[e+1].y&&t.splice(e--,1);1!=t.length&&(this.detours=this.detours||[],this.detours.push(t),c.delete(this))}clearDetour(){var t;(null===(t=this.detours)||void 0===t?void 0:t.length)&&(this.detours=void 0,c.delete(this))}toJSON(){return ie(this)}static*gops(t,e){let{ox:i,oy:s}=t;if([i,s].some((t=>!Number.isSafeInteger(t))))return;if(i%2&&s%2)return;void 0===e&&(e=Number.POSITIVE_INFINITY);let n=i*s/2;for(let t,r=Math.floor(Math.sqrt(n));r>0&&r+(t=n/r)+s<=e;r--)if(n%r==0&&(r==t&&(yield{ox:i,oy:s,u:r,v:t}),r!=t)){let e=new y({ox:i,oy:s,u:r,v:t}),n=new y({ox:i,oy:s,u:t,v:r});e.rank>n.rank?(yield n,yield e):(yield e,yield n)}}static instantiate(t,e=!1){return t instanceof y&&!e?t:new y(t)}}t([u],y.prototype,"_points",null),t([h],y.prototype,"_offset",void 0),t([u],y.prototype,"_shift",null),t([u],y.prototype,"shape",null),t([u],y.prototype,"anchors",null),t([u],y.prototype,"direction",null),t([u],y.prototype,"rank",null);class v extends p{constructor(t){super(),this.contour=t.contour,this.dir=t.dir}get shape(){let t=this.contour.map((t=>new A(t))),e=t.map(((t,e,i)=>new jt(t,i[(e+1)%i.length])));return{contour:t,ridges:e}}get direction(){return new $(this.dir)}static instantiate(t){return t instanceof v?t:new v(t)}}t([u],v.prototype,"shape",null),t([u],v.prototype,"direction",null);let _=class{constructor(){this._map=new Map,this._size=0}set(t,e,i){return this.has(t,e)||(this._map.has(t)||this._map.set(t,new Map),this._map.has(e)||this._map.set(e,new Map),this._size++),this._map.get(t).set(e,i),this._map.get(e).set(t,i),this}get[Symbol.toStringTag](){return"DoubleMap"}has(...t){return this._size,1==t.length?this._map.has(t[0]):this._map.has(t[0])&&this._map.get(t[0]).has(t[1])}get(...t){return this._size,1==t.length?this._map.get(t[0]):this.has(t[0],t[1])?this._map.get(t[0]).get(t[1]):void 0}get size(){return this._size}clear(){this._map.clear(),this._size=0}forEach(t,e){e||(e=this);for(let[i,s,n]of this.entries())t.apply(e,[n,i,s,this])}delete(...t){if(1==t.length){if(!this._map.has(t[0]))return!1;this._size-=this._map.get(t[0]).size,this._map.delete(t[0]);for(let e of this._map.values())e.delete(t[0]);return!0}return!!this.has(t[0],t[1])&&(this._map.get(t[0]).delete(t[1]),this._map.get(t[1]).delete(t[0]),this._size--,!0)}[Symbol.iterator](){return this.entries()}*entries(){for(let[t,e]of this.keys())yield[t,e,this.get(t,e)]}*keys(){this._size;let t=new Map;for(let e of this._map.keys()){t.set(e,new Set);for(let i of this._map.get(e).keys())t.has(i)&&t.get(i).has(e)||(t.get(e).add(i),yield[e,i])}}firstKeys(){return this._size,this._map.keys()}*values(){for(let[t,e]of this.keys())yield this.get(t,e)}};t([e],_.prototype,"_size",void 0),_=t([e],_);class m{constructor(t,e,i,s){this.source=t,this.keyGen=e,this.ctor=i,this.dtor=s,this._map=new Map}dispose(){Shrewd.terminate(this),this._map.clear(),delete this._map}render(){for(let[t,e]of this._map)this.dtor(t,e)&&this._map.delete(t);for(let t of this.source()){let e=this.keyGen(t);this._map.has(e)||this._map.set(e,this.ctor(t))}return new Map(this._map)}get(t){return this.render().get(t)}has(t){return this.render().has(t)}forEach(t,e){return this.render().forEach(t,e)}get size(){return this.render().size}[Symbol.iterator](){return this.render()[Symbol.iterator]()}entries(){return this.render().entries()}keys(){return this.render().keys()}values(){return this.render().values()}toJSON(){return Array.from(this.values()).map((t=>t.toJSON()))}}t([e],m.prototype,"render",null);let x=class{constructor(t,e){this._source=t,this._constructor=e,this._map=new _}dispose(){Shrewd.terminate(this),Shrewd.terminate(this._map)}has(...t){return this._map.has.apply(this._map,t)}get(...t){return this._map.get.apply(this._map,t)}get size(){return this._map.size}forEach(t,e){return this._map.forEach(t,e)}[Symbol.iterator](){return this._map[Symbol.iterator]()}entries(){return this._map.entries()}keys(){return this._map.keys()}firstKeys(){return this._map.firstKeys()}values(){return this._map.values()}};t([e({renderer(t){for(let e of t.firstKeys())e.disposed&&t.delete(e);let e=Array.from(this._source());e.length>1&&0==t.size&&t.set(e[0],e[1],this._constructor(e[0],e[1]));for(let i of e)if(!t.has(i)){let e=Array.from(t.firstKeys());for(let s of e)t.set(i,s,this._constructor(i,s))}return t}})],x.prototype,"_map",void 0),x=t([e],x);class w{constructor(t,e=1){if(t instanceof w)this._p=t._p,this._q=t._q*e,this._check();else{if("number"!=typeof t||"number"!=typeof e){debugger;throw new Error("Parameters are not valid")}if(!Number.isSafeInteger(t)||!Number.isSafeInteger(e)){if(Number.isFinite(t/e))return w.toFraction(t/e);debugger;throw new Error("Parameters are not valid")}this._p=t,this._q=e,this._check()}}static toFraction(t,e=1,i=0,s=w.ERROR){let n=Math.floor(t),r=t-n,o=n*i+e,h=new w(n);return r/o/((1-r)*o+i)<s?h:w.toFraction(1/r,i,o).i().a(h)}get $numerator(){return this._p}get $denominator(){return this._q}get value(){return this._p/this._q}toString(){return this._smp(),this._p+(this._q>1?"/"+this._q:"")}c(){return new w(this._p,this._q)}_smp(){[this._p,this._q]=Xt.reduce(this._p,this._q)}n(){return this._p=-this._p,this}i(){return[this._p,this._q]=[this._q,this._p],this._check()}r(){return this._p=Math.round(this.value),this._q=1,this}a(t){return this._p=this._p*t._q+this._q*t._p,this._q*=t._q,this._check()}s(t){return this._p=this._p*t._q-this._q*t._p,this._q*=t._q,this._check()}m(t){return this._p*=t._p,this._q*=t._q,this._check()}d(t){return this._p*=t._q,this._q*=t._p,this._check()}f(t){return this._p*=t,this}get isIntegral(){return this._smp(),1==this._q}_check(){return(Math.abs(this._p)>>26||Math.abs(this._q)>>26)&&this._smp(),this._q<0?(this._q=-this._q,this._p=-this._p):0==this._q&&(this._p=1),this}get neg(){return this.c().n()}get inv(){return this.c().i()}add(t){return this.c().a(t)}sub(t){return this.c().s(t)}mul(t){return this.c().m(t)}fac(t){return this.c().f(t)}div(t){return this.c().d(t)}eq(t){return this._p*t._q==this._q*t._p}lt(t){return this._p*t._q<this._q*t._p}gt(t){return this._p*t._q>this._q*t._p}le(t){return this._p*t._q<=this._q*t._p}ge(t){return this._p*t._q>=this._q*t._p}toJSON(){return this.toString()}}w.ZERO=new w(0),w.ONE=new w(1),w.TWO=new w(2),w.ERROR=1e-12;class b extends g{constructor(t,e){super(t),this.configuration=t,this.overlaps=e.overlaps,this.strategy=e.strategy}static getMaxIntersectionDistance(t,e,i,s){let n=s?2:0,r=t.node.get(e.c[n].e),o=t.node.get(i.c[n].e),h=t.node.get(e.c[2-n].e);return t.distTriple(r,o,h).d3}*generate(){let{strategy:t}=this;if(1==this.overlaps.length){let e=this.overlaps[0],i=this.configuration.repository.structure[e.parent];if(t==Wt.halfIntegral)for(let t of this.halfKamiya(e,i.sx))yield{gadgets:[t]};if(t==Wt.universal)for(let t of this.universalGPS(e,i.sx))yield{gadgets:[t]};else for(let t of y.gops(e,i.sx))yield{gadgets:[{pieces:[t]}]}}if(2==this.overlaps.length){let e=this.configuration.repository.getJoiner(this.overlaps);t==Wt.baseJoin?yield*e.baseJoin():t==Wt.standardJoin?yield*e.standardJoin():yield*e.simpleJoin(t)}}*universalGPS(t,e){let i=2,s=!1;for(;!s;){let n=ie(t);n.ox*=i,n.oy*=i;for(let t of y.gops(n,e*i)){let e=y.instantiate(t).shrink(i);if(!Number.isInteger(e.v))continue;let{ox:n,oy:r,u:o,v:h}=e,l={ox:n,oy:r,u:h,v:o},a={x:0,y:0},d={x:r+o+h,y:n+o+h};e.detours=[[a,d]],l.detours=[[d,a]];let u=e.oy+e.u+e.v,c=Math.ceil(u)-u,p=new zt({pieces:[e,l]}),g=p.reverseGPS();yield p.addSlack(2,c),yield g.addSlack(0,c),s=!0}i+=2}}*halfKamiya(t,e){if(t.ox%2==0||t.oy%2==0)return;let i=ie(t);i.ox<<=1,i.oy<<=1;for(let t of y.gops(i,2*e)){let e=y.instantiate(t);if(e.rank>3)continue;let i=e.v%2==0;if(e.ox==e.oy&&i)continue;let{ox:s,oy:n,u:r,v:o}=e.shrink(2),h=Math.abs(s-n)/2;if(!Number.isInteger(h))debugger;let l,a=Math.min(s,n);if(i&&s>=n)e.detours=[[{x:h,y:3*h},{x:n+r+o,y:s+r+o}]],l={ox:a,oy:a,u:o,v:r-h,detours:[[{x:a+r+o-h,y:a+r+o-h},{x:0,y:0}]],shift:{x:h,y:3*h}};else{if(i||!(n>=s))continue;e.detours=[[{x:n+r+o,y:s+r+o},{x:3*h,y:h}]],l={ox:a,oy:a,u:o-h,v:r,detours:[[{x:0,y:0},{x:a+r+o-h,y:a+r+o-h}]],shift:{x:3*h,y:h}}}let d=new zt({pieces:[e,l]}),u=d.reverseGPS();yield d.addSlack(2,.5),yield u.addSlack(0,.5)}}}let S=class extends g{constructor(t,e){super(t),this.view=t,this.flap=e,this.quadrants=Tt((t=>new M(this,t)))}get shouldDispose(){return super.shouldDispose||this.flap.disposed}onDispose(){delete this.flap}get distance(){return 0}get segment(){this.disposeEvent();let t=[];return this.quadrants.forEach((e=>t.push(...e.contour))),At.toSegments(t)}};t([r()],S.prototype,"segment",null),S=t([e],S);let M=class extends g{constructor(t,e){super(t),this.parent=t,this.quadrant=t.flap.quadrants[e]}get overridden(){this.disposeEvent();let t=[],e=this.parent.distance,{qv:i,fx:s,fy:n,point:r,coveredJunctions:o,pattern:h}=this.quadrant;if(!h){let h=new w(this.parent.flap.radius+e);for(let[e,l]of o){let{ox:o,oy:a}=e,d=r.add(i.scale(h));for(let t of l){let e=t.sub(d);o=Math.min(-e.x*s,o),a=Math.min(-e.y*n,a)}if(o<=0||a<=0)continue;let u=new $(o*s,a*n),c=new Lt(d,d.sub(u)).toPolyBoolPath(),p=f.segments({regions:[c],inverted:!1});t.push(p)}}return t.length?f.union(t):null}get contour(){return this.disposeEvent(),this.quadrant.makeContour(this.parent.distance)}};t([r()],M.prototype,"overridden",null),t([e({comparer:(t,e,i)=>{if(t===e)return!0;if(!t!=!e)return!1;if(!t)return!0;if(t.length!=e.length)return!1;for(let i=0;i<t.length;i++)if(!t[i].eq(e[i]))return!1;return!0}})],M.prototype,"contour",null),M=t([e],M);let q=class extends m{constructor(t,e){super(t,(t=>t),e,((t,e)=>e.disposed))}};q=t([e],q);let C=class extends m{constructor(t,e,i){super(t,e,i,((t,e)=>e.disposed))}};C=t([e],C);class I extends g{constructor(t){super(),this._oldStudio=null,this.mountTarget=t}get shouldDispose(){return super.shouldDispose||this.mountTarget instanceof I&&this.mountTarget.disposed}get $studio(){return this.disposed||!this.isActive?null:this.mountTarget instanceof I?this.mountTarget.$studio:this.mountTarget}mountEvents(){this.disposeEvent(),this.$studio!==this._oldStudio&&(this.$studio&&this.onMount(this.$studio),this._oldStudio&&this.onDismount(this._oldStudio),this._oldStudio=this.$studio)}onDispose(){this._oldStudio&&this.onDismount(this._oldStudio),super.onDispose()}get isActive(){return!0}static isActive(t){return t.isActive}onMount(t){}onDismount(t){}}t([e],I.prototype,"$studio",null),t([e],I.prototype,"mountEvents",null);let E=class extends g{constructor(t,e){for(super(t),this.node=new Map,this.edge=new _,this.nextId=0,this._jid=!1,this.pair=new x((()=>this.node.values()),((t,e)=>new Ft(t,e))),this.design=t;null==e?void 0:e.length;){let t=[],i=!1;for(let s of e)this.addEdge(s.n1,s.n2,s.length)?i=!0:t.push(s);if(!i)break;e=t}}onDispose(){Shrewd.terminate(this.edge),this.pair.dispose()}get leaf(){var t=new Set;for(let e of this.node.values())1==e.degree&&t.add(e);return t}withJID(t){let e=Array.from(this.node.values()).sort(((t,e)=>t.id-e.id)),i=0;for(let t of e)j.setJID(t,i++);this._jid=!0,t(),this._jid=!1}get jid(){return this._jid}dist(t,e){return this.disposeEvent(),t==e?0:this.pair.get(t,e).dist}getOrAddNode(t){let e;return this.node.has(t)?e=this.node.get(t):(this.node.set(t,e=new j(this,t)),t>=this.nextId&&(this.nextId=t+1)),e}split(t){let e=this.getOrAddNode(this.nextId),{n1:i,n2:s}=t;return i.parent==s&&([i,s]=[s,i]),e.parent=i,s.parent=e,this.edge.delete(i,s),this.edge.set(e,i,new D(e,i,Math.ceil(t.length/2))),this.edge.set(e,s,new D(e,s,Math.max(Math.floor(t.length/2),1))),t.dispose(),e}deleteAndMerge(t){let e=this.getOrAddNode(this.nextId),{n1:i,n2:s,a1:n,a2:r}=t;i.parent==s&&([i,s]=[s,i],[n,r]=[r,n]),e.parent=i.parent,this.edge.delete(i,s);for(let t of n){let s=t.n(i);s!=e.parent&&(s.parent=e),this.edge.delete(s,i),this.edge.set(e,s,new D(e,s,t.length))}for(let t of r){let i=t.n(s);i.parent=e,this.edge.delete(i,s),this.edge.set(e,i,new D(e,i,t.length))}return i.dispose(!0),s.dispose(!0),e}deleteAndJoin(t){let e=t.edges;if(2!=e.length)return void console.warn(`Incorrectly calling delete-and-join at [${t.id}].`);let i=e[0],s=e[1],n=i.n(t),r=s.n(t);t.parent==r&&([n,r]=[r,n]),r.parent=n;let o=new D(n,r,i.length+s.length);return this.edge.set(n,r,o),t.dispose(!0),o}addLeafAt(t,e){let i=this.nextId;return this.addEdge(t,i,e),this.node.get(i)}addEdge(t,e,i){let s=this.node.has(t),n=this.node.has(e);if(0!=this.node.size&&!s&&!n)return console.warn(`Adding edge (${t},${e}) disconnects the graph.`),!1;let r=this.getOrAddNode(t),o=this.getOrAddNode(e);if(this.edge.has(r,o))return this.edge.get(r,o).length=i,!1;if(s&&n)return console.warn(`Adding edge (${t},${e}) will cause circuit.`),!1;s?o.parent=r:n?r.parent=o:t<e?o.parent=r:r.parent=o;let h=new D(r,o,i);return this.edge.set(r,o,h),!0}distTriple(t,e,i){let s=this.dist(t,e),n=this.dist(t,i),r=this.dist(e,i),o=(s+n+r)/2;return{d1:o-r,d2:o-n,d3:o-s}}};t([e({renderer(t){for(let[e,i]of t)i.disposed&&t.delete(e);return t}})],E.prototype,"node",void 0),t([e({renderer(t){for(let e of t.firstKeys())e.disposed&&t.delete(e);return t}})],E.prototype,"edge",void 0),t([e],E.prototype,"leaf",null),E=t([e],E);class N{constructor(...t){1==t.length&&(t=[t[0]._x,t[0]._y]),this._x=new w(t[0]),this._y=new w(t[1])}get x(){return this._x.value}set x(t){this._x=new w(t)}get y(){return this._y.value}set y(t){this._y=new w(t)}eq(t){return!!t&&(this._x.eq(t._x)&&this._y.eq(t._y))}clone(){return new this.constructor(this._x,this._y)}toString(){return"("+this._x+", "+this._y+")"}toJSON(){return this.toString()}set(t,e=0){return t instanceof N?(this._x=t._x.c(),this._y=t._y.c()):(this._x=new w(t),this._y=new w(e)),this}add(t){return new this.constructor(this._x.add(t._x),this._y.add(t._y))}addBy(t){return this._x.a(t._x),this._y.a(t._y),this}round(t=1){let e=new w(t);return this._x.d(e).r().m(e),this._y.d(e).r().m(e),this}range(t,e,i,s){return this._x.lt(t)&&(this._x=t),this._x.gt(e)&&(this._x=e),this._y.lt(i)&&(this._y=i),this._y.gt(s)&&(this._y=s),this}toIPoint(){return{x:this.x,y:this.y}}}let P=class extends b{constructor(t,e){super(t,e),this.cornerMap=[];for(let[t,i]of e.overlaps.entries())for(let[e,s]of i.c.entries())this.cornerMap.push([s,t,e])}get intersectionCorners(){return this.cornerMap.filter((t=>{let e=t[0].type;return e==Nt.side||e==Nt.intersection}))}get outCorners(){return this.intersectionCorners.concat(this.cornerMap.filter((t=>t[0].type==Nt.flap)))}get constraints(){return this.cornerMap.filter((t=>{let e=t[0].type;return e==Nt.socket||e==Nt.internal||e==Nt.flap}))}getOriginalDisplacement(t){let e=this.overlaps.find((t=>t.c[0].type!=Nt.coincide));return t.getConnectionTarget(e.c[0]).sub(this.configuration.repository.stretch.origin)}get _sideConnectionTarget(){this.disposeEvent();let t=new Map,e=this.configuration.sheet.design.flapsById;for(let[i,s,n]of this.intersectionCorners){let r=this.overlaps[s],o=this.getParent(r),[h,l]=[o.c[0],o.c[2]],[a,d]=[e.get(h.e),e.get(l.e)];if(!a||!d)debugger;let u=a.quadrants[h.q],c=0,p=d.quadrants[l.q],g=0;if(i.type==Nt.intersection){let t=r.c[0].e<0,e=this.configuration.sheet.design.tree,s=e.node.get(i.e),n=e.distTriple(a.node,d.node,s);if(t?g=n.d2-d.radius:c=n.d1-a.radius,isNaN(c)||isNaN(g))debugger}r=this.getExposedOverlap(r);let f=u.getOverlapCorner(r,o,n,c),y=p.getOverlapCorner(r,o,Jt(n),g);t.set(i,[f,y])}return t}getExposedOverlap(t){var e;if(1==this.overlaps.length)return t;let i=ie(t),s=this.getParent(t);i.shift=null!==(e=i.shift)&&void 0!==e?e:{x:0,y:0};for(let e of this.overlaps)if(e!=t){let t=this.getParent(e),n=i.ox+i.shift.x,r=i.oy+i.shift.y;t.c[0].e==s.c[0].e&&(t.ox<s.ox&&(i.ox=n-(i.shift.x=Math.max(i.shift.x,t.ox))),t.oy<s.oy&&(i.oy=r-(i.shift.y=Math.max(i.shift.y,t.oy)))),t.c[2].e==s.c[2].e&&(t.ox<s.ox&&(i.ox=s.ox-Math.max(t.ox,s.ox-n)-i.shift.x),t.oy<s.oy&&(i.oy=s.oy-Math.max(t.oy,s.oy-r)-i.shift.y))}return i}getParent(t){return this.configuration.repository.structure[t.parent]}getSideConnectionTarget(t,e,i){let[s,n]=this._sideConnectionTarget.get(e);return s._x.gt(n._x)&&([s,n]=[n,s]),void 0===i?t._x.le(s._x)?s:t._x.ge(n._x)?n:null:0==i||3==i?s:n}toJSON(){let t={overlaps:this.overlaps,strategy:this.strategy},e=this.configuration.design.tree;if(e.jid){t.overlaps=ie(t.overlaps);for(let i of t.overlaps)for(let t of i.c)void 0!==t.e&&t.e>=0&&(t.e=e.node.get(t.e).id)}return t}};t([u],P.prototype,"intersectionCorners",null),t([u],P.prototype,"outCorners",null),t([u],P.prototype,"constraints",null),t([e],P.prototype,"_sideConnectionTarget",null),P=t([e],P);let O=class extends S{constructor(t,e){super(t,t.design.flapsById.get(e[0])),this.node=t.design.tree.node.get(e[1]),this.key=e[0]+","+e[1]}get shouldDispose(){return super.shouldDispose||!this.view.info.components.some((t=>t==this.key))}onDispose(){super.onDispose(),delete this.node}get distance(){this.disposeEvent();let{design:t,info:e}=this.view,i=this.flap;return t.tree.dist(i.node,this.node)-i.radius+e.length}get contour(){this.disposeEvent();let t=this.segment;for(let e of this.quadrants)e.overridden&&(t=f.difference(t,e.overridden));return t}};t([e],O.prototype,"distance",null),t([r()],O.prototype,"contour",null),O=t([e],O);class k extends I{constructor(t,e){if(super(t),this.id=k._id++,this.dragging=!1,this.edges=new q((()=>this.tree.edge.values()),(t=>new ft(this.TreeSheet,this.vertices.get(t.n1),this.vertices.get(t.n2),t))),this.rivers=new q((()=>[...this.tree.edge.values()].filter((t=>t.isRiver))),(t=>new _t(this.LayoutSheet,t))),this.vertices=new q((()=>this.tree.node.values()),(t=>new at(this.TreeSheet,t))),this.flaps=new q((()=>this.tree.leaf),(t=>new ht(this.LayoutSheet,t))),this.stretches=new q((()=>this.teams.keys()),(t=>new V(this.LayoutSheet,t))),this.data=ee(xt.getSample(),e),this.data.tree.nodes.length<3)throw new Error("Invalid format.");this.options=new St(this.data)}sortJEdge(){let t=this.edges.toJSON();if(0==t.length)return[];let e=new Set,i=[];for(;t.length;){let s=t.shift();0==e.size||e.has(s.n1)||e.has(s.n2)?(i.push(s),e.add(s.n1),e.add(s.n2)):t.push(s)}return i}get isActive(){return this instanceof L&&this.mountTarget.design==this}get patternNotFound(){return[...this.stretches.values()].some((t=>t.isTotallyValid&&null==t.pattern))}onDispose(){this.edges.dispose(),this.vertices.dispose(),this.rivers.dispose(),this.flaps.dispose(),this.stretches.dispose(),this.junctions.dispose()}get allJunctions(){return Array.from(this.junctions.values())}get validJunctions(){return this.allJunctions.filter((t=>t.isValid))}get activeJunctions(){return this.validJunctions.filter((t=>!t.isCovered))}get teams(){let t,e=new Set(this.activeJunctions),i=new Map;function s(i){if(e.has(i)){t.push(i),e.delete(i);for(let t of i.neighbors)s(t)}}for(;e.size>0;)t=[],s(e.values().next().value),t.sort(vt.sort),i.set(vt.createTeamId(t),t);return i}get devices(){let t=[];for(let e of this.stretches.values())t.push(...e.devices);return t}get stretchByQuadrant(){let t=new Map;for(let e of this.stretches.values())if(e.isActive)for(let i of e.junctions)t.set(i.q1,e),t.set(i.q2,e);return t}getStretchByQuadrant(t){var e;return null!==(e=this.stretchByQuadrant.get(t))&&void 0!==e?e:null}get flapsById(){let t=new Map;for(let e of this.flaps.values())t.set(e.node.id,e);return t}get openAnchors(){let t=new Map;for(let e of this.activeStretches){let i=e.fx*e.fy;for(let s of e.pattern.devices)for(let e of s.openAnchors){let s=i+","+(e.x-i*e.y),n=t.get(s);n||t.set(s,n=[]),n.push(e)}}return t}get activeStretches(){return[...this.stretches.values()].filter((t=>t.isActive&&!!t.pattern))}}k._id=0,t([e],k.prototype,"dragging",void 0),t([e],k.prototype,"isActive",null),t([e],k.prototype,"patternNotFound",null),t([n()],k.prototype,"allJunctions",null),t([n()],k.prototype,"validJunctions",null),t([n()],k.prototype,"activeJunctions",null),t([e],k.prototype,"teams",null),t([e],k.prototype,"devices",null),t([e],k.prototype,"stretchByQuadrant",null),t([e],k.prototype,"flapsById",null),t([e],k.prototype,"openAnchors",null),t([e],k.prototype,"activeStretches",null);class T extends I{constructor(t){super(t),this.sheet=t}get design(){return this.sheet.design}}let R=class extends I{constructor(t,e,i,...s){super(t),this._activeControlCache=[],this._independentRect=new Lt(A.ZERO,A.ZERO),this.margin=0,this.scroll={x:0,y:0},this.tag=e,this.width=i.width,this.height=i.height,this.scale=Math.max(i.scale,this.getMinScale()),this._controlMaps=s,this.view=new K(this)}get controls(){var t=[];for(let e of this._controlMaps)t.push(...e());return t}get activeControls(){return this.design.dragging||(this._activeControlCache=this.controls.filter((t=>I.isActive(t)))),this._activeControlCache}constraint(t,e){return t.range(new w(-e.x),new w(this.width-e.x),new w(-e.y),new w(this.height-e.y))}get width(){return this._width}set width(t){if(t>=8&&t>=this._independentRect.width){let e=t-this._independentRect.right;if(e<0)for(let t of this.independents)t.location.x+=e;this._width=t}}get height(){return this._height}set height(t){if(t>=8&&t>=this._independentRect.height){let e=t-this._independentRect.top;if(e<0)for(let t of this.independents)t.location.y+=e;this._height=t}}getMinScale(){var t;return Math.ceil(null!==(t=this.design.display.getAutoScale(this))&&void 0!==t?t:10)}get design(){return this.mountTarget}get isActive(){return this.design.sheet==this}get displayScale(){return this.$studio?this.$studio.$display.scale:1}toJSON(){return{width:this.width,height:this.height,scale:this.scale}}get size(){return Math.max(this.width,this.height)}contains(t){return 0<=t.x&&t.x<=this.width&&0<=t.y&&t.y<=this.height}get independents(){return this.controls.filter((t=>t instanceof it))}_getIndependentRect(){let t=Number.POSITIVE_INFINITY,e=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,s=Number.NEGATIVE_INFINITY;for(let n of this.independents){let r=n.location;r.x<t&&(t=r.x),r.x+n.width>i&&(i=r.x+n.width),r.y<e&&(e=r.y),r.y+n.height>s&&(s=r.y+n.height)}this._independentRect=new Lt(new A(t,e),new A(i,s))}get viewedControls(){return this.controls.filter((t=>t instanceof Z&&t.view instanceof Q))}getMargin(){if(!this.isActive||!this.design.isActive)return;let t=this.viewedControls,e=t.length?Math.max(...t.map((t=>t.view.overflow))):0;setTimeout((()=>this.margin=e),0)}};t([n()],R.prototype,"controls",null),t([e],R.prototype,"activeControls",null),t([e],R.prototype,"_width",void 0),t([e],R.prototype,"_height",void 0),t([e({validator(t){return t>=Math.min(10,this.getMinScale())}})],R.prototype,"scale",void 0),t([e],R.prototype,"isActive",null),t([e],R.prototype,"displayScale",null),t([e],R.prototype,"size",null),t([n()],R.prototype,"independents",null),t([e],R.prototype,"_getIndependentRect",null),t([n()],R.prototype,"viewedControls",null),t([e],R.prototype,"margin",void 0),t([e],R.prototype,"getMargin",null),t([e],R.prototype,"scroll",void 0),R=t([e],R);class J extends I{constructor(){super(...arguments),this._paths=[]}draw(){this.mountEvents(),this.$studio&&this.render()}$addItem(t,e){this._paths.push([t,e])}onMount(t){for(let[e,i]of this._paths)t.$display.project.layers[e].addChild(i)}onDismount(t){for(let[t,e]of this._paths)e.remove()}contains(t){return!1}}t([e],J.prototype,"draw",null);let j=class extends g{constructor(t,e){super(t),this.name="",this.parent=null,this.tree=t,this._id=e}static setJID(t,e){t._jid=e}get tag(){return"n"+this.id}get id(){return this.tree.jid?this._jid:this._id}get parentEdge(){var t;return this.parent&&null!==(t=this.tree.edge.get(this,this.parent))&&void 0!==t?t:null}get dist(){return this.parentEdge?this.parentEdge.length+this.parent.dist:0}get depth(){return this.parent?this.parent.depth+1:0}get shouldDispose(){return super.shouldDispose||this.tree.disposed}dispose(t=!1){if(t||1==this.degree)super.dispose();else{if(2==this.degree)return this.tree.deleteAndJoin(this);1!=this.degree&&console.warn(`Node [${this.name?this.name:this.id}] is not a leaf.`)}}addLeaf(t){return this.tree.addLeafAt(this.id,t)}get design(){return this.tree.design}get edges(){this.disposeEvent();let t=this.tree.edge.get(this);return t?Array.from(t.values()):[]}get degree(){return this.edges.length}get leafEdge(){return 1==this.degree?this.edges[0]:null}get radius(){var t,e;return null!==(e=null===(t=this.leafEdge)||void 0===t?void 0:t.length)&&void 0!==e?e:NaN}};t([l],j.prototype,"name",void 0),t([e({renderer:t=>t&&t.disposed?null:t})],j.prototype,"parent",void 0),t([e],j.prototype,"parentEdge",null),t([e],j.prototype,"dist",null),t([e],j.prototype,"depth",null),t([e],j.prototype,"edges",null),t([e],j.prototype,"degree",null),t([e],j.prototype,"leafEdge",null),t([e],j.prototype,"radius",null),j=t([e],j);let D=class extends g{constructor(t,e,i){super(),this._n1=t,this._n2=e,this.length=i}get tag(){return"e"+this._n1.id+"-"+this._n2.id}get design(){return this.n1.design}get shouldDispose(){return super.shouldDispose||this._n1.disposed||this._n2.disposed}get isRiver(){return this.g1.length>1&&this.g2.length>1}adjacentEdges(t){return t.edges.filter((t=>t!=this))}get a1(){return this.adjacentEdges(this._n1)}get a2(){return this.adjacentEdges(this._n2)}group(t,e){let i=[t];for(let s of e)i.push(...s.g(t));return i}get g1(){return this.group(this._n1,this.a1)}get g2(){return this.group(this._n2,this.a2)}g(t){return t==this._n1?this.g2:this.g1}get l1(){return this.g1.filter((t=>1==t.degree))}get l2(){return this.g2.filter((t=>1==t.degree))}get t1(){return this.a1.map((t=>t.t(this._n1)+t.length)).reduce(((t,e)=>t+e),0)}get t2(){return this.a2.map((t=>t.t(this._n2)+t.length)).reduce(((t,e)=>t+e),0)}t(t){return t==this._n1?this.t2:this.t1}get p1(){return Math.max(...this.l1.map((t=>t.tree.dist(t,this.n1))))}get p2(){return Math.max(...this.l2.map((t=>t.tree.dist(t,this.n2))))}get wrapSide(){return this.isRiver?this.p1>this.p2?2:this.p1<this.p2?1:this.t1>this.t2?2:this.t1<this.t2||this.g1.length>this.g2.length?1:this.g1.length<this.g2.length?2:0:0}get n1(){return this._n1}get n2(){return this._n2}n(t){return t==this._n1?this._n2:this._n1}};t([l({validator:t=>t>0})],D.prototype,"length",void 0),t([e],D.prototype,"isRiver",null),t([e],D.prototype,"a1",null),t([e],D.prototype,"a2",null),t([e],D.prototype,"g1",null),t([e],D.prototype,"g2",null),t([e],D.prototype,"l1",null),t([e],D.prototype,"l2",null),t([e],D.prototype,"t1",null),t([e],D.prototype,"t2",null),t([e],D.prototype,"p1",null),t([e],D.prototype,"p2",null),t([e],D.prototype,"wrapSide",null),D=t([e],D);class A extends N{static get ZERO(){return new A(0,0)}constructor(...t){1==t.length?super(t[0].x,t[0].y):super(...t)}dist(t){return this.sub(t).length}paramDist(t){return Math.max(Math.abs(t.x-this.x),Math.abs(t.y-this.y))}sub(t){return t instanceof $?new A(this._x.sub(t._x),this._y.sub(t._y)):t instanceof A?new $(this._x.sub(t._x),this._y.sub(t._y)):new $(this._x.sub(new w(t.x)),this._y.sub(new w(t.y)))}subBy(t){return this._x.s(t._x),this._y.s(t._y),this}toPaper(){return new paper.Point(this.x,this.y)}eq(t){return t instanceof A||!t?super.eq(t):this.x==t.x&&this.y==t.y}get isIntegral(){return this._x.isIntegral&&this._y.isIntegral}transform(t,e){return new A(this._x.fac(t),this._y.fac(e))}}class $ extends N{static get ZERO(){return new $(0,0)}constructor(...t){1==t.length?super(t[0].x,t[0].y):super(...t)}get length(){return Math.sqrt(this.dot(this))}get slope(){return this._y.div(this._x)}rotate90(){return new $(this._y.neg,this._x)}normalize(){return this.scale(new w(this.length).inv)}scale(t,e){return t instanceof N?this.scale(t._x,t._y):(e||(e=t),new $(this._x.mul(t),this._y.mul(e)))}dot(t){return this._x.mul(t._x).a(this._y.mul(t._y)).value}get neg(){return new $(this._x.neg,this._y.neg)}get angle(){return Math.atan2(this.y,this.x)}reduce(){let[t,e]=[this._x.$numerator,this._y.$numerator],[i,s]=[this._x.$denominator,this._y.$denominator],[n,r]=Xt.reduce(t*s,e*i);return new $(Number(n),Number(r))}doubleAngle(t=1){let{x:e,y:i}=this.reduce();return[e,i]=Xt.reduce(e*e-i*i,2*e*i),new $(t*e,t*i)}parallel(t){return this._x.mul(t._y).eq(this._y.mul(t._x))}static bisector(t,e){let[i,s]=Xt.reduce(t.x,t.y),[n,r]=Xt.reduce(e.x,e.y),o=Math.sqrt(i*i+s*s),h=Math.sqrt(n*n+r*r);return new $(i*h+n*o,s*h+r*o)}}let L=class extends k{constructor(t,e){super(t,e),this.design=this,this.tag="design",this.LayoutSheet=new R(this,"layout",this.data.layout.sheet,(()=>this.flaps.values()),(()=>this.rivers.values()),(()=>this.stretches.values()),(()=>this.devices)),this.TreeSheet=new R(this,"tree",this.data.tree.sheet,(()=>this.edges.values()),(()=>this.vertices.values())),this.title=this.data.title,this.fullscreen=this.data.fullscreen,this.description=this.data.description,this.mode=this.data.mode,this.tree=new E(this,this.data.tree.edges),this.junctions=new x((()=>this.flaps.values()),((t,e)=>new vt(this.LayoutSheet,t,e))),this.history=new ct(this,this.data.history)}get sheet(){return"layout"==this.mode?this.LayoutSheet:this.TreeSheet}get display(){return this.mountTarget.$display}toJSON(t=!1){let e;return this.tree.withJID((()=>{e={title:this.title,description:this.description,fullscreen:this.fullscreen,version:xt.current,mode:this.mode,layout:{sheet:this.LayoutSheet.toJSON(),flaps:this.flaps.toJSON(),stretches:this.stretches.toJSON()},tree:{sheet:this.TreeSheet.toJSON(),nodes:this.vertices.toJSON(),edges:this.sortJEdge()}},t&&(e.history=this.history.toJSON())})),e}deleteVertices(t){this.history.takeAction((()=>{var e;let i=t.concat().sort(((t,e)=>t.node.degree-e.node.degree));for(;this.vertices.size>3;){let t=i.find((t=>1==t.node.degree));if(!t)break;t.node.dispose(),i.splice(i.indexOf(t),1),null===(e=this.$studio)||void 0===e||e.update()}}))}deleteFlaps(t){this.history.takeAction((()=>{var e;for(let i of t){if(3==this.vertices.size)break;i.node.dispose(),null===(e=this.$studio)||void 0===e||e.update()}}))}clearCPSelection(){for(let t of this.LayoutSheet.controls)t.selected=!1}clearTreeSelection(){for(let t of this.TreeSheet.controls)t.selected=!1}flapToVertex(t){this.clearTreeSelection();for(let e of t){let t=this.vertices.get(e.node);t&&(t.selected=!0)}this.mode="tree"}vertexToFlap(t){this.clearCPSelection();for(let e of t){let t=this.flaps.get(e.node);t&&(t.selected=!0)}this.mode="layout"}riverToEdge(t){this.clearTreeSelection();let e=this.edges.get(t.edge);e&&(e.selected=!0),this.mode="tree"}edgeToRiver(t){this.clearCPSelection();let e=t.edge;if(e.isRiver){let t=this.rivers.get(e);t&&(t.selected=!0)}else{let t=1==e.n1.degree?e.n1:e.n2,i=this.flaps.get(t);i&&(i.selected=!0)}this.mode="layout"}selectAll(){var t;null===(t=this.$studio)||void 0===t||t.system.$clearSelection(),"layout"==this.mode&&this.flaps.forEach((t=>t.selected=!0)),"tree"==this.mode&&this.vertices.forEach((t=>t.selected=!0))}find(t){var e;if("design"==t)return this;if("layout"==t)return this.LayoutSheet;if("tree"==t)return this.TreeSheet;let i=t.match(/^(\w+)(\d+(?:,\d+)*)(?:-(\d+))?$/);if(i){let t=i[1],s=i[2],n=Number(i[3]);if("rp"==t)return this.stretches.get(s).repository||void 0;if("cf"==t)return null===(e=this.stretches.get(s).repository)||void 0===e?void 0:e.get(n);let r=this.tree,o=r.node.get(Number(s));if("n"==t)return o;if("f"==t)return this.flaps.get(o);if("e"==t)return r.edge.get(o,r.node.get(n));if("v"==t)return this.vertices.get(o)}}};t([e],L.prototype,"fullscreen",void 0),t([e],L.prototype,"mode",void 0),t([l],L.prototype,"description",void 0),t([l],L.prototype,"title",void 0),t([e],L.prototype,"sheet",null),L=t([e],L);class F extends T{constructor(){super(...arguments),this.selected=!1}selectableWith(t){return!1}get dragSelectAnchor(){return null}toggle(){this.selected=!this.selected}contains(t){return!1}static isDragSelectable(t){return null!=t.dragSelectAnchor}}var B;t([e],F.prototype,"selected",void 0);let W=B=class extends T{constructor(t,e,i){super(t),this.flap=e,this.q=i,this.qv=B.QV[i],this.sv=B.SV[i],this.pv=B.SV[(i+1)%4],this.fx=0==this.q||3==this.q?1:-1,this.fy=0==this.q||1==this.q?1:-1}getOverlapCorner(t,e,i,s){var n,r,o,h;let l=this.flap.radius+s,a=null!==(r=null===(n=t.shift)||void 0===n?void 0:n.x)&&void 0!==r?r:0,d=null!==(h=null===(o=t.shift)||void 0===o?void 0:o.y)&&void 0!==h?h:0;return this.flap.node.id!=e.c[0].e&&(a=e.ox-(t.ox+a),d=e.oy-(t.oy+d)),new A(this.x(l-(3==i?0:t.ox)-a),this.y(l-(1==i?0:t.oy)-d))}makeContour(t){let e,i=this.flap.radius+t,s=new w(i),n=this.sv.scale(s),r=this.getStart(s),h=this.point.add(n.rotate90()),l=this.pattern;if(l){let t=l.linesForTracing[this.q].concat();o&&console.log(t.map((t=>t.toString())));let s=l.stretch.junctions,n=this.findNextDelta(s,!1),a=new Set,d=this.findLead(s,i,t,a),u=d?this.findNextDelta(s,!0):void 0;if(e=$t.create(t,null!=d?d:r,h,this.pv,a,null!=n?n:new jt(h,this.pv),u),u&&this.outside(e[0],i,this.q%2!=1)?e.unshift(this.q%2?u.yIntersection(this.y(i)):u.xIntersection(this.x(i))):e.unshift(r),n){this.outside(e[e.length-1],i,this.q%2==1)&&e.push(this.q%2?n.xIntersection(this.x(i)):n.yIntersection(this.y(i)));let t=e[e.length-1];e.push(this.q%2?new A(t._x,h._y):new A(h._x,t._y))}}else e=[r,this.point.add(this.qv.scale(s))];return e}outside(t,e,i){return i?t.x*this.fx>this.x(e)*this.fx:t.y*this.fy>this.y(e)*this.fy}getStart(t){return this.point.add(this.sv.scale(t))}y(t){return this.point.y+this.fy*t}x(t){return this.point.x+this.fx*t}findNextDelta(t,e){let i=this.findJoinNextQ(t,e,!0);if(!i)return;let{joinQ:s,nextQ:n,mode:r}=i,{d1:o,d2:h}=this.design.tree.distTriple(this.flap.node,n.flap.node,s.flap.node),l=r?new A(n.x(h),this.y(o)):new A(this.x(o),n.y(h));return new jt(l,this.qv)}findJoinNextQ(t,e,i){if(1==t.length)return;let s,n=!!(this.q%2)==e,r=n?"oy":"ox",o=vt.findMinMax(t.filter((t=>t.q1==this||t.q2==this)),r,-1),h=o.q1==this?o.q2:o.q1;if(1!=h.activeJunctions.length){if(i){let t=h.activeJunctions.concat().sort(((t,e)=>t[r]-e[r]));if(s=t[t.indexOf(o)+1],!s)return}else if(s=vt.findMinMax(h.activeJunctions,r,1),s==o)return;return{joinQ:h,nextQ:s.q1==h?s.q2:s.q1,mode:n}}}findLead(t,e,i,s){var n;let r=this.findJoinNextQ(t,!0,!1);if(!r)return;let{joinQ:o,nextQ:h}=r,l=this.design.junctions.get(this.flap,h.flap).status==yt.tooFar,a=this.design.tree.distTriple(this.flap.node,h.flap.node,o.flap.node);if(e<=a.d1&&(l||e!=a.d1))return;let d=e-a.d1+a.d2,u=this.q%2?new A(h.x(d),this.y(e)):new A(this.x(e),h.y(d));return s.add(u.toString()),null!==(n=h.findLead(t,d,i,s))&&void 0!==n?n:h.getStart(new w(d))}get pattern(){let t=this.design.getStretchByQuadrant(this);return t?t.pattern:null}get corner(){let t=new w(this.flap.radius);return this.point.add(this.qv.scale(t))}get validJunctions(){return this.flap.validJunctions.filter((t=>t.q1==this||t.q2==this))}get coveredJunctions(){return this.validJunctions.filter((t=>t.isCovered)).map((t=>{let e=t.q1==this?t.q2:t.q1;return[t,t.coveredBy.map((t=>t.q1==e?t.q2.point:t.q1.point))]}))}get point(){return this.flap.points[this.q]}get activeJunctions(){return this.validJunctions.filter((t=>!t.isCovered))}static transform(t,e,i){return e<0&&(t+=t%2?3:1),i<0&&(t+=t%2?1:3),t%4}getBaseRectangle(t,e){let i=this.design.tree.dist(e,this.flap.node),s=this.flap.radius,n=this.qv.scale(new w(i-s));return new Lt(new A(this.x(s),this.y(s)).addBy(n),new A(this.x(s-t.ox),this.y(s-t.oy)).addBy(n))}debug(t=0){o=!0,console.log(this.makeContour(t).map((t=>t.toString()))),o=!1}};W.QV=[new $(1,1),new $(-1,1),new $(-1,-1),new $(1,-1)],W.SV=[new $(1,0),new $(0,1),new $(-1,0),new $(0,-1)],t([e],W.prototype,"pattern",null),t([e],W.prototype,"corner",null),t([n()],W.prototype,"validJunctions",null),t([e],W.prototype,"coveredJunctions",null),t([e],W.prototype,"point",null),t([n()],W.prototype,"activeJunctions",null),W=B=t([e],W);let V=class extends F{constructor(t,e){super(t),this._repoCache=new Map,this.signature=e}get type(){return"Stretch"}get junctions(){var t;let e=null!==(t=this.design.teams.get(this.signature))&&void 0!==t?t:[];if(this.junctionCache&&this.junctionCache.length==e.length){for(let t in e)if(e[t]!=this.junctionCache[t])return this.junctionCache=e;return this.junctionCache}return this.junctionCache=e}get flaps(){let t=new Set;for(let e of this.junctions)t.add(e.f1),t.add(e.f2);return Array.from(t)}get origin(){var t,e,i;return null!==(i=null===(e=null===(t=this.junctions[0])||void 0===t?void 0:t.q1)||void 0===e?void 0:e.point)&&void 0!==i?i:A.ZERO}get repository(){if(!this.isValid)return null;let t,e=this.structureSignature;if(this._repoCache.has(e))t=this._repoCache.get(e);else{let i=this.design.options.get("stretch",this.signature);t=new Kt(this,e,i)}return this.design.dragging||this._repoCache.clear(),this._repoCache.set(e,t),t}get fx(){var t,e;return null!==(e=null===(t=this.junctions[0])||void 0===t?void 0:t.fx)&&void 0!==e?e:1}get fy(){var t,e;return null!==(e=null===(t=this.junctions[0])||void 0===t?void 0:t.fy)&&void 0!==e?e:1}get shouldDispose(){return super.shouldDispose||!this.isActive&&!this.design.dragging}get isActive(){return this.design.teams.has(this.signature)}get pattern(){var t,e,i;return null!==(i=null===(e=null===(t=this.repository)||void 0===t?void 0:t.entry)||void 0===e?void 0:e.entry)&&void 0!==i?i:null}get isValid(){return this.junctions.every((t=>t.status==yt.overlap))}get isTotallyValid(){if(!this.isActive)return!1;for(let t=0;t<this.flaps.length;t++)for(let e=t+1;e<this.flaps.length;e++){if(this.design.junctions.get(this.flaps[t],this.flaps[e]).status==yt.tooClose)return!1}return!0}get structureSignature(){return this.isValid?JSON.stringify(this.junctions.map((t=>{let e=t.toJSON(),i=e.c;return t.fx!=this.fx&&(e.c=[i[2],i[3],i[0],i[1]]),e}))):""}get devices(){return this.pattern?this.pattern.devices:[]}toJSON(){var t,e,i,s;return{id:vt.createTeamId(this.junctions),configuration:null!==(e=null===(t=this.pattern)||void 0===t?void 0:t.configuration.toJSON())&&void 0!==e?e:void 0,pattern:null!==(s=null===(i=this.pattern)||void 0===i?void 0:i.toJSON())&&void 0!==s?s:void 0}}};t([e],V.prototype,"junctions",null),t([e],V.prototype,"flaps",null),t([e],V.prototype,"repository",null),t([e],V.prototype,"isActive",null),t([e],V.prototype,"pattern",null),t([e],V.prototype,"isValid",null),t([e],V.prototype,"isTotallyValid",null),t([e],V.prototype,"structureSignature",null),V=t([e],V);let H=class extends T{constructor(t,e){super(t.sheet),this.configuration=t,this.devices=e.devices.map(((e,i)=>new Ht(this,t.partitions[i],e))),this.gadgets=this.devices.reduce(((t,e)=>t.concat(e.gadgets)),[]),this.signature=JSON.stringify(e)}static getSignature(t){let e=t.devices;t.devices=t.devices.map((t=>((t=ie(t)).gadgets.forEach((t=>zt.simplify(t))),t.offset=void 0,t)));let i=JSON.stringify(t);return t.devices=e,i}get shouldDispose(){return super.shouldDispose||this.configuration.disposed}get isActive(){return this.configuration.isActive&&this.configuration.entry==this}get linesForTracing(){if(!this.isActive)return Tt((t=>[]));let t=this.configuration.repository.stretch.junctions[0].direction,{fx:e,fy:i}=this.stretch,s=new w(this.design.sheet.size);return Tt((n=>{let r=[];if(t%2!=n%2)return r;for(let t of this.devices){let o=W.QV[n].scale(s);r.push(...t.ridges),r.push(...t.getConnectionRidges(!0));for(let[s,h,l]of t.partition.outCorners){let a=t.anchors[h][l];if(s.type==Nt.side||s.type==Nt.flap&&n!=W.transform(l,e,i)||s.type==Nt.internal&&n!=W.transform(s.q,e,i))r.push(new jt(a,a.add(o)));else if(s.type==Nt.intersection){let e=t.partition.overlaps[h].c.find((t=>t.type==Nt.flap)).q;if(e!=n)r.push(new jt(a,a.add(o)));else{let i=t.partition.getSideConnectionTarget(a,s,e);i&&!i.eq(a)&&r.push(new jt(a,i))}}else r.push(new jt(a,this.getConnectionTarget(s)))}}return jt.distinct(r)}))}toJSON(){return{devices:this.devices.map((t=>t.toJSON()))}}get selected(){return this.devices.some((t=>t.selected))}get stretch(){return this.configuration.repository.stretch}getConnectionTarget(t){if(t.e>=0)return this.design.flapsById.get(t.e).points[t.q];{let[e,i]=this.configuration.overlapMap.get(t.e);return this.devices[e].anchors[i][t.q]}}};t([e],H.prototype,"isActive",null),t([e],H.prototype,"linesForTracing",null),H=t([e],H);class z extends T{constructor(){super(...arguments),this.index=0,this._cache=[],this._entries=[]}get _prototypes(){if(!this.generator)return this._cache;if(this.design.dragging)return this.buildFirst(),this._cache.concat();0==this._entries.length&&this.buildFirst();for(let t of this.generator)this._cache.push(t);return delete this.generator,this._cache}buildFirst(){let t=this.generator.next();if(!t.done)try{this._entries[0]=this.builder(t.value),this._cache.push(t.value)}catch(t){console.log("Incompatible old version.")}}get entry(){let t=this._prototypes,e=this.index;return 0==t.length?null:this._entries[e]=this._entries[e]||this.builder(t[e])}move(t=1){var e;let i=this.index,s=this._prototypes.length;this.index=(this.index+t+s)%s,this.onMove(this.index,i),null===(e=this.$studio)||void 0===e||e.update()}get size(){return this._prototypes.length}indexOf(t){return this._entries.indexOf(t)}get(t){return this._entries[t]}}t([l],z.prototype,"index",void 0),t([e],z.prototype,"_prototypes",null),t([e],z.prototype,"entry",null);class G extends J{constructor(t){super(t),this.control=t}drawSelection(){this.renderSelection(this.control.selected)}}t([e],G.prototype,"drawSelection",null);let U=class extends J{constructor(t){super(t),this.visible=!1,this.$addItem(Et.drag,this._rectangle=new paper.Path.Rectangle(Ot.selection))}contains(t){return this._rectangle.contains(t)}render(){if(this._rectangle.visible=this.visible){let t=new paper.Path.Rectangle({from:this.down,to:this.now});this._rectangle.set({segments:t.segments})}}};t([e],U.prototype,"visible",void 0),t([e],U.prototype,"down",void 0),t([e],U.prototype,"now",void 0),U=t([e],U);let K=class extends J{constructor(t){super(t),this._sheet=t,this._border=new paper.Path.Rectangle({point:[0,0],size:[0,0],strokeWidth:3}),this.$addItem(Et.sheet,this._border),this._grid=new paper.CompoundPath(Ot.sheet),this.$addItem(Et.sheet,this._grid)}contains(t){return this._border.contains(t)}render(){var t;if(!this.$studio)return;let e=this._sheet.width,i=this._sheet.height;te.setRectangleSize(this._border,e,i),this._grid.visible=null===(t=this.$studio)||void 0===t?void 0:t.$display.settings.showGrid,this._grid.removeChildren();for(let t=1;t<i;t++)te.addLine(this._grid,new paper.Point(0,t),new paper.Point(e,t));for(let t=1;t<e;t++)te.addLine(this._grid,new paper.Point(t,0),new paper.Point(t,i))}};K=t([e],K);class Z extends F{contains(t){return this.view.draw(),this.view.contains(t)}}let Y=class extends z{constructor(t,e,i){super(t.sheet),this.repository=t,this.seed=i,i&&(this.seedSignature=H.getSignature(i));let s=[],n=new Map,r=-1;for(let[t,i]of e.partitions.entries())for(let[e,o]of i.overlaps.entries())s.push(o),n.set(r--,[t,e]);this.overlaps=s,this.overlapMap=n,this.partitions=e.partitions.map((t=>new P(this,t))),this.generator=this.generate()}get tag(){return"cf"+this.repository.stretch.signature+"-"+this.repository.indexOf(this)}get shouldDispose(){return super.shouldDispose||this.repository.disposed}get isActive(){return this.repository.isActive&&this.repository.entry==this}builder(t){return new H(this,t)}*generate(){this.seed&&(yield this.seed);yield*Yt.filter(this.search([]),(t=>!this.seedSignature||this.seedSignature!=H.getSignature(t)))}*search(t,e=0){if(e==this.partitions.length){let e=this.makePattern(ie(t));e&&(yield e)}else for(let i of this.partitions[e].generate())t.push(i),yield*this.search(t,e+1),t.pop()}makePattern(t){t.forEach((t=>t.gadgets=t.gadgets.map((t=>zt.instantiate(t)))));let e=t,i=this.repository.structure;if(1==i.length){let t=i[0].sx;if(1==e.length)return e[0].offset=Math.floor((t-e[0].gadgets[0].sx)/2),{devices:e};if(2==e.length){let[i,s]=e.map((t=>t.gadgets[0])),n=this.overlaps[0].c[2],r=this.overlaps[1].c[0],o=i.sx+s.rx(n.q,2),h=s.sx+i.rx(r.q,0);return o>t||h>t?null:(e[1].offset=t-h,{devices:e})}}if(2==i.length&&1==this.partitions.length){let[t,i]=this.overlaps,[s,n]=[t,i].map((t=>this.repository.structure[t.parent])),r=s.c[0].e==n.c[0].e,o=e[0].gadgets;return o[0].sx>s.sx||o[1].sx>n.sx?null:(r||(e[0].offset=s.sx-o[0].sx),{devices:e})}if(2==i.length&&2==this.partitions.length){let[t,i]=e.map((t=>t.gadgets[0])),[s,n]=this.overlaps,r=s.c[0].e>=0&&s.c[2].e>=0;r&&([t,i]=[i,t],[s,n]=[n,s]);let[o,h]=[s,n].map((t=>this.repository.structure[t.parent])),l=s.c[0].e<0,a=l?0:2,d=s.c[a].q,u=o.sx,c=t.sx,p=t.setupConnectionSlack(i,a,d);u-=Math.ceil(i.rx(d,a))+p;let g=l?[null!=p?p:0,0]:[u-c,h.sx-i.sx];return r&&g.reverse(),c>u?null:i.contains(this.getRelativeDelta(o,h,i))?null:(e.forEach(((t,e)=>t.offset=g[e])),{devices:e})}return null}getRelativeDelta(t,e,i){let s=t.c[0].e==e.c[0].e,n=b.getMaxIntersectionDistance(this.design.tree,t,e,s);e.ox>t.ox&&([t,e]=[e,t]);let r={x:n-e.ox,y:n-t.oy};return s||(r.x=i.sx-r.x,r.y=i.sy-r.y),new A(r)}onMove(){this.repository.stretch.selected=!this.entry.selected}toJSON(){return{partitions:this.partitions.map((t=>t.toJSON()))}}};t([e],Y.prototype,"isActive",null),Y=t([e],Y);class Q extends G{get overflow(){if(this.disposed||!this.$studio)return 0;this.draw();let t=0,e=this._label.bounds,i=this.$studio.$display.scale*this.control.sheet.width,s=e.x,n=e.x+e.width;return s<0&&(t=-s),n>i&&(t=Math.max(t,n-i)),Math.ceil(t)}}t([e],Q.prototype,"overflow",null);let X=class extends J{constructor(t){super(t),this._junction=t,this.$addItem(Et.junction,this._shade=new paper.CompoundPath(Ot.junction))}render(){if(this._shade.visible=this._junction.status==yt.tooClose){let t=this._junction.f1,e=this._junction.f2,i=t.view,s=e.view,n=this._junction.$treeDistance-(t.radius+e.radius),r=[i.circleJSON,s.circleJSON];0!=n&&r.push(i.makeJSON(n),s.makeJSON(n)),wt.processJunction(this._shade,r)}}};X=t([e],X);let tt=class extends G{constructor(t){super(t),this.components=new q((()=>this.info.components),(t=>new O(this,t.split(",").map((t=>Number(t)))))),this._rendered=!1,this.$addItem(Et.shade,this._shade=new paper.CompoundPath(Ot.shade)),this.$addItem(Et.hinge,this._hinge=new paper.CompoundPath(Ot.hinge)),this.$addItem(Et.ridge,this._ridge=new paper.CompoundPath(Ot.ridge)),this.boundary=new paper.CompoundPath({})}contains(t){return this.control.sheet.view.contains(t)&&this._shade.contains(t)}get info(){if(this.disposed)return{inner:[],length:0,components:[]};let t,e,i=this.control.edge;0==i.wrapSide?(e=this.toComponents(i.l1,i.n1).concat(this.toComponents(i.l2,i.n2)),t=i.a1.concat(i.a2)):2==i.wrapSide?(e=this.toComponents(i.l2,i.n2),t=i.a2):(e=this.toComponents(i.l1,i.n1),t=i.a1);let s=[],n=this.design;for(let e of t)if(e.isRiver){let t=n.rivers.get(e);s.push(t.view)}else{let t=n.flaps.get(1==e.n1.degree?e.n1:e.n2);s.push(t.view)}return{inner:s,length:i.length,components:e}}toComponents(t,e){return t.map((t=>t.id+","+e.id))}get design(){return this.control.sheet.design}onDispose(){Shrewd.terminate(this.components),super.onDispose()}get closure(){return this.disposeEvent(),f.union([...this.components.values()].map((t=>t.contour)))}get interior(){this.disposeEvent();let t=[];for(let e of this.info.inner)t.push(e.closure);return f.union(t)}get closurePath(){return new paper.CompoundPath({children:te.fromSegments(this.closure)})}get actualPath(){this.disposeEvent();let t=this.closurePath.children,e=te.fromSegments(this.interior),i=new paper.CompoundPath({children:t.concat(e).map((t=>t.clone()))});return i.reorient(!1,!0),i}render(){te.replaceContent(this.boundary,this.closurePath,!1),te.replaceContent(this._shade,this.actualPath,!1),te.replaceContent(this._hinge,this.actualPath,!1),this._rendered=!0}get corners(){var t;this.disposeEvent();let e=this.actualPath,i=(null!==(t=e.children)&&void 0!==t?t:[e]).map((t=>t.segments.map((t=>new A(t.point)))));if(0==i[0].length)return[];let{paths:s,map:n}=At.collect(i),r=[];for(let t of s){let e=t.length,i=t[e-1],s=t[0],o=s.sub(i),h=new w(this.control.length);for(let l=0;l<e;l++){let a=t[(l+1)%e],d=a.sub(s);if(0==o.dot(d)&&o.rotate90().dot(d)>0){let t=new $(Math.sign(d.x)-Math.sign(o.x),Math.sign(d.y)-Math.sign(o.y)).scale(h),e=s.add(t);r.push([s,e,n.has(e.toString())])}i=s,s=a,o=d}}return r}renderRidge(){var t;let e=this.control.sheet.design.openAnchors;if(this.draw(),this._rendered){this._rendered=!1,this._ridge.removeChildren();for(let[i,s,n]of this.corners){let r=new jt(i,s),o=r.slope.value,h=o+","+(i.x-o*i.y),l=(null!==(t=e.get(h))&&void 0!==t?t:[]).find((t=>r.contains(t,!0)));l?te.addLine(this._ridge,i,l):n&&te.addLine(this._ridge,i,s)}}}renderSelection(t){this._shade.visible=t}};t([e],tt.prototype,"info",null),t([r()],tt.prototype,"closure",null),t([r()],tt.prototype,"interior",null),t([e],tt.prototype,"closurePath",null),t([e],tt.prototype,"actualPath",null),t([e],tt.prototype,"corners",null),t([e],tt.prototype,"renderRidge",null),tt=t([e],tt);class et extends Z{constructor(){super(...arguments),this.location={x:0,y:0}}dragStart(t){this._dragOffset=t.sub(this.location)}dragConstraint(t){if(t instanceof $)return this.constraint(t,this.location);{let e=new A(this.location),i=this.constraint(t.sub(this._dragOffset).sub(e),e);return e.add(i).add(this._dragOffset)}}drag(t){t instanceof A?(t=t.sub(this._dragOffset)).eq(this.location)||this.design.history.takeAction((()=>{this.location.x=t.x,this.location.y=t.y,this.onDragged()})):t.eq($.ZERO)||this.design.history.takeAction((()=>{this.location.x+=t.x,this.location.y+=t.y,this.onDragged()}))}onDragged(){}constraint(t,e){return $.ZERO}static relocate(t,e){if(!t||!e)return;let i=t.sheet,s=e.sheet;e.location.x=Math.round(t.location.x/i.width*s.width),e.location.y=Math.round(t.location.y/i.height*s.height)}}t([e],et.prototype,"location",void 0);class it extends et{constructor(){super(...arguments),this._isNew=!0}get isNew(){return this._isNew}set isNew(t){t||(this._isNew=t)}watchIsNew(){this._isNew&&this.sheet!=this.design.sheet&&(this._isNew=!1)}}t([e],it.prototype,"watchIsNew",null);let st=class extends Q{constructor(t){super(t),this.jsonCache=[],this.$addItem(Et.shade,this._shade=new paper.Path.Rectangle(Ot.shade)),this.$addItem(Et.hinge,this.hinge=new paper.Path.Rectangle(Ot.hinge)),this.$addItem(Et.shade,this._circle=new paper.Path(Ot.circle)),this._dots=Tt((t=>{let e=new paper.Path.Circle(Ot.dot);return this.$addItem(Et.dot,e),e})),this.$addItem(Et.ridge,this._innerRidges=new paper.CompoundPath(Ot.ridge)),this.$addItem(Et.ridge,this._outerRidges=new paper.CompoundPath(Ot.ridge)),this.$addItem(Et.label,this._glow=new paper.PointText(Ot.glow)),this.$addItem(Et.label,this._label=new paper.PointText(Ot.label)),this._component=new S(this,t)}contains(t){return this.control.sheet.view.contains(t)&&(this.hinge.contains(t)||null!=this.hinge.hitTest(t))}get circle(){return this.makeRectangle(0)}get circleJSON(){return this.circle.exportJSON()}makeRectangle(t){let e=this.control.points,i=this.control.node.radius+t;return new paper.Path.Rectangle({from:[e[2].x-i,e[2].y-i],to:[e[0].x+i,e[0].y+i],radius:i})}makeJSON(t){return this.control.selected?this.makeRectangle(t).exportJSON():this.jsonCache[t]=this.jsonCache[t]||this.makeRectangle(t).exportJSON()}clearCache(){!this.control.design.dragging&&this.jsonCache.length&&(this.jsonCache=[])}get closure(){return this._component.segment}renderHinge(){var t,e;if(this.control.disposed)return;this._circle.visible=null!==(e=null===(t=this.$studio)||void 0===t?void 0:t.$display.settings.showHinge)&&void 0!==e&&e;let i=te.fromSegments(this.closure);if(this.hinge.removeSegments(),!i.length)debugger;this.hinge.add(...i[0].segments)}render(){let t=this.control.width,e=this.control.height;this._circle.copyContent(this.circle),this.renderHinge();let i=Tt((t=>this.control.points[t].toPaper()));this._innerRidges.removeChildren(),this._innerRidges.moveTo(i[3]),i.forEach((t=>this._innerRidges.lineTo(t))),this._innerRidges.visible=t>0||e>0,this._outerRidges.removeChildren(),this.control.quadrants.forEach(((t,e)=>{null==t.pattern&&te.addLine(this._outerRidges,i[e],t.corner)})),this._shade.copyContent(this.hinge)}renderUnscaled(){if(this.mountEvents(),!this.$studio)return;this.$studio.$display.render();let t=this.control.sheet.displayScale,e=this.control.width,i=this.control.height;Tt((e=>{let i=this.control.points[e].toPaper();var s;return this._dots[e].position.set([(s=i).x*t,-s.y*t]),i})),this._dots[2].visible=e>0||i>0,this._dots[1].visible=this._dots[3].visible=e>0&&i>0,this._label.content=this.control.node.name,Qt.setLabel(this.control.sheet,this._label,this._glow,this.control.dragSelectAnchor,this._dots[0])}renderSelection(t){this._shade.visible=t}};t([e],st.prototype,"circle",null),t([e],st.prototype,"circleJSON",null),t([e],st.prototype,"clearCache",null),t([r()],st.prototype,"closure",null),t([e],st.prototype,"renderHinge",null),t([e],st.prototype,"renderUnscaled",null),st=t([e],st);let nt=class extends Q{constructor(t){super(t),this.$addItem(Et.ridge,this.line=new paper.Path.Line(Ot.edge)),this.$addItem(Et.label,this._glow=new paper.PointText(Ot.glow)),this.$addItem(Et.label,this._label=new paper.PointText(Ot.label)),this._lineRegion=new paper.Path.Line({strokeWidth:15})}contains(t){return!(null==this._lineRegion.hitTest(t)&&null==this._glow.hitTest(t.transform(this._glow.layer.matrix.inverted()))||this.control.v1.view.contains(t)||this.control.v2.view.contains(t))}render(){let t=this.control.v1.location,e=this.control.v2.location,i={x:(t.x+e.x)/2,y:(t.y+e.y)/2};this._lineRegion.segments[0].point.set([t.x,t.y]),this._lineRegion.segments[1].point.set([e.x,e.y]),this.line.copyContent(this._lineRegion),this._label.content=this.control.length.toString(),Qt.setLabel(this.control.sheet,this._label,this._glow,i,this.line)}renderSelection(t){let e=t?te.Red():te.Black();this._label.fillColor=this._label.strokeColor=this.line.strokeColor=e,this.line.strokeWidth=t?3:2}};nt=t([e],nt);let rt=class extends Q{constructor(t){super(t);let e=Object.assign({},Ot.dot,{radius:4});this.$addItem(Et.dot,this._dot=new paper.Path.Circle(e)),this.$addItem(Et.label,this._glow=new paper.PointText(Ot.glow)),this.$addItem(Et.label,this._label=new paper.PointText(Ot.label)),this._circle=new paper.Path.Circle({radius:.4})}contains(t){return this._circle.contains(t)||null!=this._glow.hitTest(t.transform(this._glow.layer.matrix.inverted()))}render(){let t=this.control.sheet.displayScale,e=this.control.location.x,i=this.control.location.y;this._circle.position.set([e,i]),this._dot.position.set([e*t,-i*t]);let s=this.control.node.edges.map((t=>{let e=this.control.sheet.design.edges.get(t).view;return e.draw(),e.line}));this._label.content=this.control.node.name,Qt.setLabel(this.control.sheet,this._label,this._glow,{x:e,y:i},this._dot,...s)}renderSelection(t){this._dot.set(t?Ot.dotSelected:Ot.dot)}};var ot;rt=t([e],rt);let ht=ot=class extends it{constructor(t,e){super(t),this.width=0,this.height=0,this.$junctions=[],this.$junctionChanged=!1,this.node=e;let i=t.design,s=i.options.get("flap",e.id);s?(this.location.x=s.x,this.location.y=s.y,this.width=s.width,this.height=s.height,this.isNew=!1):et.relocate(i.vertices.get(this.node),this),this.quadrants=Tt((e=>new W(t,this,e))),this.view=new st(this)}get type(){return"Flap"}get tag(){return"f"+this.node.id}selectableWith(t){return t instanceof ot}get dragSelectAnchor(){return{x:this.location.x+this.width/2,y:this.location.y+this.height/2}}get points(){let t=this.location.x,e=this.location.y,i=this.width,s=this.height;return[new A(t+i,e+s),new A(t,e+s),new A(t,e),new A(t+i,e)]}get name(){return this.node.name}set name(t){this.node.name=t}get radius(){return this.node.radius}set radius(t){let e=this.node.leafEdge;e&&(e.length=t)}onDragged(){this.isNew&&et.relocate(this,this.design.vertices.get(this.node))}get shouldDispose(){return super.shouldDispose||this.node.disposed||1!=this.node.degree}toJSON(){return{id:this.node.id,width:this.width,height:this.height,x:this.location.x,y:this.location.y}}constraint(t,e){return this.sheet.constraint(t,e),this.sheet.constraint(t,{x:e.x+this.width,y:e.y+this.height}),t}debug(t=0){}get junctions(){return this.design.junctions,this.$junctions}get validJunctions(){return this.junctions.filter((t=>t.isValid))}};var lt;t([l({validator(t){let e=t>=0&&t<=this.sheet.width,i=this.location.x+t-this.sheet.width;return i>0&&(this.location.x-=i),e}})],ht.prototype,"width",void 0),t([l({validator(t){let e=t>=0&&t<=this.sheet.height,i=this.location.y+t-this.sheet.height;return i>0&&(this.location.y-=i),e}})],ht.prototype,"height",void 0),t([e],ht.prototype,"dragSelectAnchor",null),t([e],ht.prototype,"points",null),t([e({comparer(){let t=this.$junctionChanged;return this.$junctionChanged=!1,!t}})],ht.prototype,"junctions",null),t([e],ht.prototype,"validJunctions",null),ht=ot=t([e],ht);let at=lt=class extends it{constructor(t,e){super(t),this.height=0,this.width=0,this.node=e;let i=t.design.options.get("vertex",this.node.id);i&&(null!=i.name&&(this.node.name=i.name),this.location.x=i.x,this.location.y=i.y,this.isNew=!!i.isNew),this.view=new rt(this)}get type(){return"Vertex"}get tag(){return"v"+this.node.id}get name(){return this.node.name}set name(t){this.node.name=t}get degree(){return this.node.degree}selectableWith(t){return t instanceof lt}get dragSelectAnchor(){return this.location}onDragged(){this.isNew&&et.relocate(this,this.design.flaps.get(this.node))}addLeaf(t=1){this.design.history.takeAction((()=>{let e=[...this.design.vertices.values()],i=this.node.addLeaf(t),s=this.findClosestEmptyPoint(e);this.design.options.set("vertex",i.id,{id:i.id,name:i.name,x:s.x,y:s.y,isNew:!0})}))}findClosestEmptyPoint(t){let{x:e,y:i}=this.location,s=new A(e+.125,i+.0625),n=[],r=new Set;for(let e of t)r.add(e.location.x+","+e.location.y);for(let t=e-5;t<=e+5;t++)for(let e=i-5;e<=i+5;e++)if(!r.has(t+","+e)){let i=new A(t,e);n.push([i,i.dist(s)])}return n.sort(((t,e)=>t[1]-e[1])),n[0][0]}deleteAndJoin(){2==this.node.degree&&this.design.history.takeAction((()=>{var t;let e=this.node.dispose();null===(t=this.$studio)||void 0===t||t.update(),this.design.edges.get(e).selected=!0}))}get shouldDispose(){return super.shouldDispose||this.node.disposed}toJSON(){return{id:this.node.id,name:this.name,x:this.location.x,y:this.location.y}}constraint(t,e){return this.sheet.constraint(t,e),t}};at=lt=t([e],at);let dt=class{constructor(t){if(this.designMap=new Map,this.design=null,this._updating=!1,"object"!=typeof paper)throw new Error("BPStudio requires paper.js.");let e=document.querySelector(t);if(null==e||!(e instanceof HTMLElement))throw new Error("selector is not valid");this.$el=e,this.$paper=new paper.PaperScope,this.$display=new mt(this),this.system=new qt(this)}load(t){return"string"==typeof t&&(t=JSON.parse(t)),this.tryLoad(xt.process(t,this.onDeprecate))}create(t){return Object.assign(t,{version:xt.current,tree:{nodes:[{id:0,name:"",x:10,y:7},{id:1,name:"",x:10,y:10},{id:2,name:"",x:10,y:13}],edges:[{n1:0,n2:1,length:1},{n1:2,n2:1,length:1}]}}),this.restore(t)}restore(t){let e=new L(this,xt.process(t,this.onDeprecate));return this.designMap.set(e.id,e),e}select(t){if(null!=t){let e=this.designMap.get(t);e&&(this.design=e)}else this.design=null}close(t){let e=this.designMap.get(t);e&&(this.designMap.delete(t),e.dispose())}closeAll(){this.design=null;for(let t of this.designMap.values())t.dispose();this.designMap.clear()}tryLoad(t){return this.design=new L(this,t),this.designMap.set(this.design.id,this.design),this.update(),this.design}toBPS(){if(!this.design)return"";let t=this.design.toJSON();delete t.history;let e=JSON.stringify(t),i=new Blob([e],{type:"application/octet-stream"});return URL.createObjectURL(i)}get TreeMaker(){return Zt}get running(){return this._updating}async update(){this._updating||(this._updating=!0,i=0,Shrewd.commit(),await wt.done(),this.$display.project.view.update(),i&&console.log("Total time: "+i+" ms"),this.onUpdate&&(this.onUpdate(),delete this.onUpdate),this._updating=!1)}};t([e],dt.prototype,"design",void 0),dt=t([e],dt);class ut{constructor(t,e){this.type=pt.field,this._design=t,this.tag=e.tag,this.prop=e.prop,this.old=e.old,this.new=e.new}tryAddTo(t){let e;if((e=t.commands[0])instanceof ut&&e.tag==this.tag&&e.prop==this.prop){if(e.new!=this.old)debugger;return e.new=this.new,!0}return!1}undo(){this._design.find(this.tag)[this.prop]=this.old}redo(){this._design.find(this.tag)[this.prop]=this.new}}t([h],ut.prototype,"_design",void 0);let ct=class extends g{constructor(t,e){super(t),this.steps=[],this.index=0,this._moving=!1,this._modified=!1,this.design=t}toJSON(){return{index:this.index,modified:this.modified,steps:this.steps}}get modified(){return this._modified}notifySave(){this._modified=!1}takeAction(t){this._modified=!0,t()}addStep(t){this.steps.length>this.index&&(this.steps.length=this.index),this.steps[this.index++]=t}get lastStep(){if(!(0==this.index||this.index<this.steps.length))return this.steps[this.index-1]}fieldChange(t,e,i,s){if(this._moving)return;let n=new ut(this.design,{tag:t.tag,prop:e,old:i,new:s}),r=this.lastStep;r&&n.tryAddTo(r)||this.addStep(new gt(n)),this._modified=!0}get canUndo(){return this.index>0}get canRedo(){return this.index<this.steps.length}undo(){this.canUndo&&(this._moving=!0,this.steps[--this.index].undo(),this._moving=!1)}redo(){this.canRedo&&(this._moving=!0,this.steps[this.index++].redo(),this._moving=!1)}};var pt;t([e],ct.prototype,"steps",void 0),t([e],ct.prototype,"index",void 0),t([e],ct.prototype,"canUndo",null),t([e],ct.prototype,"canRedo",null),ct=t([e],ct),function(t){t[t.field=0]="field",t[t.move=1]="move"}(pt||(pt={}));class gt{constructor(...t){this.commands=t}undo(){for(let t of this.commands)t.undo()}redo(){for(let t of this.commands)t.redo()}}let ft=class extends Z{constructor(t,e,i,s){super(t),this.v1=e,this.v2=i,this.edge=s,this.view=new nt(this)}get type(){return"Edge"}get shouldDispose(){return super.shouldDispose||this.edge.disposed}split(){this.design.history.takeAction((()=>this.toVertex(E.prototype.split)))}deleteAndMerge(){this.design.history.takeAction((()=>this.toVertex(E.prototype.deleteAndMerge)))}toVertex(t){var e;let i=this.v1.location,s=this.v2.location,n=Math.round((i.x+s.x)/2),r=Math.round((i.y+s.y)/2),o=t.apply(this.design.tree,[this.edge]);this.design.options.set("vertex",o.id,{id:o.id,name:o.name,x:n,y:r}),null===(e=this.$studio)||void 0===e||e.update(),this.design.vertices.get(o).selected=!0}get length(){return this.edge.length}set length(t){this.edge.length=t}toJSON(){return{n1:this.v1.node.id,n2:this.v2.node.id,length:this.edge.length}}};var yt;ft=t([e],ft),function(t){t[t.tooClose=0]="tooClose",t[t.overlap=1]="overlap",t[t.tooFar=2]="tooFar"}(yt||(yt={}));let vt=class extends T{constructor(t,e,i){super(t),e.node.id>i.node.id&&([e,i]=[i,e]),this.f1=e,this.f2=i,e.$junctions.push(this),i.$junctions.push(this),e.$junctionChanged=!0,i.$junctionChanged=!0,this.id=e.node.id+":"+i.node.id,new X(this)}static createTeamId(t){let e=new Set;return t.forEach((t=>{e.add(t.f1.node.id),e.add(t.f2.node.id)})),Array.from(e).sort(((t,e)=>t-e)).join(",")}static sort(t,e){let i=t.f1.node.id-e.f1.node.id;return 0!=i?i:t.f2.node.id-e.f2.node.id}get shouldDispose(){return super.shouldDispose||this.f1.disposed||this.f2.disposed}onDispose(){this.f1.$junctions.splice(this.f1.$junctions.indexOf(this),1),this.f2.$junctions.splice(this.f2.$junctions.indexOf(this),1),this.f1.$junctionChanged=!0,this.f2.$junctionChanged=!0}getBaseRectangle(t){let e=this.sx>0?this.q2:this.q1;return null==e?void 0:e.getBaseRectangle(this,t)}get _lca(){this.disposeEvent();let t=this.f1.node,e=this.f2.node;return t.tree.pair.get(t,e).lca}findIntersection(t){let e=this._lca,i=t._lca;if(e==i)return e;let s=e.tree.pair.get(e,i).lca;return s!=e&&s!=i?null:s==e?i:e}get coverCandidate(){let t=[];for(let e of this.sheet.design.validJunctions){if(e==this)continue;let i=this.findIntersection(e);i&&t.push([e,i])}return t}isCoveredBy(t,e){if(this.direction%2!=t.direction%2)return!1;let[i,s]=[t.getBaseRectangle(e),this.getBaseRectangle(e)];return!!(i&&s&&i.contains(s))&&(!i.equals(s)||(Math.abs(t.sx)<Math.abs(this.sx)||Math.abs(t.sy)<Math.abs(this.sy)))}get coveredBy(){if(this.disposeEvent(),!this.isValid)return[];let t=[];for(let[e,i]of this.coverCandidate)this.isCoveredBy(e,i)&&t.push(e);return t}get isCovered(){return this.disposeEvent(),this.coveredBy.some((t=>0==t.coveredBy.length))}toJSON(){return{c:[{type:Nt.flap,e:this.f1.node.id,q:this.q1.q},{type:Nt.side},{type:Nt.flap,e:this.f2.node.id,q:this.q2.q},{type:Nt.side}],ox:this.ox,oy:this.oy,sx:this.sx<0?-this.sx:this.sx}}get neighbors(){if(this.disposeEvent(),this.direction>3)return[];let t=this.q1.activeJunctions.concat(),e=this.q2.activeJunctions.concat();return t.splice(t.indexOf(this),1),e.splice(e.indexOf(this),1),t.concat(e)}get q1(){return Rt(this.direction)?this.f1.quadrants[this.direction]:null}get q2(){return Rt(this.direction)?this.f2.quadrants[Jt(this.direction)]:null}get $treeDistance(){this.disposeEvent();let t=this.f1.node,e=this.f2.node;return t.tree.dist(t,e)}get status(){return this._flapDistance<this.$treeDistance?yt.tooClose:this.ox&&this.oy?yt.overlap:yt.tooFar}get fx(){return-Math.sign(this.sx)}get fy(){return-Math.sign(this.sy)}get ox(){let t=this.$treeDistance-Math.abs(this.sx);return t>0?t:NaN}get oy(){let t=this.$treeDistance-Math.abs(this.sy);return t>0?t:NaN}get sx(){let t=this.f1.location.x,e=this.f2.location.x,i=this.f1.width,s=t-e-this.f2.width;return s>=0?s:(s=t+i-e,s<=0?s:NaN)}get sy(){let t=this.f1.location.y,e=this.f2.location.y,i=this.f1.height,s=t-e-this.f2.height;return s>=0?s:(s=t+i-e,s<=0?s:NaN)}get signX(){return Math.sign(this.sx)}get signY(){return Math.sign(this.sy)}get direction(){let t=this.signX,e=this.signY;return t<0&&e<0?It.UR:t>0&&e<0?It.UL:t>0&&e>0?It.LL:t<0&&e>0?It.LR:t<0?It.R:t>0?It.L:e<0?It.T:e>0?It.B:It.none}get _flapDistance(){let t=this.sx,e=this.sy,i=0!=t&&!isNaN(t),s=0!=e&&!isNaN(e);return i&&s?Math.sqrt(t*t+e*e):i?Math.abs(t):s?Math.abs(e):0}get isValid(){return this.status==yt.overlap}static findMinMax(t,e,i){let s=t[0][e],n=t[0];for(let r=1;r<t.length;r++)t[r][e]*i>s*i&&(n=t[r],s=t[r][e]);return n}};t([e],vt.prototype,"_lca",null),t([e],vt.prototype,"coverCandidate",null),t([n()],vt.prototype,"coveredBy",null),t([e],vt.prototype,"isCovered",null),t([e],vt.prototype,"neighbors",null),t([e],vt.prototype,"q1",null),t([e],vt.prototype,"q2",null),t([e],vt.prototype,"$treeDistance",null),t([e],vt.prototype,"status",null),t([e],vt.prototype,"fx",null),t([e],vt.prototype,"fy",null),t([e],vt.prototype,"ox",null),t([e],vt.prototype,"oy",null),t([e],vt.prototype,"sx",null),t([e],vt.prototype,"sy",null),t([e],vt.prototype,"signX",null),t([e],vt.prototype,"signY",null),t([e],vt.prototype,"direction",null),t([e],vt.prototype,"_flapDistance",null),t([e],vt.prototype,"isValid",null),vt=t([e],vt);let _t=class extends Z{constructor(t,e){super(t),this.edge=e,this.view=new tt(this)}get type(){return"River"}get shouldDispose(){return super.shouldDispose||this.edge.disposed||!this.edge.isRiver}delete(){this.design.edges.get(this.edge).deleteAndMerge()}get length(){return this.edge.length}set length(t){this.edge.length=t}};_t=t([e],_t);let mt=class{constructor(t){this.MARGIN=30,this.lockViewport=!1,this.settings={showAxialParallel:!0,showGrid:!0,showHinge:!0,showRidge:!0,showLabel:!0,showDot:!0,includeHiddenElement:!1},this._printing=!1,this._studio=t,t.$el.appendChild(this.spaceHolder=document.createElement("div")),t.$el.addEventListener("scroll",this.onScroll.bind(this)),this.spaceHolder.style.zIndex="-10",this._canvas=document.createElement("canvas"),t.$el.appendChild(this._canvas),window.addEventListener("resize",this.setSize.bind(this)),this.setSize(),setTimeout((()=>this.setSize()),10),window.addEventListener("beforeprint",this.beforePrint.bind(this)),window.addEventListener("afterprint",this.afterPrint.bind(this));let e=matchMedia("(hover: none), (pointer: coarse)").matches;document.addEventListener("focusin",(t=>{e&&(t.target instanceof HTMLInputElement||t.target instanceof HTMLTextAreaElement)&&(this.lockViewport=!0)})),document.addEventListener("focusout",(t=>this.lockViewport=!1)),t.$paper.setup(this._canvas),t.$paper.settings.insertItems=!1,this.project=t.$paper.project,this.project.view.autoUpdate=!1,this.project.currentStyle.strokeColor=te.Black(),this.project.currentStyle.strokeScaling=!1,setInterval((()=>this._studio.update()),50);for(let t of Ct.values(Et))this.project.addLayer(new paper.Layer({name:Et[t]}));this.boundary=new paper.Path.Rectangle({from:[0,0],to:[0,0]});for(let t of Ct.values(Et))Pt[t].clipped&&(this.project.layers[t].addChild(this.boundary.clone()),this.project.layers[t].clipped=!0)}setSize(){this.lockViewport||(this.viewWidth=this._studio.$el.clientWidth,this.viewHeight=this._studio.$el.clientHeight)}toSVG(){let t=Math.max(this.sheetWidth,this.viewWidth),e=Math.max(this.sheetHeight,this.viewHeight),i=(t-this.sheetWidth)/2-this.scroll.x,s=(e-this.sheetHeight)/2-this.scroll.y,n=new paper.Rectangle(i,s,this.sheetWidth,this.sheetHeight),r=this._studio.$paper.project.exportSVG({bounds:n,matrix:this.project.view.matrix});this.settings.includeHiddenElement||this.removeHidden(r);let o=new Blob([r.outerHTML],{type:"image/svg+xml"});return URL.createObjectURL(o)}removeHidden(t){let e=Array.from(t.children);for(let i of e)"hidden"==i.getAttribute("visibility")?t.removeChild(i):this.removeHidden(i)}get img(){return this._img||this.spaceHolder.appendChild(this._img=new Image),this._img}createPNG(){let t=document.createElement("canvas"),e=t.getContext("2d"),i=this.img;return new Promise((s=>{i.addEventListener("load",(()=>{t.width=i.clientWidth,t.height=i.clientHeight,e.fillStyle="white",e.fillRect(0,0,t.width,t.height),e.drawImage(i,0,0,i.naturalWidth,i.naturalHeight,0,0,i.clientWidth,i.clientHeight),this._printing=!1,t.toBlob((t=>s(t)))}),{once:!0}),this.beforePrint()}))}toPNG(){return this.createPNG().then((t=>URL.createObjectURL(t)))}copyPNG(){return this.createPNG().then((t=>navigator.clipboard.write([new ClipboardItem({"image/png":t})])))}beforePrint(){if(clearTimeout(this._debounce),!this._printing&&"visible"==document.visibilityState){let t=this.img.src;setTimeout((()=>URL.revokeObjectURL(t)),5e3),this.img.src=this.toSVG(),this._printing=!0}}afterPrint(){this._debounce=setTimeout((()=>{this._printing=!1,this._debounce=NaN}),1e3)}onScroll(){var t;let e=null===(t=this._studio.design)||void 0===t?void 0:t.sheet;e&&(e.scroll.x=this._studio.$el.scrollLeft,e.scroll.y=this._studio.$el.scrollTop)}get scroll(){var t,e;return null!==(e=null===(t=this._studio.design)||void 0===t?void 0:t.sheet.scroll)&&void 0!==e?e:{x:0,y:0}}get scale(){if(this._studio.design&&this._studio.design.sheet){if(this._studio.design.fullscreen){let t=(this.viewWidth-2*this.horMargin)/this._studio.design.sheet.width,e=(this.viewHeight-2*this.MARGIN)/this._studio.design.sheet.height;return Math.min(t,e)}return this._studio.design.sheet.scale}return 1}get horMargin(){var t,e;return Math.max((null!==(e=null===(t=this._studio.design)||void 0===t?void 0:t.sheet.margin)&&void 0!==e?e:0)+10,this.MARGIN)}get sheetWidth(){var t,e,i;return(null!==(i=null===(e=null===(t=this._studio.design)||void 0===t?void 0:t.sheet)||void 0===e?void 0:e.width)&&void 0!==i?i:0)*this.scale+2*this.horMargin}get sheetHeight(){var t,e,i;return(null!==(i=null===(e=null===(t=this._studio.design)||void 0===t?void 0:t.sheet)||void 0===e?void 0:e.height)&&void 0!==i?i:0)*this.scale+2*this.MARGIN}get isXScrollable(){return this.sheetWidth>this.viewWidth+1}get isYScrollable(){return this.sheetHeight>this.viewHeight+1}getAutoScale(t){var e,i,s;t=t||(null===(e=this._studio.design)||void 0===e?void 0:e.sheet);let n=(this.viewWidth-2*this.horMargin)/(null!==(i=null==t?void 0:t.width)&&void 0!==i?i:1),r=(this.viewHeight-2*this.MARGIN)/(null!==(s=null==t?void 0:t.height)&&void 0!==s?s:1);return Math.min(n,r)}isScrollable(){return this._studio.$el.classList.toggle("scroll-x",this.isXScrollable),this._studio.$el.classList.toggle("scroll-y",this.isYScrollable),this.isXScrollable||this.isYScrollable}renderSetting(){var t,e;let i=null!==(e="layout"!=(null===(t=this._studio.design)||void 0===t?void 0:t.mode))&&void 0!==e&&e;this.project.layers[Et.hinge].visible=this.settings.showHinge,this.project.layers[Et.ridge].visible=this.settings.showRidge||i,this.project.layers[Et.axisParallel].visible=this.settings.showAxialParallel,this.project.layers[Et.label].visible=this.settings.showLabel,this.project.layers[Et.dot].visible=this.settings.showDot||i}onSheetChange(){var t;let e=null===(t=this._studio.design)||void 0===t?void 0:t.sheet;e&&(this._studio.$el.scrollLeft=e.scroll.x,this._studio.$el.scrollTop=e.scroll.y)}render(){let t=0,e=0,i=this.scale;this._studio.design&&this._studio.design.sheet&&({width:t,height:e}=this._studio.design.sheet);let s=Math.max(this.sheetWidth,this.viewWidth),n=Math.max(this.sheetHeight,this.viewHeight);this.spaceHolder.style.width=s+"px",this.spaceHolder.style.height=n+"px",te.setRectangleSize(this.boundary,t,e);let r=this._studio.$el,o=(s-this.sheetWidth)/2+this.horMargin,h=(n+this.sheetHeight)/2-this.MARGIN;this.lockViewport?this.project.view.viewSize.set(this.viewWidth,this.viewHeight):this.project.view.viewSize.set(r.clientWidth,r.clientHeight),this.project.view.matrix.set(i,0,0,-i,o-this.scroll.x,h-this.scroll.y);for(let t of Ct.values(Et)){let e=this.project.layers[t];Pt[t].clipped&&e.children[0].set({segments:this.boundary.segments}),Pt[t].scaled||(e.applyMatrix=!1,e.matrix.set(1/i,0,0,-1/i,0,0))}}};var xt,wt,bt;t([e],mt.prototype,"viewWidth",void 0),t([e],mt.prototype,"viewHeight",void 0),t([e],mt.prototype,"settings",void 0),t([e],mt.prototype,"scale",null),t([e],mt.prototype,"horMargin",null),t([e],mt.prototype,"sheetWidth",null),t([e],mt.prototype,"sheetHeight",null),t([e],mt.prototype,"isXScrollable",null),t([e],mt.prototype,"isYScrollable",null),t([e],mt.prototype,"isScrollable",null),t([e],mt.prototype,"renderSetting",null),t([e],mt.prototype,"onSheetChange",null),t([e],mt.prototype,"render",null),mt=t([e],mt),function(t){function e(t,e){let i=[],s=new Map;for(let[e,n]of t.entries()){if(s.has(e))continue;let r=n.c.filter((t=>t.type==Nt.coincide)),o=r.find((t=>s.has(-t.e-1))),h=i.length;if(o){let t=s.get(-o.e-1);s.set(e,t),i[t].push(n)}else s.set(e,h),i.push([n]);r.forEach((n=>{e=-n.e-1,s.has(e)||(s.set(e,h),i[h].push(t[e]))}))}return i.map((t=>({overlaps:t,strategy:e})))}t.current="0",t.getSample=function(){return{title:"",version:t.current,fullscreen:!0,mode:"layout",history:{index:0,modified:!1,steps:[]},layout:{sheet:{width:16,height:16,scale:20},flaps:[],stretches:[]},tree:{sheet:{width:20,height:20,scale:16},nodes:[],edges:[]}}},t.process=function(t,i){var s;let n=!1;if("version"in t||("cp"==t.mode&&(t.mode="layout"),t.layout=t.cp,delete t.cp,t.version="beta",delete t.layout.stretches,n=!0),"beta"==t.version){t.version="rc0";let e=t.layout.stretches;if(e)for(let t of e.concat()){let i=t.configuration;!i||i.overlaps&&!i.overlaps.some((t=>t.c.some((t=>t.type==Nt.intersection&&void 0===t.e))))||(e.splice(e.indexOf(t),1),n=!0)}}if("rc0"==t.version){t.version="rc1";let i=t.layout.stretches;if(i)for(let t of i.concat()){if(t.configuration){t.configuration={partitions:e(t.configuration.overlaps,t.configuration.strategy)},t.pattern&&(1==t.configuration.partitions.length?t.pattern={devices:[{gadgets:t.pattern.gadgets,offset:null===(s=t.pattern.offsets)||void 0===s?void 0:s[0]}]}:t.pattern={devices:t.pattern.gadgets.map(((e,i)=>{var s;return{gadgets:[e],offset:null===(s=t.pattern.offsets)||void 0===s?void 0:s[i]}}))})}}}return"rc1"==t.version&&(t.version="0"),n&&i&&i(t.title),t}}(xt||(xt={}));class St{constructor(t){this.options=new Map;for(let e of t.tree.nodes)this.set("vertex",e.id,e);for(let e of t.layout.flaps)this.set("flap",e.id,e);for(let e of t.layout.stretches)this.set("stretch",e.id,e)}get(t,e){e=t+e;let i=this.options.get(e);return this.options.delete(e),i}set(t,e,i){this.options.set(t+e,i)}}!function(t){t.done=function(){return i};const e=new Worker("./lib/paper-master.js");let i=Promise.resolve(),s=null,n=0;function r(t,i){return new Promise((s=>{let n=new MessageChannel;n.port1.onmessage=t=>{let[e,i]=t.data,n=new paper.Path;n.importJSON(e),s([n,i])},e.postMessage([t,i],[n.port2])}))}function o(t){return t<.25?4:t<.5?3:t<1?2:1}t.processJunction=async function(t,e){if(s||(i=new Promise((t=>s=t))),n++,2==e.length){let[i,s]=await r(e[0],e[1]);t.removeChildren(),t.addChild(i),t.strokeWidth=o(s)}else{let[i,s]=await Promise.all([r(e[0],e[3]),r(e[1],e[2])]),[n,h]=i,[l,a]=s;t.removeChildren(),t.addChild(n),t.addChild(l),t.strokeWidth=o(h+a)}0==--n&&(s(),s=null)}}(wt||(wt={}));const Mt="undefined"!=typeof TouchEvent;let qt=bt=class{constructor(t){this.dragging=!1,this._spaceDown=!1,this._touchScaling=[0,0],this._scrolled=!1,this._possiblyReselect=!1,this._studio=t;let e=t.$paper.view.element,i=t.$paper.tool=new paper.Tool;i.onKeyDown=this._canvasKeydown.bind(this),i.onKeyUp=this._canvasKeyup.bind(this),i.onMouseDown=this._canvasMousedown.bind(this),i.onMouseDrag=this._canvasMouseDrag.bind(this),i.onMouseUp=this._canvasMouseup.bind(this),e.addEventListener("wheel",this._canvasWheel.bind(this)),e.addEventListener("touchstart",this._canvasTouch.bind(this)),document.addEventListener("mousemove",this._bodyMousemove.bind(this)),document.addEventListener("touchmove",this._bodyMousemove.bind(this)),document.addEventListener("mouseup",this._bodyMouseup.bind(this)),document.addEventListener("touchend",this._bodyMouseup.bind(this)),document.addEventListener("contextmenu",this._bodyMenu.bind(this)),this._dragSelectView=new U(t)}static controlPriority(t){return t instanceof Ht||t instanceof at?1:t instanceof ht||t instanceof ft?2:3}get _controls(){let t=this._studio.design?this._studio.design.sheet.activeControls.concat():[];return t.sort(((t,e)=>bt.controlPriority(t)-bt.controlPriority(e))),this._dragSelectables=t.filter(F.isDragSelectable),t.length||(this._ctrl=[null,null]),t}get selections(){return this._controls.filter((t=>t.selected))}draggableSelections(){this._draggableSelections=this.selections.filter((t=>t instanceof et))}get _canvas(){return this._studio.$paper.view.element}_processSelection(t,e){var i=null,s=null,n=null,r=this._controls.filter((e=>e.contains(t)));for(let t of r)i||(i=t),t.selected?s=t:s&&!n&&(n=t);if(n||!i||i.selected||(n=i),s){let t=bt.controlPriority(s);r.some((e=>bt.controlPriority(e)<t))&&(this._possiblyReselect=!0)}e?(s&&!n&&s.toggle(),n&&this._select(n)):(s||this.$clearSelection(),!s&&n&&this._select(n)),this._ctrl=[s,n],this._studio.update()}_processNextSelection(){var[t,e]=this._ctrl;this._studio.design&&!this._studio.design.dragging&&(t&&e&&this.$clearSelection(),t&&!e&&this.$clearSelection(t),e&&this._select(e)),this._studio.update()}_select(t){t.selected||0!=this.selections.length&&!this.selections[0].selectableWith(t)||(t.selected=!0)}$clearSelection(t=null){this._dragSelectView.visible=!1;for(let e of this.selections)e!=t&&(e.selected=!1)}_checkEvent(t){return!(this.isTouch(t)&&t.touches.length>1)&&!(t instanceof MouseEvent&&0!=t.button)}_canvasKeydown(t){let e=document.activeElement;return e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||this.key(t.key)}key(t){let e=new $(0,0);switch(t){case"space":return this._studio.$display.isScrollable()&&(this._canvas.style.cursor="grab",this._spaceDown=!0),!1;case"delete":let t=this.selections[0];return t instanceof ht&&this._studio.design.deleteFlaps(this.selections),t instanceof at&&this._studio.design.deleteVertices(this.selections),!1;case"up":e.set(0,1);break;case"down":e.set(0,-1);break;case"left":e.set(-1,0);break;case"right":e.set(1,0);break;default:return!0}let i=this._draggableSelections;if(0==i.length)return!0;i[0]instanceof Ht&&(e=e.scale(w.TWO));for(let t of i)e=t.dragConstraint(e);for(let t of i)t.drag(e);return!1}_canvasKeyup(){this._canvas.style.cursor="unset",this._spaceDown=!1}_canvasMousedown(t){if(t.event instanceof MouseEvent&&(this._spaceDown||2==t.event.button))return console.log(t.point.round().toString()),void this._setScroll(t.event);let e=document.activeElement;if(e instanceof HTMLElement&&e.blur(),!this._checkEvent(t.event)||this._scrollStart)return;let i=t.point;if(this._processSelection(i,t.modifiers.control||t.modifiers.meta),1==this.selections.length&&this.isTouch(t.event)&&(this._longPressTimeout=window.setTimeout((()=>{this.onLongPress()}),750)),this._draggableSelections.length){this._lastKnownCursorLocation=new A(t.downPoint).round();for(let t of this._draggableSelections)t.dragStart(this._lastKnownCursorLocation);this.dragging=!0}}_canvasMouseup(t){this._dragSelectView.visible=!1,this._checkEvent(t.event)&&(this._scrollStart?t.event instanceof MouseEvent&&(this._scrollStart=null):t.modifiers.control||t.modifiers.meta||this._processNextSelection())}_reselect(t){this.$clearSelection(),this._processSelection(t.point,!1),this._studio.update();for(let t of this._draggableSelections)t.dragStart(this._lastKnownCursorLocation);this._possiblyReselect=!1}_canvasMouseDrag(t){var e;if(!this._scrollStart)if(this._possiblyReselect&&(this._reselect(t),this.dragging=!0),this.dragging){let i=new A(t.point).round();if(this._lastKnownCursorLocation.eq(i))return;window.clearTimeout(this._longPressTimeout),null===(e=this.onDrag)||void 0===e||e.apply(null),this._lastKnownCursorLocation.set(i);for(let t of this._draggableSelections)i=t.dragConstraint(i);for(let t of this._draggableSelections)t.drag(i);this._studio.design.dragging=!0}else if(this._dragSelectables.length){if(!this._dragSelectView.visible){if(this.isTouch(t.event)&&t.downPoint.getDistance(t.point)<1)return;this.$clearSelection(),this._dragSelectView.visible=!0,this._dragSelectView.down=t.downPoint}this._dragSelectView.now=t.point;for(let t of this._dragSelectables)t.selected=this._dragSelectView.contains(new paper.Point(t.dragSelectAnchor))}}_canvasWheel(t){if(t.ctrlKey||t.metaKey){t.preventDefault();let e=this._studio.design;e&&(e.fullscreen&&(e.sheet.scale=Math.round(this._studio.$display.scale),e.fullscreen=!1),e.sheet.scale-=Math.round(t.deltaY/100))}}_canvasTouch(t){t.touches.length>1&&(this.$clearSelection(),this._setScroll(t),this._touchScaling=[this.getTouchDistance(t),this._studio.$display.scale])}getTouchDistance(t){let e=t.touches,i=e[1].screenX-e[0].screenX,s=e[1].screenY-e[0].screenY;return Math.sqrt(i*i+s*s)}_bodyMousemove(t){var e;if(this._scrollStart&&(t instanceof MouseEvent||t.touches.length>=2)){let i=this.isTouch(t)?t.touches[0]:t,s=new A(i.screenX,i.screenY).sub(this._lastKnownCursorLocation),n=this._studio.$el;if(this._studio.$display.isXScrollable&&(n.scrollLeft=this._scrollStart.x-s.x),this._studio.$display.isYScrollable&&(n.scrollTop=this._scrollStart.y-s.y),this.isTouch(t)){let i=null===(e=this._studio.design)||void 0===e?void 0:e.sheet;if(i){let e=(this.getTouchDistance(t)-this._touchScaling[0])/30,s=this._studio.$display.getAutoScale();e=Math.round(e+this._touchScaling[1]),e<=s?(i.scale=Math.ceil(s),i.design.fullscreen=!0):(i.scale=Math.ceil(e),i.design.fullscreen=!1)}}this._scrolled=!0}}_setScroll(t){let e=this._studio.$el,i=this.isTouch(t)?t.touches[0]:t;window.clearTimeout(this._longPressTimeout),this._scrollStart=new A(e.scrollLeft,e.scrollTop),this._scrolled=!1,this._lastKnownCursorLocation=new A(i.screenX,i.screenY)}_bodyMouseup(t){this._dragEnd(),window.clearTimeout(this._longPressTimeout),this.isTouch(t)&&0==t.touches.length&&(this._scrollStart=null)}_dragEnd(){this.dragging=!1,this._studio.design&&(this._studio.design.dragging=!1)}_bodyMenu(t){t.preventDefault(),this._scrollStart=null}isTouch(t){return Mt&&t instanceof TouchEvent}};var Ct,It,Et,Nt;t([e],qt.prototype,"_controls",null),t([e],qt.prototype,"selections",null),t([e],qt.prototype,"draggableSelections",null),t([e],qt.prototype,"dragging",void 0),qt=bt=t([e],qt),function(t){t.values=function(t){return Object.values(t).filter((t=>!isNaN(Number(t))))}}(Ct||(Ct={})),function(t){t[t.UR=0]="UR",t[t.UL=1]="UL",t[t.LL=2]="LL",t[t.LR=3]="LR",t[t.R=4]="R",t[t.T=5]="T",t[t.L=6]="L",t[t.B=7]="B",t[t.none=8]="none"}(It||(It={})),function(t){t[t.sheet=0]="sheet",t[t.shade=1]="shade",t[t.hinge=2]="hinge",t[t.ridge=3]="ridge",t[t.axisParallel=4]="axisParallel",t[t.junction=5]="junction",t[t.dot=6]="dot",t[t.label=7]="label",t[t.drag=8]="drag"}(Et||(Et={})),function(t){t[t.socket=0]="socket",t[t.internal=1]="internal",t[t.side=2]="side",t[t.intersection=3]="intersection",t[t.flap=4]="flap",t[t.coincide=5]="coincide"}(Nt||(Nt={}));const Pt={[Et.sheet]:{clipped:!1,scaled:!0},[Et.shade]:{clipped:!0,scaled:!0},[Et.hinge]:{clipped:!0,scaled:!0},[Et.ridge]:{clipped:!0,scaled:!0},[Et.axisParallel]:{clipped:!0,scaled:!0},[Et.junction]:{clipped:!0,scaled:!0},[Et.dot]:{clipped:!1,scaled:!1},[Et.label]:{clipped:!1,scaled:!1},[Et.drag]:{clipped:!1,scaled:!0}};var Ot;!function(t){t.circle={strokeWidth:1,strokeColor:"#69F"},t.dot={fillColor:"#69F",strokeWidth:1,strokeColor:"#000",radius:3},t.dotSelected={strokeWidth:3,strokeColor:"red"},t.hinge={strokeColor:"#69F",strokeWidth:3},t.sheet={strokeWidth:.25,strokeColor:"#000"},t.label={point:[0,0],fillColor:"black",fontWeight:"normal",strokeWidth:.5,fontSize:14},t.glow={point:[0,0],fontWeight:"normal",strokeWidth:2.5,strokeColor:"white",fontSize:14},t.edge={},t.ridge={strokeWidth:1.25,strokeColor:"red"},t.selection={strokeColor:"#69f",fillColor:"rgba(102, 153, 255, 0.2)"},t.shade={fillColor:"#69F",opacity:.3,strokeWidth:0},t.junction={strokeColor:"red",fillColor:"red",opacity:.3},t.axisParallel={strokeWidth:1,strokeColor:"green"},t.top={}}(Ot||(Ot={}));const kt=[0,1,2,3];function Tt(t){return kt.map(t)}function Rt(t){return t<4}function Jt(t){return(t+2)%4}class jt{constructor(t,e){e instanceof $&&(e=t.add(e)),this.p1=t,this.p2=e}toString(){return[this.p1,this.p2].sort().toString()}get isDegenerated(){return this.p1.eq(this.p2)}eq(t){return this.p1.eq(t.p1)&&this.p2.eq(t.p2)||this.p1.eq(t.p2)&&this.p2.eq(t.p1)}contains(t,e=!1){let i=t instanceof A?t:new A(t);if(e&&(i.eq(this.p1)||i.eq(this.p2)))return!0;var s=i.sub(this.p1),n=i.sub(this.p2);return s._x.mul(n._y).eq(n._x.mul(s._y))&&s.dot(n)<0}lineContains(t){return this.vector.parallel(t.sub(this.p1))}intersection(...t){if(1==t.length)return this.intersection(t[0].p1,t[0].p2.sub(t[0].p1));let[e,i,s]=t,n=this.p2.sub(this.p1),r=new Dt(n._x,i._x,n._y,i._y).inverse;if(null==r)return null;let o=r.multiply(new A(e.sub(this.p1))),h=o._x,l=o._y.neg;return h.lt(w.ZERO)||h.gt(w.ONE)||s&&l.lt(w.ZERO)?null:e.add(i.scale(l))}transform(t,e){return new jt(this.p1.transform(t,e),this.p2.transform(t,e))}shift(t){return new jt(this.p1.add(t),this.p2.add(t))}static distinct(t){let e=new Set;return t.filter((t=>{let i=t.toString(),s=!e.has(i);return s&&e.add(i),s}))}static subtract(t,e){let i=[],s=new Map;for(let t of e){let e=t.slope.toString(),i=s.get(e);i||s.set(e,i=[]),i.push(t)}for(let e of t){let t=e.slope.toString();s.has(t)?i.push(...e.cancel(s.get(t))):i.push(e)}return i}cancel(t){let e=[this];for(let i of t){let t=[];for(let s of e)t.push(...s._cancel(i));e=t}return e}*_cancel(t){let e=this.contains(t.p1,!0),i=this.contains(t.p2,!0),s=t.contains(this.p1,!0),n=t.contains(this.p2,!0);if(!s||!n)if(e||i)if(e&&i){let e=new jt(this.p1,t.p1),i=new jt(this.p1,t.p2),s=new jt(this.p2,t.p1),n=new jt(this.p2,t.p2);e.isDegenerated?yield n:i.isDegenerated?yield s:s.isDegenerated?yield i:n.isDegenerated?yield e:e.contains(t.p2)?(yield i,yield s):(yield e,yield n)}else{let i=e?t.p1:t.p2,s=n?this.p1:this.p2;i.eq(s)||(yield new jt(i,s))}else yield this}get slope(){return this.p1._y.sub(this.p2._y).d(this.p1._x.sub(this.p2._x))}xOrient(){return this.p1._x.gt(this.p2._x)?[this.p2,this.p1]:[this.p1,this.p2]}*gridPoints(){let{p1:t,p2:e}=this,i=e.x-t.x,s=e.y-t.y;if(Math.abs(i)<Math.abs(s)){let s=Math.sign(i);for(let i=Xt.int(t.x,s);i*s<=e.x*s;i+=s){let t=this.xIntersection(i);t.isIntegral&&(yield t)}}else{let i=Math.sign(s);for(let s=Xt.int(t.y,i);s*i<=e.y*i;s+=i){let t=this.yIntersection(s);t.isIntegral&&(yield t)}}}xIntersection(t){let e=this.p2.sub(this.p1),i=new w(t);return new A(i,this.p1._y.sub(e.slope.mul(this.p1._x.sub(i))))}yIntersection(t){let e=this.p2.sub(this.p1),i=new w(t);return new A(this.p1._x.sub(this.p1._y.sub(i).div(e.slope)),i)}reflect(t){t=t.neg;var e=new Dt(t._x,t._y.neg,t._y,t._x);return t=(t=e.inverse.multiply(this.p2.sub(this.p1))).doubleAngle(),e.multiply(t).reduce()}perpendicular(t){return 0==this.vector.dot(t)}get vector(){return this.p1.sub(this.p2)}}class Dt{constructor(t,e,i,s,n){this.a=t.c(),this.b=e.c(),this.c=i.c(),this.d=s.c(),this.det=n||this.a.mul(this.d).s(this.b.mul(this.c))}toString(){return[this.a,this.b,this.c,this.d].toString()}get determinant(){return this.det.value}get inverse(){return this.det.eq(w.ZERO)?null:new Dt(this.d.div(this.det),this.b.neg.d(this.det),this.c.neg.d(this.det),this.a.div(this.det),this.det.inv)}multiply(t){return new t.constructor(this.a.mul(t._x).a(this.b.mul(t._y)),this.c.mul(t._x).a(this.d.mul(t._y)))}static getTransformMatrix(t,e){if(t.eq($.ZERO))throw new Error("Cannot transform zero vector.");let i=new Dt(t._x,t._y.neg,t._y,t._x),{_x:s,_y:n}=i.inverse.multiply(e);return new Dt(s,n.neg,n,s)}}var At,$t;!function(t){function e(t,e,i=!1){if(2==e.length)return i&&new jt(e[0],e[1]).contains(t,!0);let s=[],n=[];for(let i of e)s.push(i._x.sub(t._x).value),n.push(i._y.sub(t._y).value);let r=!1;for(let t=0,o=e.length-1;t<e.length;o=t++){let[e,h]=[s[t],n[t]],[l,a]=[s[o],n[o]],d=e>=0,u=l>=0,c=h>=0,p=a>=0;if(!(!c&&!p||!d&&!u||d&&u)){if(!c||!p||!d&&!u||d&&u){let t=(h*l-e*a)/(l-e);if(t<0)continue;if(0==t)return i}r=!r}}return r}function i(t,e){return t.push(...t.splice(0,e)),t}t.triangleTransform=function(t,e){let[i,s,n]=t,[r,o,h]=[e,s,n].map((t=>t.sub(i))),l=Dt.getTransformMatrix(o,r);return i.add(l.multiply(h))},t.collect=function(t){let e=[],s=new Map,n=0;for(let r of t){let t=!1;for(let[o,h]of r.entries()){let l=h.toString(),a=s.get(l);if(a){if(!e[a[0]])continue;e[a[0]].splice(a[1],0,...i(r,o));for(let[t,i]of e[a[0]].entries())s.set(i.toString(),[a[0],t]);t=!0;break}s.set(l,[n,o])}t||(e.push(r),n++)}return{paths:e,map:s}},t.join=function(t,e){t=t.concat(),e=e.concat();for(let s=0;s<t.length;s++)for(let n=0;n<e.length;n++)if(t[s].eq(e[n]))return i(e,n),t.splice(s,2,...e),t;return t},t.shift=function(t,e){return t.map((t=>t.add(e)))},t.polygonIntersect=function(t,i){return t.some((t=>e(t,i)))||i.some((i=>e(i,t)))},t.lineInsidePath=function(t,i){return e(t.p1,i,!0)&&e(t.p2,i,!0)},t.pointInsidePath=function(t,i){return e(t,i)},t.toSegments=function(t){return f.segments({regions:[t.map((t=>[t.x,t.y]))],inverted:!1})}}(At||(At={}));class Lt{constructor(t,e){t._x.gt(e._x)&&([t,e]=[e,t]),t._y.gt(e._y)&&([t,e]=[new A(t._x,e._y),new A(e._x,t._y)]),[this.p1,this.p2]=[t,e]}contains(t){return this.p1._x.le(t.p1._x)&&this.p1._y.le(t.p1._y)&&this.p2._x.ge(t.p2._x)&&this.p2._y.ge(t.p2._y)}equals(t){return this.p1.eq(t.p1)&&this.p2.eq(t.p2)}get width(){return this.p2._x.sub(this.p1._x).value}get height(){return this.p2._y.sub(this.p1._y).value}get top(){return this.p2.y}get right(){return this.p2.x}toPolyBoolPath(){return[[this.p1.x,this.p1.y],[this.p1.x,this.p2.y],[this.p2.x,this.p2.y],[this.p2.x,this.p1.y]]}}!function(t){function e(t,e,i){let s=[],n=t.length-1;do{s.push(t[n])}while(!t[n--].eq(e));for(let t of i)At.lineInsidePath(t,s)&&i.delete(t)}function i(t,e,i){return null==e||t.dist.lt(e.dist)||t.dist.eq(e.dist)&&t.angle*i<e.angle*i}function s(t,e,i){var s=t.p2.sub(t.p1),r=new Dt(s._x,i._x,s._y,i._y).inverse;if(null==r)return null;var o=r.multiply(new A(e.sub(t.p1))),h=o._x,l=o._y.neg;return h.lt(w.ZERO)||h.gt(w.ONE)||l.lt(w.ZERO)?null:{point:e.add(i.scale(l)),dist:l,angle:n(i,s),interior:h.gt(w.ZERO)&&h.lt(w.ONE)}}function n(t,e){for(var i=t.angle-e.angle;i<0;)i+=Math.PI;for(;i>Math.PI;)i-=Math.PI;return i}function r(t,e,i,s,r){let o=i.rotate90(),h=t.p1.sub(e),l=t.p2.sub(e),a=h.dot(o),d=l.dot(o),u=h.dot(i),c=l.dot(i);return(a*s>0||d*s>0)&&(u>0||c>0||!!r&&n(i,t.vector)*s>r*s)}t.create=function(t,h,l,a,d,u,c){let p,g,f,y=[],v=[],_=a,m=h,x=new Set,w=new Set(t);o&&console.log([...d].toString());do{p=null;for(let t of w){let e=s(t,m,_);if(e){let s=g?n(_,g):void 0,h=d.has(e.point.toString())?-1:1;if(!e.interior&&!r(t,m,_,h,s))continue;o&&console.log([JSON.stringify(e),t.toString()]),i(e,p,h)&&(p=e,f=t)}}if(p){let t=p.point,i=new jt(m,t);if(c){let t=i.intersection(c);t&&(v.push(t),c=void 0)}let s=i.contains(l)?l:i.intersection(u);if(s){v.push(s);break}let n=t.toString();x.has(n)?t.eq(y[y.length-1])||e(y,t,w):x.add(n),y.length&&y[y.length-1].eq(t)||y.push(t),c||v.length&&v[v.length-1].eq(t)||v.push(t),g=f.vector,_=f.reflect(_),o&&console.log([t.toString(),f.toString(),_.toString(),g.toString()]),m=t,w.delete(f)}}while(null!=p);return v}}($t||($t={}));let Ft=class extends g{constructor(t,e){super(),this._n1=t,this._n2=e}get shouldDispose(){return super.shouldDispose||this._n1.disposed||this._n2.disposed}get lca(){this.disposeEvent();let[t,e]=[this._n1,this._n2];if(t.depth<e.depth&&([t,e]=[e,t]),0==e.depth)return e;for(;t.depth>e.depth;)t=t.parent;if(t==e)return t;let i=t.parent,s=e.parent;return i==s?i:t.tree.pair.get(i,s).lca}get dist(){return this._n1.dist+this._n2.dist-2*this.lca.dist}};var Bt,Wt;t([e],Ft.prototype,"lca",null),Ft=t([e],Ft),function(t){function e(t,e){return{c:ie(t.c),ox:t.ox,oy:t.oy,parent:e}}t.joinOverlaps=function(t,e,i,s,n,r=!1){r&&([t,e]=[e,t],[i,s]=[s,i]);let o=n?0:2,h=((e.ox>t.ox?3:1)+o)%4;return e.c[o]={type:Nt.coincide,e:i,q:o},e.c[h]={type:Nt.intersection,e:t.c[Jt(o)].e},t.c[Jt(h)]={type:Nt.coincide,e:s,q:h},e},t.cut=function(t,i,s,n,r){let o=e(t,i),h=e(t,i);return n>0?(o.c[2]={type:Nt.internal,e:s-1,q:3},o.c[1]={type:Nt.socket,e:s-1,q:0},o.ox=n,h.c[3]={type:Nt.socket,e:s,q:2},h.c[0]={type:Nt.internal,e:s,q:1},h.ox=t.ox-n,h.shift={x:n,y:0}):(o.c[2]={type:Nt.internal,e:s-1,q:1},o.c[3]={type:Nt.socket,e:s-1,q:0},o.oy=r,h.c[1]={type:Nt.socket,e:s,q:2},h.c[0]={type:Nt.internal,e:s,q:3},h.oy=t.oy-r,h.shift={x:0,y:r}),[{overlaps:[o]},{overlaps:[h]}]},t.toOverlap=e}(Bt||(Bt={})),function(t){t.halfIntegral="HALFINTEGRAL",t.universal="UNIVERSAL",t.baseJoin="BASE_JOIN",t.standardJoin="STANDARD_JOIN",t.perfect="PERFECT"}(Wt||(Wt={}));class Vt{constructor(t,e){this.repo=t,this.seed=null==e?void 0:e.configuration,this.seedSignature=JSON.stringify(this.seed),this.pattern=null==e?void 0:e.pattern}*generate(t){if(this.seed&&this.pattern)try{let t=new Y(this.repo,this.seed,this.pattern);if(!t.entry)throw!0;yield t}catch(t){this.seedSignature=void 0,console.log("Incompatible old version.")}yield*Yt.filter(this.search(),(t=>!this.seedSignature||this.seedSignature!=JSON.stringify(t))),t()}*search(){const t=this.repo.structure,e=t=>null!=t.entry;if(1==t.length){let[i]=t;yield*Yt.first([this.searchSingleGadget(i),this.searchDoubleRelay(i,0),this.searchSingleGadget(i,Wt.halfIntegral),this.searchSingleGadget(i,Wt.universal)],e)}if(2==t.length){let i=t;yield*Yt.first([this.searchThreeFlapJoin(i,Wt.perfect),this.searchThreeFlapRelay(i),this.searchThreeFlapJoin(i),this.searchThreeFlapRelayJoin(i),this.searchThreeFlapJoin(i,Wt.baseJoin),this.searchThreeFlapRelayJoin(i,Wt.baseJoin),this.searchThreeFlapJoin(i,Wt.standardJoin),this.searchThreeFlapRelayJoin(i,Wt.standardJoin),this.searchThreeFlapRelay(i,Wt.halfIntegral)],e)}}*searchSingleGadget(t,e){yield new Y(this.repo,{partitions:[{overlaps:[Bt.toOverlap(t,0)],strategy:e}]})}*searchDoubleRelay(t,e){if(!(t.ox*t.oy%2))if(t.ox<t.oy)for(let i=1;i<=t.oy/2;i++){let s=new Y(this.repo,{partitions:Bt.cut(t,e,-1,0,i)});s.entry&&(yield s,yield new Y(this.repo,{partitions:Bt.cut(t,e,-1,0,t.oy-i)}))}else for(let i=1;i<=t.ox/2;i++){let s=new Y(this.repo,{partitions:Bt.cut(t,e,-1,i,0)});s.entry&&(yield s,yield new Y(this.repo,{partitions:Bt.cut(t,e,-1,t.ox-i,0)}))}}*searchThreeFlapRelay(t,e){let[i,s]=t.map(((t,e)=>Bt.toOverlap(t,e))),n=i.c[2].e==s.c[2].e;i.ox>s.ox&&([i,s]=[s,i]);let[r,o]=ie([i,s]);o.ox-=i.ox,r.oy-=s.oy;let[h,l,a,d]=n?[0,1,2,3]:[2,3,0,1];o.c[a]={type:Nt.internal,e:-1,q:d},o.c[l]={type:Nt.intersection,e:i.c[h].e},i.c[d]={type:Nt.socket,e:-2,q:a},r.c[a]={type:Nt.internal,e:-2,q:l},r.c[d]={type:Nt.intersection,e:s.c[h].e},s.c[l]={type:Nt.socket,e:-1,q:a},n||(o.shift={x:i.ox,y:0},r.shift={x:0,y:s.oy}),yield new Y(this.repo,{partitions:[{overlaps:[i],strategy:e},{overlaps:[o],strategy:e}]}),yield new Y(this.repo,{partitions:[{overlaps:[r],strategy:e},{overlaps:[s],strategy:e}]})}*searchThreeFlapJoin(t,e){let[i,s]=t.map(((t,e)=>Bt.toOverlap(t,e)));Bt.joinOverlaps(i,s,-1,-2,i.c[0].e==s.c[0].e),yield new Y(this.repo,{partitions:[{overlaps:[i,s],strategy:e}]})}*searchThreeFlapRelayJoin(t,e){let[i,s]=t.map(((t,e)=>Bt.toOverlap(t,e))),n=i.c[0].e==s.c[0].e,r=s.ox>i.ox,o=(r?i:s).ox,h=(r?s:i).oy;for(let t=1;t<o;t++){let[o,h]=ie([i,s]),l=Bt.joinOverlaps(o,h,-1,-2,n,!r);l.ox-=t,n&&(l.shift={x:t,y:0}),yield new Y(this.repo,{partitions:[{overlaps:[o,h],strategy:e}]})}for(let t=1;t<h;t++){let[o,h]=ie([i,s]),l=Bt.joinOverlaps(o,h,-1,-2,n,r);l.oy-=t,n&&(l.shift={x:0,y:t}),yield new Y(this.repo,{partitions:[{overlaps:[o,h],strategy:e}]})}}}let Ht=class extends et{constructor(t,e,i){var s,n,r;super(t.sheet),this.pattern=t,this.partition=e;let{fx:o,fy:h}=t.stretch;this.gadgets=i.gadgets.map((t=>zt.instantiate(t))),this.addOns=null!==(n=null===(s=i.addOns)||void 0===s?void 0:s.map((t=>v.instantiate(t))))&&void 0!==n?n:[];let l=null!==(r=i.offset)&&void 0!==r?r:0;this.location={x:l*o,y:l*h},this.view=new se(this)}get type(){return"Device"}toJSON(){return{gadgets:this.gadgets.map((t=>t.toJSON())),offset:this.offset,addOns:this.addOns.length?this.addOns:void 0}}get _origin(){return this._originalDisplacement||(this._originalDisplacement=this.partition.getOriginalDisplacement(this.pattern)),this.pattern.stretch.origin.add(this._originalDisplacement)}get shouldDispose(){return super.shouldDispose||this.pattern.disposed}get isActive(){return this.pattern.isActive}get anchors(){let t=[],{fx:e,fy:i}=this.pattern.stretch;for(let s of this.gadgets)t.push(s.anchorMap.map((t=>{if(!t[0])debugger;return t[0].transform(e,i).add(this.delta)})));return t}get delta(){return this._origin.add(new $(this.location)).sub(A.ZERO)}get regions(){let t=[];for(let e of this.gadgets)t.push(...e.pieces);return t.push(...this.addOns),t}get regionRidges(){let t=new Map;for(let e of this.regions){let i=this.regions.filter((t=>t!=e&&t.direction.parallel(e.direction))).reduce(((t,e)=>(t.push(...e.shape.ridges.filter((t=>!t.perpendicular(e.direction)))),t)),[]);t.set(e,jt.subtract(e.shape.ridges,i))}return t}get rawRidges(){let{fx:t,fy:e}=this.pattern.stretch,i=[],s=this.regionRidges;for(let n of this.regions)i.push(...s.get(n).map((i=>i.transform(t,e).shift(this.delta))));return jt.distinct(i)}get ridges(){let t=this.rawRidges,e=this.neighbors.reduce(((t,e)=>(t.push(...e.rawRidges),t)),[]);return jt.subtract(t,e)}get axisParallels(){let{fx:t,fy:e}=this.pattern.stretch,i=[];for(let s of this.regions)for(let n of s.axisParallels)i.push(n.transform(t,e).shift(this.delta));return i}get outerRidges(){if(!this.isActive)return[];let t=this.getConnectionRidges();for(let[e,i]of this.intersectionMap)i&&t.push(new jt(e,i));return jt.distinct(t)}get intersectionMap(){let t=[];if(!this.isActive)return t;for(let[e,i,s]of this.partition.intersectionCorners){let n=this.anchors[i][s],r=this.partition.getSideConnectionTarget(n,e);t.push([n,r])}return t}get openAnchors(){return this.intersectionMap.filter((t=>!t[1]||t[0].eq(t[1]))).map((t=>t[0]))}getConnectionRidges(t=!1){let e=[];for(let[i,s]of this.partition.overlaps.entries())for(let[n,r]of s.c.entries())(r.type==Nt.flap&&!t||r.type==Nt.internal)&&e.push(new jt(this.anchors[i][n],this.pattern.getConnectionTarget(r)));return e}constraint(t,e){let{fx:i,fy:s}=this.pattern.stretch,n=i*s,r=Math.round((t.x+n*t.y)/2);for(let[t,e,i]of this.partition.constraints)r=this.fix(r,t,e,i);return new $(r,n*r)}get neighbors(){let t=new Set;for(let e of this.partition.overlaps)for(let i of e.c)if(i.type==Nt.socket||i.type==Nt.internal){let[e]=this.partition.configuration.overlapMap.get(i.e);t.add(this.pattern.devices[e])}return Array.from(t)}fix(t,e,i,s){let n=e.type!=Nt.socket,r=this.pattern.stretch.fx*(0==(n?s:Jt(e.q))?-1:1),o=this.pattern.getConnectionTarget(e),h=n?this.gadgets[i].slacks[s]:this.pattern.gadgets[-e.e-1].slacks[e.q],l=o.x-this.anchors[i][s].x-h*r;return t*r>l*r&&(t=l),t}get offset(){let t=this.partition.getOriginalDisplacement(this.pattern).x;return t-=this._originalDisplacement.x,(this.location.x-t)*this.pattern.stretch.fx}};t([e],Ht.prototype,"isActive",null),t([e],Ht.prototype,"anchors",null),t([e],Ht.prototype,"delta",null),t([u],Ht.prototype,"regions",null),t([u],Ht.prototype,"regionRidges",null),t([e],Ht.prototype,"rawRidges",null),t([e],Ht.prototype,"ridges",null),t([e],Ht.prototype,"axisParallels",null),t([e],Ht.prototype,"outerRidges",null),t([e],Ht.prototype,"intersectionMap",null),t([e],Ht.prototype,"openAnchors",null),t([e],Ht.prototype,"neighbors",null),Ht=t([e],Ht);class zt{constructor(t){this.pieces=t.pieces.map((t=>y.instantiate(t))),this.offset=t.offset,this.pieces.forEach((t=>t.offset(this.offset))),this.anchors=t.anchors}toJSON(){return ie(this)}get anchorMap(){return Tt((t=>{var e,i;if(null===(i=null===(e=this.anchors)||void 0===e?void 0:e[t])||void 0===i?void 0:i.location){let e=new A(this.anchors[t].location);return this.offset&&e.addBy(new $(this.offset)),[e,null]}if(1==this.pieces.length)return[this.pieces[0].anchors[t],0];for(let[e,i]of this.pieces.entries())if(i.anchors[t])return[i.anchors[t],e];debugger;throw new Error}))}_getSlack(t){var e,i,s;return null!==(s=null===(i=null===(e=this.anchors)||void 0===e?void 0:e[t])||void 0===i?void 0:i.slack)&&void 0!==s?s:0}get slacks(){return Tt((t=>this._getSlack(t)))}get sx(){return Math.ceil(this.anchorMap[2][0].x-this.anchorMap[0][0].x)}get sy(){return Math.ceil(this.anchorMap[2][0].y-this.anchorMap[0][0].y)}reverseGPS(){let t=zt.instantiate(this.toJSON()),[e,i]=t.pieces,s=Math.ceil(Math.max(e.sx,i.sx)),n=Math.ceil(Math.max(e.sy,i.sy));return e.reverse(s,n),i.reverse(s,n),t}addSlack(t,e){var i;return this.anchors=this.anchors||[],this.anchors[t]=this.anchors[t]||{},this.anchors[t].slack=(null!==(i=this.anchors[t].slack)&&void 0!==i?i:0)+e,this}setupConnectionSlack(t,e,i){let s=this.contour,n=t.contour,r=0==e?1:-1,o=new $(r,r),h=new w(this._getSlack(e)),l=t.anchorMap[i][0].sub(A.ZERO).addBy(o.scale(h));s=At.shift(s,0==e?l:l.add(A.ZERO.sub(this.anchorMap[2][0])));let a=0;for(;At.polygonIntersect(s,n);)s=At.shift(s,o),a++;return this.addSlack(e,a),a}get contour(){let t=this.pieces,e=t[0].shape.contour;for(let i=1;i<t.length;i++)e=At.join(e,t[i].shape.contour);return e}rx(t,e){return Math.abs(this.anchorMap[t][0].x-this.anchorMap[e][0].x)}ry(t,e){return Math.abs(this.anchorMap[t][0].y-this.anchorMap[e][0].y)}contains(t){return this.pieces.some((e=>At.pointInsidePath(t,e.shape.contour)))}static instantiate(t){return t instanceof zt?t:new zt(t)}static simplify(t){if(t.offset&&0==t.offset.x&&0==t.offset.y&&delete t.offset,t.anchors){for(let[e,i]of t.anchors.entries())i&&(0===i.slack&&delete i.slack,0==Object.keys(i).length&&delete t.anchors[e]);t.anchors.some((t=>!!t))||delete t.anchors}return t}}t([u],zt.prototype,"anchorMap",null),t([u],zt.prototype,"slacks",null),t([u],zt.prototype,"sx",null),t([u],zt.prototype,"sy",null),t([u],zt.prototype,"contour",null);class Gt{constructor(t,e){let i=[],[s,n]=t;if(s.ox==n.ox||s.oy==n.oy)return;[this.g1,this.g2]=t.map((t=>{let s=e.structure[t.parent];return i.push(s),Array.from(y.gops(t,s.sx))}));let[r,o]=i;this.oriented=r.c[0].e==o.c[0].e,this.cw=s.ox>n.ox,this.q=this.oriented?0:2,[this.q1,this.q2]=this.oriented?this.cw?[2,1]:[1,2]:this.cw?[0,3]:[3,0],this.intDist=b.getMaxIntersectionDistance(e.sheet.design.tree,r,o,this.oriented),[this.s1,this.s2]=this.oriented?[s.shift,n.shift]:[this.getReverseShift(s,r),this.getReverseShift(n,o)]}*join(t,e){let{g1:i,g2:s}=this,n=[];if(i){for(let r of i)for(let i of s){let s=y.instantiate(r,!0),o=y.instantiate(i,!0);e&&!e(s,o)||n.push(...t(new Ut(this,s,o)))}n.sort(((t,e)=>t[1]-e[1]));for(let[t]of n)yield t}}*simpleJoin(t){let{s1:e,s2:i}=this;yield*this.join((t=>t.simpleJoin()),((s,n)=>{let r=s.direction.parallel(n.direction);return!(t==Wt.perfect&&!r)&&(!e&&!i||!r)}))}*baseJoin(){yield*this.join((t=>t.baseJoin()))}*standardJoin(){let{s1:t,s2:e}=this,i=!!t||!!e,s=0;yield*this.join((t=>t.standardJoin()),((t,e)=>i||0==s++))}getReverseShift(t,e){var i,s,n,r;let o=t.ox+(null!==(s=null===(i=t.shift)||void 0===i?void 0:i.x)&&void 0!==s?s:0),h=t.oy+(null!==(r=null===(n=t.shift)||void 0===n?void 0:n.y)&&void 0!==r?r:0);if(o!=e.ox||h!=e.oy)return{x:o-e.ox,y:h-e.oy}}getRelayJoinIntersection(t,e,i){let s=this.oriented?new $(1,1):new $(-1,-1),n=t.anchors[this.q].sub(new $(e));return t.shape.ridges[i].intersection(n,s)}}class Ut{constructor(t,e,i){let{oriented:s,s1:n,s2:r,q1:o,q2:h,q:l}=this.joiner=t,a=[],d=[],u=e.sx+i.sx,c={x:0,y:0},p={x:0,y:0};if(n){let r=t.getRelayJoinIntersection(i,n,(o+2)%4);if(!r||!r.isIntegral)return;s?(e.offset(c=r.toIPoint()),u+=c.x,a[l]={location:{x:-c.x,y:-c.y}}):(i.offset(p={x:i.sx-r.x,y:i.sy-r.y}),u+=p.x,a[l]={location:{x:e.sx+p.x,y:e.sy+p.y}})}if(r){let n=t.getRelayJoinIntersection(e,r,(h+2)%4);if(!n||!n.isIntegral)return;s?(i.offset(p=n.toIPoint()),u+=p.x,d[l]={location:{x:-p.x,y:-p.y}}):(i.offset(p={x:n.x-e.sx,y:n.y-e.sy}),u-=p.x,d[l]={location:{x:i.sx-p.x,y:i.sy-p.y}})}let g,f=$.ZERO;s||(g={x:e.sx-i.sx,y:e.sy-i.sy},f=new $(g));let y=new $(c).neg,v=new $(p).addBy(f).neg,_=n?e.anchors[l]:i.anchors[l].add(f),m=_.add(y).toIPoint(),x=_.add(v).toIPoint(),w=e.shape.ridges[o],b=i.shape.ridges[h].shift(f),S=$.bisector(e.direction,i.direction),M=s?A.ZERO:n?new A(a[l].location):e.anchors[l],q=s?1:-1;this.data={p1:e,p2:i,v1:y,v2:v,a1:a,a2:d,off1:c,off2:p,offset:g,size:u,pt:_,pt1:m,pt2:x,e1:w,e2:b,bv:S,org:M,f:q}}*simpleJoin(){if(!this.data)return;let{e1:t,e2:e,p1:i,p2:s,pt:n,bv:r}=this.data,o=t.intersection(e);o&&(i.direction.parallel(s.direction)||o.sub(n).parallel(r))&&this.setupAnchor(o)&&(this.setupDetour([o],[o]),yield this.result())}get deltaPt(){let{org:t,p1:e,p2:i,f:s}=this.data,{cw:n,intDist:r}=this.joiner;return new A(t.x+(r-(n?i:e).ox)*s,t.y+(r-(n?e:i).oy)*s)}baseJoinIntersections(){let{bv:t,e1:e,e2:i,pt:s}=this.data,n=new jt(this.deltaPt,W.QV[0]),r=new jt(s,t);return{D1:e.intersection(n),D2:i.intersection(n),B1:e.intersection(r),B2:i.intersection(r),delta:n}}*baseJoin(){if(!this.data)return;let{D1:t,D2:e,B1:i,B2:s}=this.baseJoinIntersections();if((null==i?void 0:i.isIntegral)&&(null==e?void 0:e.isIntegral)&&!i.eq(e)){if(!this.setupAnchor(e))return;this.setupDetour([i],[e,i]),yield this.result(!0)}if((null==s?void 0:s.isIntegral)&&(null==t?void 0:t.isIntegral)&&!s.eq(t)){if(!this.setupAnchor(t))return;this.setupDetour([t,s],[s]),yield this.result()}}substituteEnd(t,e){let[i,s]=t.xOrient();return new jt(e,this.joiner.oriented?s:i)}closestGridPoint(t,e){let i,s=Number.POSITIVE_INFINITY;for(let n of t.gridPoints()){let t=n.dist(e);t<s&&(s=t,i=n)}return i}*standardJoin(){if(!this.data)return;let{D1:t,D2:e,B1:i,B2:s,delta:n}=this.baseJoinIntersections(),{f:r}=this.data;i&&e&&!i.eq(e)&&(e.x*r>i.x*r?yield*this.obtuseStandardJoin(i,e,0):yield*this.acuteStandardJoin(i,e,1,n)),s&&t&&!s.eq(t)&&(t.x*r>s.x*r?yield*this.obtuseStandardJoin(s,t,1):yield*this.acuteStandardJoin(s,t,0,n))}*obtuseStandardJoin(t,e,i){if(t.isIntegral)return;let{e1:s,e2:n,p1:r,p2:o,pt:h,f:l}=this.data,{cw:a}=this.joiner,d=[s,n][i],u=[r,o][i];if(a!=r.direction.slope.gt(o.direction.slope))return;if(!this.setupAnchor(e))return;let c=e.sub(t).slope.gt(w.ONE)?d.xIntersection(e.x):d.yIntersection(e.y),p=this.closestGridPoint(this.substituteEnd(d,t),e);if(p.eq(d.p1)||p.eq(d.p2))return;let g=At.triangleTransform([e,c,t],p);g.x*l<h.x*l||(this.data.addOns=[{contour:[e,p,g].map((t=>t.toIPoint())),dir:new jt(p,g).reflect(u.direction).toIPoint()}],this.setupDetour([0==i?p:e,g],[0==i?e:p,g]),yield this.result(!0,g.dist(p)))}*acuteStandardJoin(t,e,i,s){if(e.isIntegral)return;let{e1:n,e2:r,p1:o,p2:h}=this.data,l=[n,r][i],a=[o,h][i],d=this.closestGridPoint(this.substituteEnd(l,e),t);if(d.eq(l.p1)||d.eq(l.p2))return;let u=e.sub(t).slope.gt(w.ONE)?s.yIntersection(d.y):s.xIntersection(d.x),c=At.triangleTransform([d,e,u],t);this.setupAnchor(c)&&(this.data.addOns=[{contour:[t,d,c].map((t=>t.toIPoint())),dir:new jt(d,t).reflect(a.direction).toIPoint()}],this.setupDetour(0==i?[d,t]:[t],0==i?[t]:[d,t]),yield this.result(!0,t.dist(d)))}setupDetour(t,e){let{p1:i,p2:s,v1:n,v2:r,pt1:o,pt2:h}=this.data,l=t.map((t=>t.add(n).toIPoint()));l.push(o);let a=e.map((t=>t.add(r).toIPoint()));a.push(h),(this.joiner.cw?a:l).reverse(),i.clearDetour(),i.addDetour(l),s.clearDetour(),s.addDetour(a)}setupAnchor(t){let{a1:e,a2:i,v1:s,v2:n,f:r}=this.data,{oriented:o,cw:h}=this.joiner;if(t.x*r>this.deltaPt.x*r)return!1;let l=o==h;return e[l?3:1]={location:t.add(s).toIPoint()},i[l?1:3]={location:t.add(n).toIPoint()},!0}result(t=!1,e){let{p1:i,p2:s,a1:n,a2:r,off1:o,off2:h,offset:l,size:a,addOns:d}=this.data;return this.data.addOns=void 0,l&&(h={x:h.x+l.x,y:h.y+l.y}),[{gadgets:[{pieces:[t?i.toJSON():i],offset:this.simplifyIPoint(o),anchors:n.concat()},{pieces:[t?s.toJSON():s],offset:this.simplifyIPoint(h),anchors:r.concat()}],addOns:d},a+10*(null!=e?e:0)]}simplifyIPoint(t){return t&&0==t.x&&0==t.y?void 0:t}}t([u],Ut.prototype,"deltaPt",null);let Kt=class extends z{constructor(t,e,i){super(t.sheet),this.joinerCache=new Map,this.stretch=t,this.signature=e,this.structure=JSON.parse(e),this.generator=new Vt(this,i).generate((()=>this.joinerCache.clear()))}get tag(){return"rp"+this.stretch.signature}builder(t){return t}get shouldDispose(){return super.shouldDispose||this.stretch.disposed}get isActive(){return this.stretch.isActive&&this.stretch.repository==this}onMove(){this.stretch.selected=!this.entry.entry.selected}getJoiner(t){let e=JSON.stringify(t),i=this.joinerCache.get(e);return i||this.joinerCache.set(e,i=new Gt(t,this)),i}};var Zt,Yt,Qt,Xt,te;function ee(t,...e){for(let i of e)if(i instanceof Object){let e=Object.keys(i);for(let s of e){let e=i[s];e instanceof Object?t[s]instanceof Object&&t[s]!=e?t[s]=ee(t[s],e):t[s]=ie(e):t[s]=e}}return t}function ie(t){return ee(t instanceof Array?[]:{},t)}t([e],Kt.prototype,"isActive",null),Kt=t([e],Kt),function(t){t.parse=function(t,s){try{let n=new e(s),{result:r}=new i(n);return r.title=t,r}catch(t){throw"string"==typeof t?new Error(t):new Error("plugin.TreeMaker.invalid")}};class e{constructor(t){this.lines=t.split("\n").values()}get next(){return this.lines.next().value.trim()}get int(){return parseInt(this.next)}get float(){return parseFloat(this.next)}get bool(){return"true"==this.next}skip(t){for(let e=0;e<t;e++)this.lines.next()}skipArray(){this.skip(this.int)}}class i{constructor(t){if(this.result=xt.getSample(),this.set=new Set,this._visitor=t,"tree"!=t.next||"5.0"!=t.next)throw"plugin.TreeMaker.not5";let e=t.float,i=t.float,s=1/t.float;t.skip(11);let n=t.int,r=t.int;t.skip(6);for(let t=0;t<n;t++)this.parseNode();for(let t=0;t<r;t++)this.parseEdge();let o=Xt.LCM(Array.from(this.set)),h=Math.ceil(e*s*o-.25),l=Math.ceil(i*s*o-.25);if(h<8||l<8)throw"plugin.TreeMaker.size8";let a=h/e,d=l/i;for(let t of this.result.layout.flaps)t.x=Math.round(t.x*a),t.y=Math.round(t.y*d);for(let t of this.result.tree.nodes)t.x=Math.round(t.x*a),t.y=Math.round(t.y*d);for(let t of this.result.tree.edges)t.length=Math.max(Math.round(t.length*o),1);let u={width:h,height:l,scale:20};this.result.layout.sheet=u,this.result.tree.sheet=u}parseNode(){let t=this._visitor;if("node"!=t.next)throw new Error;let e={id:t.int,name:t.next,x:t.float,y:t.float};t.skip(2),t.bool&&this.result.layout.flaps.push({id:e.id,x:e.x,y:e.y,height:0,width:0}),this.result.tree.nodes.push(e),t.skip(6),t.skipArray(),t.skipArray(),t.skipArray(),"1"==t.next&&t.next}parseEdge(){let t=this._visitor;if("edge"!=t.next)throw new Error;t.skip(2);let e=t.float;this.set.add(Number(w.toFraction(e,1,0,.1).$denominator)),this.result.tree.edges.push({length:e*(1+t.float),n1:(t.skip(4),t.int),n2:t.int})}}}(Zt||(Zt={})),function(t){t.first=function*(t,e){for(let i of t){let t=!1;for(let s of i)e(s)&&(yield s,t=!0);if(t)return}},t.filter=function*(t,e){for(let i of t)e(i)&&(yield i)}}(Yt||(Yt={})),function(t){let e=new WeakMap;function i(t,e,i,s,n,r){t.justification=0==n?"center":1==n?"left":"right";let o=0==r?-s/5:-1==r?-s/2:0,h=Math.sqrt(n*n+r*r),l=0==h?0:s/2/h;t.point.set(e+n*l,i-r*l-o)}t.setLabel=function(t,s,n,r,...o){if(n.content=s.content,!s.content)return;let h=r.x,l=r.y,a=t.displayScale,d=t.width,u=t.height,c=s.bounds.height,p=h*a,g=-l*a;if(0==h||0==l||h==d||l==u){i(s,p,g,c,0==h?-1:h==d?1:0,0==l?-1:l==u?1:0)}else!function(t,s,n,r,o){let h=[[0,0],[0,-1],[-1,0],[0,1],[1,0],[-1,-1],[-1,1],[1,1],[1,-1]],l=o.map((t=>{let e=t.clone({insert:!1});return t.layer&&e.transform(t.layer.matrix),e})),a=0,d=0;for([a,d]of h){i(t,s,n,r,a,d);let e=new paper.Path.Rectangle(t.bounds);if(t.layer&&e.transform(t.layer.matrix),l.every((t=>{let i=e.intersect(t,{insert:!1}).isEmpty(),s=!e.intersects(t);return i&&s})))break}e.set(t,{dx:a,dy:d,timeout:void 0})}(s,p,g,c,o);!function(t,e){e.point.set(t.point),e.justification=t.justification}(s,n)}}(Qt||(Qt={})),function(t){function e(t,e){if("number"==typeof t&&!Number.isSafeInteger(t))throw new Error("Not a safe integer: "+t);if("number"==typeof e&&!Number.isSafeInteger(e))throw new Error("Not a safe integer: "+e);if(0==t&&0==e)throw new Error("Input cannot be both zero");for(t<0&&(t=-t),e<0&&(e=-e);t&&e;)(t%=e)&&(e%=t);return t||e}t.GCD=e,t.LCM=function(t){let i=t[0];for(let s=1;s<t.length;s++){let n=e(i,t[s]);i=i*t[s]/n}return i},t.reduce=function(t,e){if("number"==typeof t&&!Number.isInteger(t)||"number"==typeof e&&!Number.isInteger(e)){let i=new w(t),s=new w(e);t=Number(i.$numerator*s.$denominator),e=Number(i.$denominator*s.$numerator)}let i=this.GCD(t,e);return[t/i,e/i]},t.int=function(t,e){return e>0?Math.ceil(t):Math.floor(t)}}(Xt||(Xt={})),function(t){let e,i;t.replaceContent=function(t,e,i){t.removeChildren(),e instanceof paper.CompoundPath?t.copyContent(e):(i&&(e=e.clone({insert:!1})),t.addChild(e))},t.setRectangleSize=function(t,e,i){t.segments[1].point.set(e,0),t.segments[2].point.set(e,i),t.segments[3].point.set(0,i)},t.addLine=function(t,e,i){e instanceof A&&(e=e.toPaper()),i instanceof A&&(i=i.toPaper()),t.moveTo(e),t.lineTo(i)},t.setLines=function(e,...i){e.removeChildren();for(let s of i)for(let i of s)t.addLine(e,i.p1,i.p2)},t.unite=function(t,e){return t.isEmpty()?e:t.unite(e,{insert:!1})},t.Black=function(){return e=e||new paper.Color("black")},t.Red=function(){return i=i||new paper.Color("red")},t.fromSegments=function(t){return f.polygon(t).regions.map((t=>new paper.Path({segments:t,closed:!0})))}}(te||(te={}));let se=class extends G{constructor(t){super(t),this.$addItem(Et.axisParallel,this._axisParallels=new paper.CompoundPath(Ot.axisParallel)),this.$addItem(Et.ridge,this._ridges=new paper.CompoundPath(Ot.ridge)),this.$addItem(Et.shade,this._shade=new paper.CompoundPath(Ot.shade))}contains(t){return this._shade.contains(t)}render(){let t=null;for(let e of this.control.regions){let i=this.contourToPath(e.shape.contour);t=t?t.unite(i,{insert:!1}):i}te.replaceContent(this._shade,t,!1),te.setLines(this._ridges,this.control.ridges,this.control.outerRidges),te.setLines(this._axisParallels,this.control.axisParallels)}contourToPath(t){let e=new paper.Path({closed:!0}),{fx:i,fy:s}=this.control.pattern.stretch,n=this.control.delta;return t.forEach((t=>e.add(t.transform(i,s).add(n).toPaper()))),e}renderSelection(t){this._shade.visible=t||this.control.pattern.configuration.repository.stretch.selected}};return se=t([e],se),dt}));