!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.BPStudio=e()}(this,(function(){var t=this&&this.__decorate||function(t,e,i,s){var n,r=arguments.length,o=r<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,s);else for(var h=t.length-1;h>=0;h--)(n=t[h])&&(o=(r<3?n(o):r>3?n(e,i,o):n(e,i))||o);return r>3&&o&&Object.defineProperty(e,i,o),o};if("object"!=typeof Shrewd)throw new Error("BPStudio requires Shrewd.");const{shrewd:e}=Shrewd;const i=!1,s=!1;let n=!1;Shrewd.option.debug=i,Shrewd.option.autoCommit=!1;const r=e;function o(...t){2==t.length||t[0];let i={comparer:(t,e,i)=>{if(t===e)return!0;let s=Shrewd.comparer.array(t,e);return s}};if(2!=t.length)return e(i);e(i)(...t)}function h(...t){2==t.length||t[0];let i={comparer:(t,e,i)=>{if(t===e)return!0;let s=Shrewd.comparer.unorderedArray(t,e);return s}};if(2!=t.length)return e(i);e(i)(...t)}function l(...t){2==t.length||t[0];let i={comparer:(t,e,i)=>{if(t===e)return!0;if(!t!=!e)return!1;if(!t)return!0;let s=v.compare(t,e);return s}};if(2!=t.length)return e(i);e(i)(...t)}function a(t,e,i){if(i)return i.enumerable=!1,i;Object.defineProperty(t,e,{set(t){Object.defineProperty(this,e,{value:t,writable:!0,configurable:!1})},configurable:!0})}function d(...t){if(1==t.length)return(e,i)=>u(e,i,t[0]);u(t[0],t[1],{})}function u(t,i,s){e({validator(t){var e,n;let r=c.get(this);r||c.set(this,r={});let o=null===(n=null===(e=s.validator)||void 0===e?void 0:e.apply(this,[t]))||void 0===n||n;return o&&(i in r&&r[i]!=t&&this.design.history.fieldChange(this,i,r[i],t),r[i]=t),o}})(t,i)}const c=new WeakMap;function p(t,e,i){let s=i.get;return{get(){let t=g.get(this);return t||g.set(this,t={}),e in t?t[e]:t[e]=s.apply(this)},enumerable:!1,configurable:!1}}const g=new WeakMap;class f{get axisParallels(){let t=this.shape.contour.find((t=>t.isIntegral)),e=this.direction,i=e.rotate90().normalize(),s=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY;for(let e of this.shape.contour){let r=e.sub(t).dot(i);r>n&&(n=r),r<s&&(s=r)}let r=[];for(let o=Math.ceil(s);o<=Math.floor(n);o++){let s=t.add(i.scale(new q(o))),n=[];for(let t of this.shape.ridges){let i=t.intersection(s,e);if(i&&!i.eq(n[0])&&n.push(i),2==n.length)break}2==n.length&&r.push(new Wt(...n))}return r}}t([p],f.prototype,"axisParallels",null);let y=class{constructor(t){this._disposed=!1,this._disposeWith=t}disposeEvent(){this._disposed&&(Shrewd.terminate(this),this.onDispose())}get shouldDispose(){return!!this._disposeWith&&this._disposeWith._disposed}dispose(){this._disposed=!0}onDispose(){delete this._disposeWith}get disposed(){return this._disposed}};var v;t([e({renderer(t){return t||this.shouldDispose}})],y.prototype,"_disposed",void 0),t([e],y.prototype,"disposeEvent",null),y=t([e],y),function(t){function e(t,e){return{combined:i(!1).combine(t.segments,t.inverted,e.segments,e.inverted),inverted1:t.inverted,inverted2:e.inverted}}function i(t){function e(t,e,i){return{start:t,end:e,myFill:{above:i.myFill.above,below:i.myFill.below},otherFill:null}}var i=r.create();function n(t,e){i.insertBefore(t,(function(i){return i===t?0:function(t,e,i,n,r,o){var h=s.pointsCompare(e,r);return 0!==h?h:s.pointsSame(i,o)?0:t!==n?t?1:-1:s.pointAboveOrOnLine(i,n?r:o,n?o:r)?1:-1}(t.isStart,t.pt,e,i.isStart,i.pt,i.other.pt)}))}function o(t,e){var i=function(t,e){var i=r.node({isStart:!0,pt:t.start,seg:t,primary:e,other:null,status:null});return n(i,t.end),i}(t,e);return function(t,e,i){var s=r.node({isStart:!1,pt:e.end,seg:e,primary:i,other:t,status:null});t.other=s,n(s,t.pt)}(i,t,e),i}function h(t,i){var s=e(i,t.seg.end,t.seg);return function(t,e){t.other.remove(),t.seg.end=e,t.other.pt=e,n(t.other,t.pt)}(t,i),o(s,t.primary)}function l(e,n){var o=r.create();function l(t){return o.findTransition({ev:t},(function(e){return e.ev===t?0:-(i=t,n=e.ev,r=i.seg.start,o=i.seg.end,h=n.seg.start,l=n.seg.end,s.pointsCollinear(r,h,l)?s.pointsCollinear(o,h,l)||s.pointAboveOrOnLine(o,h,l)?1:-1:s.pointAboveOrOnLine(r,h,l)?1:-1);var i,n,r,o,h,l}))}function a(t,e){var i=t.seg,n=e.seg,r=i.start,o=i.end,l=n.start,a=n.end,d=s.linesIntersect(r,o,l,a);if(!1===d){if(!s.pointsCollinear(r,o,l))return!1;if(s.pointsSame(r,a)||s.pointsSame(o,l))return!1;var u=s.pointsSame(r,l),c=s.pointsSame(o,a);if(u&&c)return e;var p=!u&&s.pointBetween(r,l,a),g=!c&&s.pointBetween(o,l,a);if(u)return g?h(e,o):h(t,a),e;p&&(c||(g?h(e,o):h(t,a)),h(e,r))}else 0===d.alongA&&(-1===d.alongB?h(t,l):0===d.alongB?h(t,d.pt):1===d.alongB&&h(t,a)),0===d.alongB&&(-1===d.alongA?h(e,r):0===d.alongA?h(e,d.pt):1===d.alongA&&h(e,o));return!1}for(var d=[];!i.isEmpty();){var u=i.getHead();if(u.isStart){var c=l(u),p=c.before?c.before.ev:null,g=c.after?c.after.ev:null;function f(){if(p){var t=a(u,p);if(t)return t}return!!g&&a(u,g)}var y,v=f();if(v){var _;if(t)(_=null===u.seg.myFill.below||u.seg.myFill.above!==u.seg.myFill.below)&&(v.seg.myFill.above=!v.seg.myFill.above);else v.seg.otherFill=u.seg.myFill;u.other.remove(),u.remove()}if(i.getHead()!==u)continue;if(t)_=null===u.seg.myFill.below||u.seg.myFill.above!==u.seg.myFill.below,u.seg.myFill.below=g?g.seg.myFill.above:e,u.seg.myFill.above=_?!u.seg.myFill.below:u.seg.myFill.below;else if(null===u.seg.otherFill)y=g?u.primary===g.primary?g.seg.otherFill.above:g.seg.myFill.above:u.primary?n:e,u.seg.otherFill={above:y,below:y};u.other.status=c.insert(r.node({ev:u}))}else{var m=u.status;if(null===m)throw new Error("PolyBool: Zero-length segment detected; your epsilon is probably too small or too large");var x=o.getIndex(m);if(x>0&&x<o.nodes.length-1){var w=o.nodes[x-1],b=o.nodes[x+1];a(w.ev,b.ev)}if(m.remove(),!u.primary){var S=u.seg.myFill;u.seg.myFill=u.seg.otherFill,u.seg.otherFill=S}d.push(u.seg)}i.getHead().remove()}return d}return t?{addRegion:function(t){for(var e,i=t[t.length-1],n=0;n<t.length;n++){e=i,i=t[n];var r=s.pointsCompare(e,i);0!==r&&o({start:r<0?e:i,end:r<0?i:e,myFill:{above:null,below:null},otherFill:null},!0)}},calculate:function(t){return l(t,!1)}}:{combine:function(t,i,s,n){return t.forEach((function(t){o(e(t.start,t.end,t),!0)})),s.forEach((function(t){o(e(t.start,t.end,t),!1)})),l(i,n)}}}let s,n,r;function o(t){var e=[],i=[];return t.forEach((function(t){var n=t.start,r=t.end;if(s.pointsSame(n,r))console.warn("PolyBool: Warning: Zero-length segment detected; your epsilon is probably too small or too large");else{for(var o={index:0,matches_head:!1,matches_pt1:!1},h={index:0,matches_head:!1,matches_pt1:!1},l=o,a=0;a<e.length;a++){var d=(f=e[a])[0],u=(f[1],f[f.length-1]);f[f.length-2];if(s.pointsSame(d,n)){if(S(a,!0,!0))break}else if(s.pointsSame(d,r)){if(S(a,!0,!1))break}else if(s.pointsSame(u,n)){if(S(a,!1,!0))break}else if(s.pointsSame(u,r)&&S(a,!1,!1))break}if(l!==o){if(l===h){var c=o.index,p=o.matches_pt1?r:n,g=o.matches_head,f=e[c],y=g?f[0]:f[f.length-1],v=g?f[1]:f[f.length-2],_=g?f[f.length-1]:f[0],m=g?f[f.length-2]:f[1];return s.pointsCollinear(v,y,p)&&(g?f.shift():f.pop(),y=v),s.pointsSame(_,p)?(e.splice(c,1),s.pointsCollinear(m,_,y)&&(g?f.pop():f.shift()),void i.push(f)):void(g?f.unshift(p):f.push(p))}var x=o.index,w=h.index,b=e[x].length<e[w].length;o.matches_head?h.matches_head?b?(M(x),q(x,w)):(M(w),q(w,x)):q(w,x):h.matches_head?q(x,w):b?(M(x),q(w,x)):(M(w),q(x,w))}else e.push([n,r])}function S(t,e,i){return l.index=t,l.matches_head=e,l.matches_pt1=i,l===o?(l=h,!1):(l=null,!0)}function M(t){e[t].reverse()}function q(t,i){var n=e[t],r=e[i],o=n[n.length-1],h=n[n.length-2],l=r[0],a=r[1];s.pointsCollinear(h,o,l)&&(n.pop(),o=h),s.pointsCollinear(o,l,a)&&r.shift(),e[t]=n.concat(r),e.splice(i,1)}})),i}t.compare=function(t,i){if(!t&&i)return!1;let s=e(t,i);return 0==(r=s,{segments:n.xor(r.combined),inverted:r.inverted1!==r.inverted2}).segments.length;var r},t.union=function(t){let i=t[0];for(let r=1;r<t.length;r++){let o=e(i,t[r]);s=o,i={segments:n.union(s.combined),inverted:s.inverted1||s.inverted2}}var s;return i},t.difference=function(t,i){let s=e(t,i);return r=s,{segments:n.difference(r.combined),inverted:r.inverted1&&!r.inverted2};var r},t.segments=function(t){var e=i(!0);return t.regions.forEach(e.addRegion),{segments:e.calculate(t.inverted),inverted:t.inverted}},t.polygon=function(t){return{regions:o(t.segments),inverted:t.inverted}},function(t){const e=1e-10;function i(t,i){return Math.abs(t[0]-i[0])<e}function s(t,i){return Math.abs(t[1]-i[1])<e}t.pointAboveOrOnLine=function(t,i,s){var n=i[0],r=i[1],o=s[0],h=s[1],l=t[0];return(o-n)*(t[1]-r)-(h-r)*(l-n)>=-e},t.pointBetween=function(t,i,s){var n=t[1]-i[1],r=s[0]-i[0],o=t[0]-i[0],h=s[1]-i[1],l=o*r+n*h;return!(l<e)&&!(l-(r*r+h*h)>-e)},t.pointsSameX=i,t.pointsSameY=s,t.pointsSame=function(t,e){return i(t,e)&&s(t,e)},t.pointsCompare=function(t,e){return i(t,e)?s(t,e)?0:t[1]<e[1]?-1:1:t[0]<e[0]?-1:1},t.pointsCollinear=function(t,i,s){var n=t[0]-i[0],r=t[1]-i[1],o=i[0]-s[0],h=i[1]-s[1];return Math.abs(n*h-o*r)<e},t.linesIntersect=function(t,i,s,n){var r=i[0]-t[0],o=i[1]-t[1],h=n[0]-s[0],l=n[1]-s[1],a=r*l-o*h;if(Math.abs(a)<e)return!1;var d=t[0]-s[0],u=t[1]-s[1],c=(h*u-l*d)/a,p=(r*u-o*d)/a,g={alongA:0,alongB:0,pt:[t[0]+c*r,t[1]+c*o]};return g.alongA=c<=-e?-2:c<e?-1:c-1<=-e?0:c-1<e?1:2,g.alongB=p<=-e?-2:p<e?-1:p-1<=-e?0:p-1<e?1:2,g},t.pointInsideRegion=function(t,i){for(var s=t[0],n=t[1],r=i[i.length-1][0],o=i[i.length-1][1],h=!1,l=0;l<i.length;l++){var a=i[l][0],d=i[l][1];d-n>e!=o-n>e&&(r-a)*(n-d)/(o-d)+a-s>e&&(h=!h),r=a,o=d}return h}}(s||(s={})),function(t){function e(t,e){var i=[];return t.forEach((function(t){var s=(t.myFill.above?8:0)+(t.myFill.below?4:0)+(t.otherFill&&t.otherFill.above?2:0)+(t.otherFill&&t.otherFill.below?1:0);0!==e[s]&&i.push({start:t.start,end:t.end,myFill:{above:1===e[s],below:2===e[s]},otherFill:null})})),i}t.union=function(t){return e(t,[0,2,1,0,2,2,0,0,1,0,1,0,0,0,0,0])},t.difference=function(t){return e(t,[0,0,0,0,2,0,2,0,1,1,0,0,0,1,2,0])},t.xor=function(t){return e(t,[0,2,1,0,2,0,0,1,1,0,0,2,0,1,2,0])}}(n||(n={})),function(t){t.create=function(){var t={nodes:[],exists:function(e){return t.nodes.includes(e)},getIndex:function(e){return t.nodes.indexOf(e)},isEmpty:function(){return 0===t.nodes.length},getHead:function(){return t.nodes[0]},insertBefore:function(e,i){t.findTransition(e,i).insert(e)},findTransition:function(e,i){var s=function(t){return function(e,i,s,n){for(s||(s=0),n||(n=e.length);s<n;){var r=s+n>>>1;t(e[r],i)>0?n=r:s=r+1}return s}}((function(t,e){return i(e)-i(t)}))(t.nodes,e);return{before:0===s?null:t.nodes[s-1],after:t.nodes[s]||null,insert:function(e){return t.nodes.splice(s,0,e),e.remove=function(){t.nodes.splice(t.nodes.indexOf(e),1)},e}}}};return t},t.node=function(t){return t}}(r||(r={}))}(v||(v={}));class _{constructor(t,e){this._design=t,this.tag=e.tag}static restore(t,e){if(e.type==xt.field)return new N(t,e);if(e.type==xt.move)return new O(t,e);if(e.type==xt.add||e.type==xt.remove)return new P(t,e);throw new Error}get signature(){return this.type+":"+this.tag}}t([a],_.prototype,"_design",void 0);class m extends f{constructor(t){super(),oe(this,t)}get _points(){let{ox:t,oy:e,u:i,v:s}=this,n=[H.ZERO,new H(i,t+i),new H(e+i+s,t+i+s),new H(e+s,s)];return n.forEach((t=>t.addBy(this._shift))),n}get _shift(){var t,e,i,s,n,r,o,h;return new V((null!==(e=null===(t=this.shift)||void 0===t?void 0:t.x)&&void 0!==e?e:0)+(null!==(s=null===(i=this._offset)||void 0===i?void 0:i.x)&&void 0!==s?s:0),(null!==(r=null===(n=this.shift)||void 0===n?void 0:n.y)&&void 0!==r?r:0)+(null!==(h=null===(o=this._offset)||void 0===o?void 0:o.y)&&void 0!==h?h:0))}get shape(){let t=this._points.concat(),e=t.map(((t,e,i)=>new Wt(t,i[(e+1)%i.length])));return(this.detours||[]).forEach((i=>{let s=i.map((t=>new H(t.x,t.y).addBy(this._shift))),n=s[0],r=s[s.length-1],o=[];for(let t=0;t<s.length-1;t++)o.push(new Wt(s[t],s[t+1]));let h=e.length;for(let i=0;i<h;i++){let l=e[i].p1.eq(n);if(l||e[i].contains(n)){for(let a=1;a<h;a++){let d=(a+i)%h;if(e[d].p1.eq(r)||e[d].contains(r)){let u=d<i?h-i:a+1,c=a+1-u,p=s.concat();return o.push(new Wt(r,e[d].p2)),l||(p.unshift(e[i].p1),o.unshift(new Wt(e[i].p1,n))),t.splice(i,u,...p),e.splice(i,u,...o),t.splice(0,c),void e.splice(0,c)}}debugger}}})),{contour:t,ridges:e}}get anchors(){let t=this._points,{contour:e}=this.shape;return[e.some((e=>e.eq(t[0])))?t[0]:null,e.includes(t[1])?t[1]:null,e.some((e=>e.eq(t[2])))?t[2]:null,e.includes(t[3])?t[3]:null]}get direction(){let{oy:t,v:e}=this;return new V(t+e,e).doubleAngle().reduceToInt()}get sx(){return this.oy+this.u+this.v}get sy(){return this.ox+this.u+this.v}get rank(){let t=ne.reduce(this.oy+this.v,this.oy)[0],e=ne.reduce(this.ox+this.u,this.ox)[0];return Math.max(t,e)}reverse(t,e){let{shift:i,detours:s,sx:n,sy:r}=this;i=i||{x:0,y:0};let o={x:t-n-i.x,y:e-r-i.y};(o.x||o.y)&&(this.shift=o),null==s||s.forEach((t=>t.forEach((t=>{t.x=n-t.x,t.y=r-t.y}))))}shrink(t=2){return g.delete(this),this.ox/=t,this.oy/=t,this.u/=t,this.v/=t,this}offset(t){!t||this._offset&&this._offset.x==t.x&&this._offset.y==t.y||(this._offset=t,g.delete(this))}addDetour(t){t=he(t);for(let e=0;e<t.length-1;e++)t[e].x==t[e+1].x&&t[e].y==t[e+1].y&&t.splice(e--,1);1!=t.length&&(this.detours=this.detours||[],this.detours.push(t),g.delete(this))}clearDetour(){var t;(null===(t=this.detours)||void 0===t?void 0:t.length)&&(this.detours=void 0,g.delete(this))}toJSON(){return he(this)}static*gops(t,e){let{ox:i,oy:s}=t;if([i,s].some((t=>!Number.isSafeInteger(t))))return;if(i%2&&s%2)return;void 0===e&&(e=Number.POSITIVE_INFINITY);let n=i*s/2;for(let t,r=Math.floor(Math.sqrt(n));r>0&&r+(t=n/r)+s<=e;r--)if(n%r==0&&(r==t&&(yield{ox:i,oy:s,u:r,v:t}),r!=t)){let e=new m({ox:i,oy:s,u:r,v:t}),n=new m({ox:i,oy:s,u:t,v:r});e.rank>n.rank?(yield n,yield e):(yield e,yield n)}}static instantiate(t,e=!1){return t instanceof m&&!e?t:new m(t)}}t([p],m.prototype,"_points",null),t([a],m.prototype,"_offset",void 0),t([p],m.prototype,"_shift",null),t([p],m.prototype,"shape",null),t([p],m.prototype,"anchors",null),t([p],m.prototype,"direction",null),t([p],m.prototype,"rank",null);class x extends f{constructor(t){super(),this.contour=t.contour,this.dir=t.dir}get shape(){let t=this.contour.map((t=>new H(t))),e=t.map(((t,e,i)=>new Wt(t,i[(e+1)%i.length])));return{contour:t,ridges:e}}get direction(){return new V(this.dir).reduceToInt()}static instantiate(t){return t instanceof x?t:new x(t)}}t([p],x.prototype,"shape",null),t([p],x.prototype,"direction",null);let w=class{constructor(){this._map=new Map,this._size=0}set(t,e,i){return this.has(t,e)||(this._map.has(t)||this._map.set(t,new Map),this._map.has(e)||this._map.set(e,new Map),this._size++),this._map.get(t).set(e,i),this._map.get(e).set(t,i),this}get[Symbol.toStringTag](){return"DoubleMap"}has(...t){return this._size,1==t.length?this._map.has(t[0]):this._map.has(t[0])&&this._map.get(t[0]).has(t[1])}get(...t){return this._size,1==t.length?this._map.get(t[0]):this.has(t[0],t[1])?this._map.get(t[0]).get(t[1]):void 0}get size(){return this._size}clear(){this._map.clear(),this._size=0}forEach(t,e){e||(e=this);for(let[i,s,n]of this.entries())t.apply(e,[n,i,s,this])}delete(...t){if(1==t.length){if(!this._map.has(t[0]))return!1;this._size-=this._map.get(t[0]).size,this._map.delete(t[0]);for(let e of this._map.values())e.delete(t[0]);return!0}return!!this.has(t[0],t[1])&&(this._map.get(t[0]).delete(t[1]),this._map.get(t[1]).delete(t[0]),this._size--,!0)}[Symbol.iterator](){return this.entries()}*entries(){for(let[t,e]of this.keys())yield[t,e,this.get(t,e)]}*keys(){this._size;let t=new Map;for(let e of this._map.keys()){t.set(e,new Set);for(let i of this._map.get(e).keys())t.has(i)&&t.get(i).has(e)||(t.get(e).add(i),yield[e,i])}}firstKeys(){return this._size,this._map.keys()}*values(){for(let[t,e]of this.keys())yield this.get(t,e)}};t([e],w.prototype,"_size",void 0),w=t([e],w);class b{constructor(t,e,i,s){this.source=t,this.keyGen=e,this.ctor=i,this.dtor=s,this._map=new Map}dispose(){Shrewd.terminate(this),this._map.clear(),delete this._map}render(){for(let[t,e]of this._map)this.dtor(t,e)&&this._map.delete(t);for(let t of this.source()){let e=this.keyGen(t);this._map.has(e)||this._map.set(e,this.ctor(t))}return new Map(this._map)}get(t){return this.render().get(t)}has(t){return this.render().has(t)}forEach(t,e){return this.render().forEach(t,e)}get size(){return this.render().size}[Symbol.iterator](){return this.render()[Symbol.iterator]()}entries(){return this.render().entries()}keys(){return this.render().keys()}values(){return this.render().values()}toJSON(){return Array.from(this.values()).map((t=>t.toJSON()))}}t([e],b.prototype,"render",null);let S=class{constructor(t,e){this._source=t,this._constructor=e,this._map=new w}dispose(){Shrewd.terminate(this),Shrewd.terminate(this._map)}has(...t){return this._map.has.apply(this._map,t)}get(...t){return this._map.get.apply(this._map,t)}get size(){return this._map.size}forEach(t,e){return this._map.forEach(t,e)}[Symbol.iterator](){return this._map[Symbol.iterator]()}entries(){return this._map.entries()}keys(){return this._map.keys()}firstKeys(){return this._map.firstKeys()}values(){return this._map.values()}};t([e({renderer(t){for(let e of t.firstKeys())e.disposed&&t.delete(e);let e=Array.from(this._source());e.length>1&&0==t.size&&t.set(e[0],e[1],this._constructor(e[0],e[1]));for(let i of e)if(!t.has(i)){let e=Array.from(t.firstKeys());for(let s of e)t.set(i,s,this._constructor(i,s))}return t}})],S.prototype,"_map",void 0),S=t([e],S);const M=67108863;class q{constructor(t,e=1){if(t instanceof q)this._p=t._p,this._q=t._q*e,this._check();else{if("number"!=typeof t||"number"!=typeof e){debugger;throw new Error("Parameters are not valid")}if(Number.isSafeInteger(t)&&Number.isSafeInteger(e))this._p=t,this._q=e,this._check();else{if(!Number.isFinite(t/e)){debugger;throw new Error("Parameters are not valid")}if(Number.isSafeInteger(Math.floor(t/e)))return q.toFraction(t/e);this._p=t,this._q=e}}}static toFraction(t,e=1,i=0,s=q.ERROR){let n=Math.floor(t),r=t-n,o=n*i+e,h=new q(n);return r/o/((1-r)*o+i)<s?h:q.toFraction(1/r,i,o).i().a(h)}get $numerator(){return this._p}get $denominator(){return this._q}get value(){return this._p/this._q}toString(){return this._smp(),this._p+(this._q>1?"/"+this._q:"")}c(){return new q(this._p,this._q)}_smp(){[this._p,this._q]=ne.reduce(this._p,this._q)}n(){return this._p=-this._p,this}i(){return[this._p,this._q]=[this._q,this._p],this._check()}r(){return this._p=Math.round(this.value),this._q=1,this}a(t){return this._p=this._p*t._q+this._q*t._p,this._q*=t._q,this._check()}s(t){return this._p=this._p*t._q-this._q*t._p,this._q*=t._q,this._check()}m(t){return this._p*=t._p,this._q*=t._q,this._check()}d(t){return this._p*=t._q,this._q*=t._p,this._check()}f(t){return this._p*=t,this}get isIntegral(){return this._smp(),1==this._q}_check(){return this.$isDangerous&&this._smp(),this._q<0?(this._q=-this._q,this._p=-this._p):0==this._q&&(this._p=1),this}get $isDangerous(){return Math.abs(this._p)>M||Math.abs(this._q)>M}get neg(){return this.c().n()}get inv(){return this.c().i()}add(t){return this.c().a(t)}sub(t){return this.c().s(t)}mul(t){return this.c().m(t)}fac(t){return this.c().f(t)}div(t){return this.c().d(t)}eq(t){return this._p*t._q==this._q*t._p}lt(t){return this._p*t._q<this._q*t._p}gt(t){return this._p*t._q>this._q*t._p}le(t){return this._p*t._q<=this._q*t._p}ge(t){return this._p*t._q>=this._q*t._p}reduceWith(t){this._smp(),t._smp();let[e,i]=ne.reduce(this._p,t._p),[s,n]=ne.reduce(this._q,t._q);return[new q(e,s),new q(i,n)]}reduceToIntWith(t){this._smp(),t._smp();let[e,i]=ne.reduce(this._p*t._q,this._q*t._p);return[new q(e),new q(i)]}toJSON(){return this.toString()}}q.ZERO=new q(0),q.ONE=new q(1),q.TWO=new q(2),q.ERROR=1e-12;class I extends y{constructor(t,e){super(t),this.configuration=t,this.overlaps=e.overlaps,this.strategy=e.strategy}static getMaxIntersectionDistance(t,e,i,s){let n=s?2:0,r=t.node.get(e.c[n].e),o=t.node.get(i.c[n].e),h=t.node.get(e.c[2-n].e);return t.distTriple(r,o,h).d3}*generate(){let{strategy:t}=this;if(1==this.overlaps.length){let e=this.overlaps[0],i=this.configuration.repository.structure[e.parent];if(t==Gt.halfIntegral)for(let t of this.halfKamiya(e,i.sx))yield{gadgets:[t]};if(t==Gt.universal)for(let t of this.universalGPS(e,i.sx))yield{gadgets:[t]};else for(let t of m.gops(e,i.sx))yield{gadgets:[{pieces:[t]}]}}if(2==this.overlaps.length){let e=this.configuration.repository.getJoiner(this.overlaps);t==Gt.baseJoin?yield*e.baseJoin():t==Gt.standardJoin?yield*e.standardJoin():yield*e.simpleJoin(t)}}*universalGPS(t,e){let i=2,s=!1;for(;!s;){let n=he(t);n.ox*=i,n.oy*=i;for(let t of m.gops(n,e*i)){let e=m.instantiate(t).shrink(i);if(!Number.isInteger(e.v))continue;let{ox:n,oy:r,u:o,v:h}=e,l={ox:n,oy:r,u:h,v:o},a={x:0,y:0},d={x:r+o+h,y:n+o+h};e.detours=[[a,d]],l.detours=[[d,a]];let u=e.oy+e.u+e.v,c=Math.ceil(u)-u,p=new Yt({pieces:[e,l]}),g=p.reverseGPS();yield p.addSlack(2,c),yield g.addSlack(0,c),s=!0}i+=2}}*halfKamiya(t,e){if(t.ox%2==0||t.oy%2==0)return;let i=he(t);i.ox<<=1,i.oy<<=1;for(let t of m.gops(i,2*e)){let e=m.instantiate(t);if(e.rank>3)continue;let i=e.v%2==0;if(e.ox==e.oy&&i)continue;let{ox:s,oy:n,u:r,v:o}=e.shrink(2),h=Math.abs(s-n)/2;if(!Number.isInteger(h))debugger;let l,a=Math.min(s,n);if(i&&s>=n)e.detours=[[{x:h,y:3*h},{x:n+r+o,y:s+r+o}]],l={ox:a,oy:a,u:o,v:r-h,detours:[[{x:a+r+o-h,y:a+r+o-h},{x:0,y:0}]],shift:{x:h,y:3*h}};else{if(i||!(n>=s))continue;e.detours=[[{x:n+r+o,y:s+r+o},{x:3*h,y:h}]],l={ox:a,oy:a,u:o-h,v:r,detours:[[{x:0,y:0},{x:a+r+o-h,y:a+r+o-h}]],shift:{x:3*h,y:h}}}let d=new Yt({pieces:[e,l]}),u=d.reverseGPS();yield d.addSlack(2,.5),yield u.addSlack(0,.5)}}}let C=class extends y{constructor(t,e){super(t),this.view=t,this.flap=e,this.quadrants=$t((t=>new E(this,t)))}get shouldDispose(){return super.shouldDispose||this.flap.disposed}onDispose(){delete this.flap}get distance(){return 0}get segment(){this.disposeEvent();let t=[];return this.quadrants.forEach((e=>t.push(...e.contour))),zt.toSegments(t)}};t([r],C.prototype,"segment",null),C=t([e],C);let E=class extends y{constructor(t,e){super(t),this.parent=t,this.quadrant=t.flap.quadrants[e]}get overridden(){this.disposeEvent();let t=[],e=this.parent.distance,{qv:i,fx:s,fy:n,point:r,coveredInfo:o,pattern:h}=this.quadrant;if(!h){let h=new q(this.parent.flap.radius+e),l=r.add(i.scale(h));for(let[e,i,r]of o){for(let t of r){let r=l.sub(t);e=Math.min(r.x*s,e),i=Math.min(r.y*n,i)}if(e<=0||i<=0)continue;let o=new V(e*s,i*n),h=new Ut(l,l.sub(o)).toPolyBoolPath(),a=v.segments({regions:[h],inverted:!1});t.push(a)}}return t.length?v.union(t):null}get contour(){return this.disposeEvent(),this.quadrant.makeContour(this.parent.distance)}};t([l("qo")],E.prototype,"overridden",null),t([function(...t){2==t.length||t[0];let i={comparer:(t,e,i)=>{if(i.ov=t,t===e)return!0;if(!t!=!e)return!1;if(!t)return!0;if(t.length!=e.length)return!1;for(let i=0;i<t.length;i++)if(!t[i].eq(e[i]))return!1;return!0}};if(2!=t.length)return e(i);e(i)(...t)}("qc")],E.prototype,"contour",null),E=t([e],E);class N extends _{constructor(t,e){super(t,e),this.type=xt.field,this.prop=e.prop,this.old=e.old,this.new=e.new}static create(t,e,i,s){let n=new N(t.design,{tag:t.tag,prop:e,old:i,new:s});t.design.history.queue(n)}canAddTo(t){return t instanceof N&&t.tag==this.tag&&t.new==this.old}addTo(t){t.new=this.new}get isVoid(){return this.old==this.new}undo(){this._design.query(this.tag)[this.prop]=this.old}redo(){this._design.query(this.tag)[this.prop]=this.new}}class O extends _{constructor(t,e){super(t,e),this.type=xt.move,this.old=e.old,this.new=e.new}static create(t,e,i=!0){i&&(e.x+=t.location.x,e.y+=t.location.y);let s=new O(t.design,{tag:t.tag,old:he(t.location),new:e});O.assign(t.location,e),t.design.history.queue(s)}static assign(t,e){t.x=e.x,t.y=e.y}canAddTo(t){return t instanceof O&&t.tag==this.tag&&t.new.x==this.old.x&&t.new.y==this.old.y}addTo(t){O.assign(t.new,this.new)}get isVoid(){return this.old.x==this.new.x&&this.old.y==this.new.y}undo(){let t=this._design.query(this.tag);if(!t.location)debugger;O.assign(t.location,this.old)}redo(){let t=this._design.query(this.tag);if(!t.location)debugger;O.assign(t.location,this.new)}}class P extends _{constructor(t,e){super(t,e),this.type=e.type,this.memento=e.memento}static add(t){let e=new P(t.design,{type:xt.add,tag:t.tag,memento:t.toJSON()});return t instanceof B?t.tree.node.set(t.id,t):t.tree.edge.set(t.n1,t.n2,t),t.design.history.queue(e),t}static remove(t){let e=new P(t.design,{type:xt.remove,tag:t.tag,memento:t.toJSON()});t.dispose(!0),t.design.history.queue(e)}canAddTo(t){return!1}addTo(t){}get isVoid(){return!1}_remove(){this._design.query(this.tag).dispose(!0)}_add(){let t=this._design.tree;if(this.tag.startsWith("e")){let e=this.memento,i=t.getOrAddNode(e.n1),s=t.getOrAddNode(e.n2);t.edge.set(i,s,new z(i,s,e.length))}else{let e=this.memento;t.getOrAddNode(e.id).parentId=e.parentId}}undo(){this.type==xt.add?this._remove():this._add()}redo(){this.type==xt.add?this._add():this._remove()}}let T=class extends b{constructor(t,e){super(t,(t=>t),e,((t,e)=>e.disposed))}};T=t([e],T);let k=class extends b{constructor(t,e,i){super(t,e,i,((t,e)=>e.disposed))}};k=t([e],k);class D extends y{constructor(t){super(),this._oldStudio=null,this.mountTarget=t}get shouldDispose(){return super.shouldDispose||this.mountTarget instanceof D&&this.mountTarget.disposed}get $studio(){return this.disposed||!this.isActive?null:this.mountTarget instanceof D?this.mountTarget.$studio:this.mountTarget}mountEvents(){this.disposeEvent(),this.$studio!==this._oldStudio&&(this.$studio&&this.onMount(this.$studio),this._oldStudio&&this.onDismount(this._oldStudio),this._oldStudio=this.$studio)}onDispose(){this._oldStudio&&this.onDismount(this._oldStudio),super.onDispose()}get isActive(){return!0}static isActive(t){return t.isActive}onMount(t){}onDismount(t){}}t([e],D.prototype,"$studio",null),t([e],D.prototype,"mountEvents",null);let R=class extends y{constructor(t,e){for(super(t),this.node=new Map,this.edge=new w,this.nextId=0,this._jid=!1,this.design=t;null==e?void 0:e.length;){let t=[],i=!1;for(let s of e)this.addEdge(s.n1,s.n2,s.length)?i=!0:t.push(s);if(!i)break;e=t}}onDispose(){Shrewd.terminate(this.edge)}get leaf(){let t=new Set;for(let e of this.node.values())1==e.degree&&t.add(e);return t}withJID(t){let e=Array.from(this.node.values()).sort(((t,e)=>t.id-e.id)),i=0;for(let t of e)B.setJID(t,i++);this._jid=!0,t(),this._jid=!1}get jid(){return this._jid}dist(t,e){return this.disposeEvent(),t==e?0:t.dist+e.dist-2*this.lca(t,e).dist}lca(t,e){let i=t.path,s=e.path,n=i[0],r=1;for(;r<i.length&&r<s.length&&i[r]==s[r];)n=i[r++];return n}find(t){let[e,i]=t.split(",").map((t=>this.node.get(Number(t))));if(e&&i)return this.edge.get(e,i)}getOrAddNode(t){let e;return this.node.has(t)?e=this.node.get(t):(P.add(e=new B(this,t)),t>=this.nextId&&(this.nextId=t+1)),e}split(t){let e=this.getOrAddNode(this.nextId),{n1:i,n2:s}=t;return i.parent==s&&([i,s]=[s,i]),e.parentId=i.id,s.parentId=e.id,P.add(new z(e,i,Math.ceil(t.length/2))),P.add(new z(e,s,Math.max(Math.floor(t.length/2),1))),P.remove(t),e}deleteAndMerge(t){var e;let i=this.getOrAddNode(this.nextId),{n1:s,n2:n,a1:r,a2:o}=t;s.parent==n&&([s,n]=[n,s],[r,o]=[o,r]),i.parentId=null===(e=s.parent)||void 0===e?void 0:e.id,P.remove(t);for(let t of r){let e=t.n(s);e!=i.parent&&(e.parentId=i.id),P.remove(t),P.add(new z(i,e,t.length))}for(let t of o){let e=t.n(n);e.parentId=i.id,P.remove(t),P.add(new z(i,e,t.length))}return P.remove(s),P.remove(n),i}deleteAndJoin(t){let e=t.edges;if(2!=e.length)return void console.warn(`Incorrectly calling delete-and-join at [${t.id}].`);let i=e[0],s=e[1],n=i.n(t),r=s.n(t);t.parent==r&&([n,r]=[r,n]),r.parentId=n.id;let o=P.add(new z(n,r,i.length+s.length));return P.remove(i),P.remove(s),P.remove(t),o}addLeafAt(t,e){let i=this.nextId;return this.addEdge(t,i,e),this.node.get(i)}addEdge(t,e,i){let s=this.node.has(t),n=this.node.has(e);if(0!=this.node.size&&!s&&!n)return console.warn(`Adding edge (${t},${e}) disconnects the graph.`),null;let r=this.getOrAddNode(t),o=this.getOrAddNode(e);return this.edge.has(r,o)?(this.edge.get(r,o).length=i,null):s&&n?(console.warn(`Adding edge (${t},${e}) will cause circuit.`),null):(s?o.parentId=t:n?r.parentId=e:o.parentId=t,P.add(new z(r,o,i)))}distTriple(t,e,i){let s=this.dist(t,e),n=this.dist(t,i),r=this.dist(e,i),o=(s+n+r)/2;return{d1:o-r,d2:o-n,d3:o-s}}};t([e({renderer(t){for(let[e,i]of t)i.disposed&&t.delete(e);return t}})],R.prototype,"node",void 0),t([e({renderer(t){for(let e of t.firstKeys())e.disposed&&t.delete(e);return t}})],R.prototype,"edge",void 0),t([e],R.prototype,"leaf",null),R=t([e],R);class J{constructor(...t){1==t.length&&(t=[t[0]._x,t[0]._y]),this._x=new q(t[0]),this._y=new q(t[1])}get x(){return this._x.value}set x(t){this._x=new q(t)}get y(){return this._y.value}set y(t){this._y=new q(t)}eq(t){return!!t&&(this._x.eq(t._x)&&this._y.eq(t._y))}clone(){return new this.constructor(this._x,this._y)}toString(){return"("+this._x+", "+this._y+")"}toJSON(){return this.toString()}set(t,e=0){return t instanceof J?(this._x=t._x.c(),this._y=t._y.c()):(this._x=new q(t),this._y=new q(e)),this}add(t){return new this.constructor(this._x.add(t._x),this._y.add(t._y))}addBy(t){return this._x.a(t._x),this._y.a(t._y),this}round(t=1){let e=new q(t);return this._x.d(e).r().m(e),this._y.d(e).r().m(e),this}range(t,e,i,s){return this._x.lt(t)&&(this._x=t),this._x.gt(e)&&(this._x=e),this._y.lt(i)&&(this._y=i),this._y.gt(s)&&(this._y=s),this}toIPoint(){return{x:this.x,y:this.y}}}let j=class extends I{constructor(t,e){super(t,e),this.cornerMap=[];for(let[t,i]of e.overlaps.entries())for(let[e,s]of i.c.entries())this.cornerMap.push([s,t,e])}get intersectionCorners(){return this.cornerMap.filter((t=>{let e=t[0].type;return e==Rt.side||e==Rt.intersection}))}get outCorners(){return this.intersectionCorners.concat(this.cornerMap.filter((t=>t[0].type==Rt.flap)))}get constraints(){return this.cornerMap.filter((t=>{let e=t[0].type;return e==Rt.socket||e==Rt.internal||e==Rt.flap}))}getOriginalDisplacement(t){let e=this.overlaps.find((t=>t.c[0].type!=Rt.coincide));return t.getConnectionTarget(e.c[0]).sub(this.configuration.repository.stretch.origin)}get _sideConnectionTarget(){this.disposeEvent();let t=new Map,e=this.configuration.sheet.design.flapsById;for(let[i,s,n]of this.intersectionCorners){let r=this.overlaps[s],o=this.getParent(r);if(!r||!o)debugger;let[h,l]=[o.c[0],o.c[2]],[a,d]=[e.get(h.e),e.get(l.e)];if(!a||!d)debugger;let u=a.quadrants[h.q],c=0,p=d.quadrants[l.q],g=0;if(i.type==Rt.intersection){let t=r.c[0].e<0,e=this.configuration.sheet.design.tree,s=e.node.get(i.e),n=e.distTriple(a.node,d.node,s);if(t?g=n.d2-d.radius:c=n.d1-a.radius,isNaN(c)||isNaN(g))debugger}r=this.getExposedOverlap(r);let f=u.getOverlapCorner(r,o,n,c),y=p.getOverlapCorner(r,o,Ft(n),g);t.set(i,[f,y])}return t}getExposedOverlap(t){var e;if(1==this.overlaps.length)return t;let i=he(t),s=this.getParent(t);i.shift=null!==(e=i.shift)&&void 0!==e?e:{x:0,y:0};for(let e of this.overlaps)if(e!=t){let t=this.getParent(e),n=i.ox+i.shift.x,r=i.oy+i.shift.y;t.c[0].e==s.c[0].e&&(t.ox<s.ox&&(i.ox=n-(i.shift.x=Math.max(i.shift.x,t.ox))),t.oy<s.oy&&(i.oy=r-(i.shift.y=Math.max(i.shift.y,t.oy)))),t.c[2].e==s.c[2].e&&(t.ox<s.ox&&(i.ox=s.ox-Math.max(t.ox,s.ox-n)-i.shift.x),t.oy<s.oy&&(i.oy=s.oy-Math.max(t.oy,s.oy-r)-i.shift.y))}return i}getParent(t){return this.configuration.repository.structure[t.parent]}getSideConnectionTarget(t,e,i){let[s,n]=this._sideConnectionTarget.get(e);return s._x.gt(n._x)&&([s,n]=[n,s]),void 0===i?t._x.le(s._x)?s:t._x.ge(n._x)?n:null:0==i||3==i?s:n}toJSON(){let t={overlaps:this.overlaps,strategy:this.strategy},e=this.configuration.design.tree;if(e.jid){t.overlaps=he(t.overlaps);for(let i of t.overlaps)for(let t of i.c)void 0!==t.e&&t.e>=0&&(t.e=e.node.get(t.e).id)}return t}};t([p],j.prototype,"intersectionCorners",null),t([p],j.prototype,"outCorners",null),t([p],j.prototype,"constraints",null),t([e],j.prototype,"_sideConnectionTarget",null),j=t([e],j);let A=class extends C{constructor(t,e){super(t,t.design.flapsById.get(e[0])),this.node=t.design.tree.node.get(e[1]),this.key=e[0]+","+e[1]}get shouldDispose(){return super.shouldDispose||!this.view.info.components.some((t=>t==this.key))}onDispose(){super.onDispose(),delete this.node}get distance(){this.disposeEvent();let{design:t,info:e}=this.view,i=this.flap;return t.tree.dist(i.node,this.node)-i.radius+e.length}get contour(){this.disposeEvent();let t=this.segment;for(let e of this.quadrants)e.overridden&&(t=v.difference(t,e.overridden));return t}};t([e],A.prototype,"distance",null),t([e({comparer:(t,e,i)=>(i.ov=t,!1)})],A.prototype,"contour",null),A=t([e],A);class $ extends D{constructor(t,e){if(super(t),this.id=$._id++,this.dragging=!1,this.edges=new T((()=>this.tree.edge.values()),(t=>new wt(this.TreeSheet,this.vertices.get(t.n1),this.vertices.get(t.n2),t))),this.rivers=new T((()=>[...this.tree.edge.values()].filter((t=>t.isRiver))),(t=>new Mt(this.LayoutSheet,t))),this.vertices=new T((()=>this.tree.node.values()),(t=>new yt(this.TreeSheet,t))),this.flaps=new T((()=>this.tree.leaf),(t=>new gt(this.LayoutSheet,t))),this.stretches=new T((()=>this.teams.keys()),(t=>new Y(this.LayoutSheet,t))),this.data=oe(It.getSample(),e),this.data.tree.nodes.length<3)throw new Error("Invalid format.");this.options=new Nt(this.data)}sortJEdge(){let t=this.edges.toJSON(),e=new Set,i=[];for(;t.length;){let s=t.shift();0==e.size||e.has(s.n1)?(i.push(s),e.add(s.n1),e.add(s.n2)):t.push(s)}return i}get isActive(){return this instanceof G&&this.mountTarget.design==this}get patternNotFound(){return[...this.stretches.values()].some((t=>t.isTotallyValid&&null==t.pattern))}onDispose(){this.edges.dispose(),this.vertices.dispose(),this.rivers.dispose(),this.flaps.dispose(),this.stretches.dispose(),this.junctions.dispose()}get allJunctions(){return Array.from(this.junctions.values())}get validJunctions(){return this.allJunctions.filter((t=>t.isValid))}get activeJunctions(){return this.validJunctions.filter((t=>!t.isCovered))}get teams(){let t,e=new Set(this.activeJunctions),i=new Map;function s(i){if(e.has(i)){t.push(i),e.delete(i);for(let t of i.neighbors)s(t)}}for(;e.size>0;)t=[],s(e.values().next().value),t.sort(St.sort),i.set(St.createTeamId(t),t);return i}get devices(){let t=[];for(let e of this.stretches.values())t.push(...e.devices);return t}get stretchByQuadrant(){let t=new Map;for(let e of this.stretches.values())if(e.isActive)for(let i of e.junctions)t.set(i.q1,e),t.set(i.q2,e);return t}getStretchByQuadrant(t){var e;return null!==(e=this.stretchByQuadrant.get(t))&&void 0!==e?e:null}get flapsById(){let t=new Map;for(let e of this.flaps.values())t.set(e.node.id,e);return t}get openAnchors(){let t=new Map;for(let e of this.activeStretches){let i=e.fx*e.fy;for(let s of e.pattern.devices)for(let e of s.openAnchors){let s=i+","+(e.x-i*e.y),n=t.get(s);n||t.set(s,n=[]),n.push(e)}}return t}get activeStretches(){return[...this.stretches.values()].filter((t=>t.isActive&&!!t.pattern))}}$._id=0,t([e],$.prototype,"dragging",void 0),t([e],$.prototype,"isActive",null),t([e],$.prototype,"patternNotFound",null),t([h("allJ")],$.prototype,"allJunctions",null),t([o("vj")],$.prototype,"validJunctions",null),t([o("aj")],$.prototype,"activeJunctions",null),t([e],$.prototype,"teams",null),t([e],$.prototype,"devices",null),t([e],$.prototype,"stretchByQuadrant",null),t([e],$.prototype,"flapsById",null),t([e],$.prototype,"openAnchors",null),t([e],$.prototype,"activeStretches",null);class L extends D{constructor(t){super(t),this.sheet=t}get design(){return this.sheet.design}}let F=class extends D{constructor(t,e,i,...s){var n,r;super(t),this._activeControlCache=[],this._independentRect=new Ut(H.ZERO,H.ZERO),this.margin=0,this.tag=e,this.width=i.width,this.height=i.height,this.mZoom=null!==(n=i.zoom)&&void 0!==n?n:100,this.scroll=null!==(r=i.scroll)&&void 0!==r?r:{x:0,y:0},this._controlMaps=s,this.view=new it(this)}get controls(){let t=[];for(let e of this._controlMaps)t.push(...e());return t}get activeControls(){return this.design.dragging||(this._activeControlCache=this.controls.filter((t=>D.isActive(t)))),this._activeControlCache}constraint(t,e){return t.range(new q(-e.x),new q(this.width-e.x),new q(-e.y),new q(this.height-e.y))}get width(){return this.mWidth}set width(t){if(t>=8&&t>=this._independentRect.width){let e=t-this._independentRect.right;if(e<0)for(let t of this.independents)O.create(t,{x:e,y:0});this.mWidth=t}}get height(){return this.mHeight}set height(t){if(t>=8&&t>=this._independentRect.height){let e=t-this._independentRect.top;if(e<0)for(let t of this.independents)O.create(t,{x:0,y:e});this.mHeight=t}}get zoom(){return this.mZoom}set zoom(t){var e;t<100||null===(e=this.$studio)||void 0===e||e.$display.zoom(t,this)}get design(){return this.mountTarget}get isActive(){return this.design.sheet==this}get displayScale(){return this.$studio?this.$studio.$display.scale:1}toJSON(t=!1){let e={width:this.width,height:this.height};return t&&(e.zoom=this.zoom,e.scroll=this.scroll),e}get size(){return Math.max(this.width,this.height)}contains(t){return 0<=t.x&&t.x<=this.width&&0<=t.y&&t.y<=this.height}get independents(){return this.controls.filter((t=>t instanceof at))}_getIndependentRect(){let t=Number.POSITIVE_INFINITY,e=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,s=Number.NEGATIVE_INFINITY;for(let n of this.independents){let r=n.location;r.x<t&&(t=r.x),r.x+n.width>i&&(i=r.x+n.width),r.y<e&&(e=r.y),r.y+n.height>s&&(s=r.y+n.height)}this._independentRect=new Ut(new H(t,e),new H(i,s))}get viewedControls(){return this.controls.filter((t=>t instanceof st&&t.view instanceof rt))}getMargin(){if(!this.isActive||!this.design.isActive)return;let t=this.viewedControls,e=t.length?Math.max(...t.map((t=>t.view.overflow))):0;setTimeout((()=>this.margin=e),0)}};t([h],F.prototype,"controls",null),t([e],F.prototype,"activeControls",null),t([d],F.prototype,"mWidth",void 0),t([d],F.prototype,"mHeight",void 0),t([e],F.prototype,"mZoom",void 0),t([e],F.prototype,"isActive",null),t([e],F.prototype,"displayScale",null),t([e],F.prototype,"size",null),t([h],F.prototype,"independents",null),t([e],F.prototype,"_getIndependentRect",null),t([h],F.prototype,"viewedControls",null),t([e],F.prototype,"margin",void 0),t([e],F.prototype,"getMargin",null),t([e],F.prototype,"scroll",void 0),F=t([e],F);class W extends D{constructor(){super(...arguments),this._paths=[],this._scale=1}draw(){this.mountEvents(),this.$studio&&this.render()}$addItem(t,e){this._paths.push([t,e,e.strokeWidth])}onMount(t){for(let[e,i]of this._paths)t.$display.project.layers[e].addChild(i)}onDismount(t){for(let[t,e]of this._paths)e.remove()}contains(t){return!1}get scale(){if(this.mountEvents(),!this.$studio)return this._scale;let t=this.$studio.$display.scale;return this._scale=t<10?t/10:1}renderScale(){for(let[t,e,i]of this._paths)e.strokeWidth=i*this.scale}}t([e],W.prototype,"draw",null),t([e],W.prototype,"scale",null),t([e],W.prototype,"renderScale",null);let B=class extends y{constructor(t,e){super(t),this.name="",this.tree=t,this._id=e}static setJID(t,e){t._jid=e}get tag(){return"n"+this.id}get id(){return this.tree.jid?this._jid:this._id}delete(){let t=this.edges[0];P.remove(t),void 0===this.parentId&&(t.n(this).parentId=void 0),P.remove(this)}get parent(){return void 0!==this.parentId?this.tree.node.get(this.parentId):null}get parentEdge(){var t;return this.parent&&null!==(t=this.tree.edge.get(this,this.parent))&&void 0!==t?t:null}get dist(){return this.parentEdge?this.parentEdge.length+this.parent.dist:0}get path(){return this.parent?this.parent.path.concat(this):[this]}get shouldDispose(){return super.shouldDispose||this.tree.disposed}dispose(t=!1){if(t||1==this.degree)super.dispose();else{if(2==this.degree)return this.tree.deleteAndJoin(this);1!=this.degree&&console.warn(`Node [${this.name?this.name:this.id}] is not a leaf.`)}}addLeaf(t){return this.tree.addLeafAt(this.id,t)}get design(){return this.tree.design}get edges(){this.disposeEvent();let t=this.tree.edge.get(this);return t?Array.from(t.values()):[]}get degree(){return this.edges.length}get leafEdge(){return 1==this.degree?this.edges[0]:null}get radius(){var t,e;return null!==(e=null===(t=this.leafEdge)||void 0===t?void 0:t.length)&&void 0!==e?e:NaN}toJSON(){return{id:this.id,parentId:this.parentId}}};t([d],B.prototype,"name",void 0),t([d],B.prototype,"parentId",void 0),t([e],B.prototype,"parent",null),t([e],B.prototype,"parentEdge",null),t([e],B.prototype,"dist",null),t([e],B.prototype,"path",null),t([e],B.prototype,"edges",null),t([e],B.prototype,"degree",null),t([e],B.prototype,"leafEdge",null),t([e],B.prototype,"radius",null),B=t([e],B);let z=class extends y{constructor(t,e,i){super(),this._n1=t,this._n2=e,this.length=i}get tag(){return"e"+this._n1.id+","+this._n2.id}dispose(t=!1){t&&this.design.tree.edge.delete(this._n1,this._n2),super.dispose()}toJSON(){let[t,e]=[this._n1,this._n2];return t.parentId==e.id&&([t,e]=[e,t]),{n1:t.id,n2:e.id,length:this.length}}get tree(){return this.n1.tree}get design(){return this.n1.design}get shouldDispose(){return super.shouldDispose||this._n1.disposed||this._n2.disposed}delete(){1==this._n1.degree&&this._n1.dispose(),1==this._n2.degree&&this._n2.dispose()}get isRiver(){return this.disposeEvent(),this._n1.degree>1&&this._n2.degree>1}adjacentEdges(t){return t.edges.filter((t=>t!=this))}get a1(){return this.disposeEvent(),this.adjacentEdges(this._n1)}get a2(){return this.disposeEvent(),this.adjacentEdges(this._n2)}group(t,e){let i=[t];for(let s of e)i.push(...s.g(t));return i}get g1(){return this.disposeEvent(),this.group(this._n1,this.a1)}get g2(){return this.disposeEvent(),this.group(this._n2,this.a2)}g(t){return t==this._n1?this.g2:this.g1}get l1(){return this.disposeEvent(),this.g1.filter((t=>1==t.degree))}get l2(){return this.disposeEvent(),this.g2.filter((t=>1==t.degree))}get t1(){return this.disposeEvent(),this.a1.map((t=>t.t(this._n1)+t.length)).reduce(((t,e)=>t+e),0)}get t2(){return this.disposeEvent(),this.a2.map((t=>t.t(this._n2)+t.length)).reduce(((t,e)=>t+e),0)}t(t){return t==this._n1?this.t2:this.t1}get p1(){return this.disposeEvent(),Math.max(...this.l1.map((t=>t.tree.dist(t,this.n1))))}get p2(){return this.disposeEvent(),Math.max(...this.l2.map((t=>t.tree.dist(t,this.n2))))}get wrapSide(){return this.disposeEvent(),this.isRiver?this.p1>this.p2?2:this.p1<this.p2?1:this.t1>this.t2?2:this.t1<this.t2||this.g1.length>this.g2.length?1:this.g1.length<this.g2.length?2:0:0}get n1(){return this._n1}get n2(){return this._n2}n(t){return t==this._n1?this._n2:this._n1}};t([d({validator:t=>t>0})],z.prototype,"length",void 0),t([e],z.prototype,"isRiver",null),t([e],z.prototype,"a1",null),t([e],z.prototype,"a2",null),t([e],z.prototype,"g1",null),t([e],z.prototype,"g2",null),t([e],z.prototype,"l1",null),t([e],z.prototype,"l2",null),t([e],z.prototype,"t1",null),t([e],z.prototype,"t2",null),t([e],z.prototype,"p1",null),t([e],z.prototype,"p2",null),t([e],z.prototype,"wrapSide",null),z=t([e],z);class H extends J{static get ZERO(){return new H(0,0)}constructor(...t){1==t.length?super(t[0].x,t[0].y):super(...t)}dist(t){return this.sub(t).length}paramDist(t){return Math.max(Math.abs(t.x-this.x),Math.abs(t.y-this.y))}sub(t){return t instanceof V?new H(this._x.sub(t._x),this._y.sub(t._y)):t instanceof H?new V(this._x.sub(t._x),this._y.sub(t._y)):new V(this._x.sub(new q(t.x)),this._y.sub(new q(t.y)))}subBy(t){return this._x.s(t._x),this._y.s(t._y),this}toPaper(){return new paper.Point(this.x,this.y)}eq(t){return t instanceof H||!t?super.eq(t):this.x==t.x&&this.y==t.y}get isIntegral(){return this._x.isIntegral&&this._y.isIntegral}transform(t,e){return new H(this._x.fac(t),this._y.fac(e))}}class V extends J{static get ZERO(){return new V(0,0)}constructor(...t){1==t.length?super(t[0].x,t[0].y):super(...t)}get length(){return Math.sqrt(this.dot(this))}get slope(){return this._y.div(this._x)}rotate90(){return new V(this._y.neg,this._x)}normalize(){return this.scale(new q(this.length).inv)}scale(t,e){return t instanceof J?this.scale(t._x,t._y):(e||(e=t),new V(this._x.mul(t),this._y.mul(e)))}dot(t){return this._x.mul(t._x).a(this._y.mul(t._y)).value}get neg(){return new V(this._x.neg,this._y.neg)}get angle(){return Math.atan2(this.y,this.x)}reduce(){return new V(...this._x.reduceWith(this._y))}reduceToInt(){return new V(...this._x.reduceToIntWith(this._y))}doubleAngle(){let{_x:t,_y:e}=this.reduce();return new V(t.mul(t).s(e.mul(e)),q.TWO.mul(t).m(e))}parallel(t){return this._x.mul(t._y).eq(this._y.mul(t._x))}static bisector(t,e){let[i,s]=ne.reduce(t.x,t.y),[n,r]=ne.reduce(e.x,e.y),o=Math.sqrt(i*i+s*s),h=Math.sqrt(n*n+r*r);return new V(i*h+n*o,s*h+r*o)}}let G=class extends ${constructor(t,e){super(t,e),this.design=this,this.tag="design",this.LayoutSheet=new F(this,"layout",this.data.layout.sheet,(()=>this.flaps.values()),(()=>this.rivers.values()),(()=>this.stretches.values()),(()=>this.devices)),this.TreeSheet=new F(this,"tree",this.data.tree.sheet,(()=>this.edges.values()),(()=>this.vertices.values())),this.title=this.data.title,this.description=this.data.description,this.mode=this.data.mode,this.history=new _t(this,this.data.history),this.tree=new R(this,this.data.tree.edges),this.junctions=new S((()=>this.flaps.values()),((t,e)=>new St(this.LayoutSheet,t,e)))}get sheet(){return"layout"==this.mode?this.LayoutSheet:this.TreeSheet}get display(){return this.mountTarget.$display}toJSON(t=!1){let e,i=()=>{e={title:this.title,description:this.description,version:It.current,mode:this.mode,layout:{sheet:this.LayoutSheet.toJSON(t),flaps:this.flaps.toJSON(),stretches:this.stretches.toJSON()},tree:{sheet:this.TreeSheet.toJSON(t),nodes:this.vertices.toJSON(),edges:this.sortJEdge()}},t&&(e.history=this.history.toJSON())};return t?i():this.tree.withJID(i),e}deleteVertices(t){let e=t.concat().sort(((t,e)=>t.node.degree-e.node.degree));for(;this.vertices.size>3;){let t=e.find((t=>1==t.node.degree));if(!t)break;t.node.delete(),e.splice(e.indexOf(t),1)}}deleteFlaps(t){for(let e of t){if(3==this.vertices.size)break;e.node.delete()}}clearLayoutSelection(){for(let t of this.LayoutSheet.controls)t.selected=!1}clearTreeSelection(){for(let t of this.TreeSheet.controls)t.selected=!1}flapToVertex(t){this.clearTreeSelection();for(let e of t){let t=this.vertices.get(e.node);t&&(t.selected=!0)}this.mode="tree"}vertexToFlap(t){this.clearLayoutSelection();for(let e of t){let t=this.flaps.get(e.node);t&&(t.selected=!0)}this.mode="layout"}riverToEdge(t){this.clearTreeSelection();let e=this.edges.get(t.edge);e&&(e.selected=!0),this.mode="tree"}edgeToRiver(t){this.clearLayoutSelection();let e=t.edge;if(e.isRiver){let t=this.rivers.get(e);t&&(t.selected=!0)}else{let t=1==e.n1.degree?e.n1:e.n2,i=this.flaps.get(t);i&&(i.selected=!0)}this.mode="layout"}selectAll(){var t;null===(t=this.$studio)||void 0===t||t.system.$clearSelection(),"layout"==this.mode&&this.flaps.forEach((t=>t.selected=!0)),"tree"==this.mode&&this.vertices.forEach((t=>t.selected=!0))}query(t){var e;if("design"==t)return this;if("layout"==t)return this.LayoutSheet;if("tree"==t)return this.TreeSheet;let i=t.match(/^([a-z]+)(\d+(?:,\d+)*)(?:\.(.+))?$/);if(i){let t=i[1],s=i[2],n=i[3];if("s"==t)return this.stretches.get(s);if("r"==t)return null===(e=this.stretches.get(s).repository)||void 0===e?void 0:e.query(n);let r=this.tree;if("e"==t||"re"==t||"ee"==t){let e=r.find(s);if(!e)return;if("e"==t)return e;if("re"==t)return this.rivers.get(e);if("ee"==t)return this.edges.get(e)}let o=r.node.get(Number(s));if("n"==t)return o;if("f"==t)return this.flaps.get(o);if("v"==t)return this.vertices.get(o)}}restoreSelection(t){"layout"==this.mode?this.clearLayoutSelection():this.clearTreeSelection();for(let e of t){let t=this.query(e);t instanceof U&&(t.selected=!0)}}};t([e],G.prototype,"mode",void 0),t([d],G.prototype,"description",void 0),t([d],G.prototype,"title",void 0),t([e],G.prototype,"sheet",null),G=t([e],G);class U extends L{constructor(){super(...arguments),this.selected=!1}selectableWith(t){return!1}get dragSelectAnchor(){return null}toggle(){this.selected=!this.selected}contains(t){return!1}static isDragSelectable(t){return null!=t.dragSelectAnchor}}var Z;t([e],U.prototype,"selected",void 0);let K=Z=class extends L{constructor(t,e,i){super(t),this.flap=e,this.q=i,this.qv=Z.QV[i],this.sv=Z.SV[i],this.pv=Z.SV[(i+1)%4],this.fx=0==this.q||3==this.q?1:-1,this.fy=0==this.q||1==this.q?1:-1}get shouldDispose(){return super.shouldDispose||this.flap.disposed}getOverlapCorner(t,e,i,s){var n,r,o,h;let l=this.flap.radius+s,a=null!==(r=null===(n=t.shift)||void 0===n?void 0:n.x)&&void 0!==r?r:0,d=null!==(h=null===(o=t.shift)||void 0===o?void 0:o.y)&&void 0!==h?h:0;return this.flap.node.id!=e.c[0].e&&(a=e.ox-(t.ox+a),d=e.oy-(t.oy+d)),new H(this.x(l-(3==i?0:t.ox)-a),this.y(l-(1==i?0:t.oy)-d))}makeContour(t){let e,i=this.flap.radius+t,n=new q(i),r=this.getStart(n),o=this.pattern;if(o){let t=this.sv.scale(n),h=this.point.add(t.rotate90()),l=o.linesForTracing[this.q].concat();s;let a,d=o.stretch.junctions,u=this.findNextDelta(d,!1),c=new Set,p=this.findLead(d,i,l,c),g=p?this.findNextDelta(d,!0):void 0;for(e=Ht.create(l,null!=p?p:r,h,this.pv,c,null!=u?u:new Wt(h,this.pv),g);this.isInvalidHead(e[0],i,this.q%2!=1);)e.shift();if(g&&this.outside(e[0],i,this.q%2!=1))e.unshift(this.q%2?g.yIntersection(this.y(i)):g.xIntersection(this.x(i)));else{let t;for(;(t=e.length)>1&&new Wt(r,e[1]).lineContains(e[0]);)e.shift();e.unshift(r)}if(u){this.outside(e[e.length-1],i,this.q%2==1)&&e.push(this.q%2?u.xIntersection(this.x(i)):u.yIntersection(this.y(i)));let t=e[e.length-1],s=this.q%2?new H(t._x,h._y):new H(h._x,t._y);s.eq(h)||e.push(s)}for(;(a=e.length)>1&&new Wt(h,e[a-2]).contains(e[a-1]);)e.pop()}else e=[r,this.point.add(this.qv.scale(n))];return e}isInvalidHead(t,e,i){if(!t)return!1;let s=this.flap.quadrants[(this.q+3)%4];return(i?(t.y-this.point.y)*this.fy<0&&t.x==this.x(e):(t.x-this.point.x)*this.fx<0&&t.y==this.y(e))&&s.outside(t,e,!i)}outside(t,e,i){return!!t&&(i?t.x*this.fx>this.x(e)*this.fx:t.y*this.fy>this.y(e)*this.fy)}getStart(t){return this.point.add(this.sv.scale(t))}y(t){return this.point.y+this.fy*t}x(t){return this.point.x+this.fx*t}findNextDelta(t,e){let i=this.findJoinNextQ(t,e,!0);if(!i)return;let{joinQ:s,nextQ:n,mode:r}=i,{d1:o,d2:h}=this.design.tree.distTriple(this.flap.node,n.flap.node,s.flap.node),l=r?new H(n.x(h),this.y(o)):new H(this.x(o),n.y(h));return new Wt(l,this.qv)}findJoinNextQ(t,e,i){if(1==t.length)return;let s,n=!!(this.q%2)==e,r=n?"oy":"ox",o=St.findMinMax(t.filter((t=>t.q1==this||t.q2==this)),r,-1),h=o.q1==this?o.q2:o.q1;if(1!=h.activeJunctions.length){if(i){let t=h.activeJunctions.concat().sort(((t,e)=>t[r]-e[r]));if(s=t[t.indexOf(o)+1],!s)return}else if(s=St.findMinMax(h.activeJunctions,r,1),s==o)return;return{joinQ:h,nextQ:s.q1==h?s.q2:s.q1,mode:n}}}findLead(t,e,i,s){var n;let r=this.findJoinNextQ(t,!0,!1);if(!r)return;let{joinQ:o,nextQ:h}=r,l=this.design.junctions.get(this.flap,h.flap).status==bt.tooFar,a=this.design.tree.distTriple(this.flap.node,h.flap.node,o.flap.node);if(e<=a.d1&&l)return;let d=e-a.d1+a.d2,u=this.q%2?new H(h.x(d),this.y(e)):new H(this.x(e),h.y(d));if(s.add(u.toString()),0==d&&s.add(h.point.toString()),e<a.d1){let t=i.findIndex((t=>t.contains(u)));t>=0?i.splice(t,1):i.push(new Wt(u,this.qv))}return null!==(n=h.findLead(t,d,i,s))&&void 0!==n?n:h.getStart(new q(d))}get pattern(){let t=this.design.getStretchByQuadrant(this);return t?t.pattern:null}get corner(){this.disposeEvent();let t=new q(this.flap.radius);return this.point.add(this.qv.scale(t))}get validJunctions(){return this.flap.validJunctions.filter((t=>t.q1==this||t.q2==this))}get coveredJunctions(){return this.validJunctions.filter((t=>t.isCovered))}get coveredInfo(){return this.coveredJunctions.map((t=>[t.ox,t.oy,t.coveredBy.map((t=>t.q1.q==this.q?t.q1.point:t.q2.point))]))}get point(){return this.flap.points[this.q]}get activeJunctions(){return this.validJunctions.filter((t=>!t.isCovered))}static transform(t,e,i){return e<0&&(t+=t%2?3:1),i<0&&(t+=t%2?1:3),t%4}getBaseRectangle(t,e){let i=this.design.tree.dist(e,this.flap.node),s=this.flap.radius,n=this.qv.scale(new q(i-s));return new Ut(new H(this.x(s),this.y(s)).addBy(n),new H(this.x(s-t.ox),this.y(s-t.oy)).addBy(n))}debug(t=0){n=!0,console.log(this.makeContour(t).map((t=>t.toString()))),n=!1}};K.QV=[new V(1,1),new V(-1,1),new V(-1,-1),new V(1,-1)],K.SV=[new V(1,0),new V(0,1),new V(-1,0),new V(0,-1)],t([e],K.prototype,"pattern",null),t([e],K.prototype,"corner",null),t([o("qvj")],K.prototype,"validJunctions",null),t([o("qcj")],K.prototype,"coveredJunctions",null),t([r],K.prototype,"coveredInfo",null),t([e],K.prototype,"point",null),t([o("qaj")],K.prototype,"activeJunctions",null),K=Z=t([e],K);let Y=class extends U{constructor(t,e){super(t),this._repoCache=new Map,this.signature=e}get type(){return"Stretch"}get tag(){return"s"+this.signature}get junctions(){var t;let e=null!==(t=this.design.teams.get(this.signature))&&void 0!==t?t:[];if(this.junctionCache&&this.junctionCache.length==e.length){for(let t in e)if(e[t]!=this.junctionCache[t])return this.junctionCache=e;return this.junctionCache}return this.junctionCache=e}get flaps(){let t=new Set;for(let e of this.junctions)t.add(e.f1),t.add(e.f2);return Array.from(t)}get origin(){var t,e,i;return null!==(i=null===(e=null===(t=this.junctions[0])||void 0===t?void 0:t.q1)||void 0===e?void 0:e.point)&&void 0!==i?i:H.ZERO}get repository(){if(!this.isValid)return null;let t,e=this.structureSignature;if(this._repoCache.has(e))t=this._repoCache.get(e);else{let i=this.design.options.get(this);t=new te(this,e,i)}return this.design.dragging||this._repoCache.clear(),this._repoCache.set(e,t),t}get fx(){var t,e;return null!==(e=null===(t=this.junctions[0])||void 0===t?void 0:t.fx)&&void 0!==e?e:1}get fy(){var t,e;return null!==(e=null===(t=this.junctions[0])||void 0===t?void 0:t.fy)&&void 0!==e?e:1}get shouldDispose(){return super.shouldDispose||!this.isActive&&!this.design.dragging}get isActive(){return this.design.teams.has(this.signature)}get pattern(){var t,e,i;return null!==(i=null===(e=null===(t=this.repository)||void 0===t?void 0:t.entry)||void 0===e?void 0:e.entry)&&void 0!==i?i:null}get isValid(){return this.junctions.every((t=>t.status==bt.overlap))}get isTotallyValid(){if(!this.isActive)return!1;for(let t=0;t<this.flaps.length;t++)for(let e=t+1;e<this.flaps.length;e++){if(this.design.junctions.get(this.flaps[t],this.flaps[e]).status==bt.tooClose)return!1}return!0}get structureSignature(){return this.isValid?JSON.stringify(this.junctions.map((t=>{let e=t.toJSON(),i=e.c;return t.fx!=this.fx&&(e.c=[i[2],i[3],i[0],i[1]]),e}))):""}get devices(){return this.pattern?this.pattern.devices:[]}toJSON(){var t,e,i,s;return{id:St.createTeamId(this.junctions),configuration:null!==(e=null===(t=this.pattern)||void 0===t?void 0:t.configuration.toJSON())&&void 0!==e?e:void 0,pattern:null!==(s=null===(i=this.pattern)||void 0===i?void 0:i.toJSON())&&void 0!==s?s:void 0}}};t([e],Y.prototype,"junctions",null),t([e],Y.prototype,"flaps",null),t([e],Y.prototype,"repository",null),t([e],Y.prototype,"isActive",null),t([e],Y.prototype,"pattern",null),t([e],Y.prototype,"isValid",null),t([e],Y.prototype,"isTotallyValid",null),t([e],Y.prototype,"structureSignature",null),Y=t([e],Y);let Q=class extends L{constructor(t,e){super(t.sheet),this._lineCache=$t((t=>[])),this.configuration=t,this.devices=e.devices.map(((e,i)=>new Kt(this,t.partitions[i],e))),this.gadgets=this.devices.reduce(((t,e)=>t.concat(e.gadgets)),[]),this.signature=JSON.stringify(e)}get tag(){return this.configuration.tag+"."+this.configuration.indexOf(this)}query(t){return t?this.devices[Number(t)]:this}static getSignature(t){let e=t.devices;t.devices=t.devices.map((t=>((t=he(t)).gadgets.forEach((t=>Yt.simplify(t))),t.offset=void 0,t)));let i=JSON.stringify(t);return t.devices=e,i}get shouldDispose(){return super.shouldDispose||this.configuration.disposed}get isActive(){return this.configuration.isActive&&this.configuration.entry==this}get linesForTracing(){if(!this.isActive)return this._lineCache;let t=this.configuration.repository.stretch.junctions[0].direction,{fx:e,fy:i}=this.stretch,s=new q(this.design.LayoutSheet.size);return this._lineCache=$t((n=>{let r=[];if(t%2!=n%2)return r;for(let t of this.devices){let o=K.QV[n].scale(s);r.push(...t.ridges),r.push(...t.getConnectionRidges(!0));for(let[s,h,l]of t.partition.outCorners){let a=t.anchors[h][l];if(s.type==Rt.side||s.type==Rt.flap&&n!=K.transform(l,e,i)||s.type==Rt.internal&&n!=K.transform(s.q,e,i))r.push(new Wt(a,a.add(o)));else if(s.type==Rt.intersection){let e=t.partition.overlaps[h].c.find((t=>t.type==Rt.flap)).q;if(e!=n)r.push(new Wt(a,a.add(o)));else{let i=t.partition.getSideConnectionTarget(a,s,e);i&&!i.eq(a)&&r.push(new Wt(a,i))}}else r.push(new Wt(a,this.getConnectionTarget(s)))}}return Wt.distinct(r)}))}toJSON(){return{devices:this.devices.map((t=>t.toJSON()))}}get selected(){return this.devices.some((t=>t.selected))}get stretch(){return this.configuration.repository.stretch}getConnectionTarget(t){if(t.e>=0)return this.design.flapsById.get(t.e).points[t.q];{let[e,i]=this.configuration.overlapMap.get(t.e);return this.devices[e].anchors[i][t.q]}}};t([e],Q.prototype,"isActive",null),t([e],Q.prototype,"linesForTracing",null),Q=t([e],Q);class X extends L{constructor(){super(...arguments),this.index=0,this._cache=[],this._entries=[]}query(t){var e;if(!t)return this;let i=t.match(/^(\d+)(?:\.(.+))?$/);if(i){let t=Number(i[1]),s=i[2];return null===(e=this.get(t))||void 0===e?void 0:e.query(s)}}get _prototypes(){if(!this.generator)return this._cache;if(this.design.dragging)return this.buildFirst(),this._cache.concat();0==this._entries.length&&this.buildFirst();for(let t of this.generator)this._cache.push(t);return delete this.generator,this._cache}restore(t,e){this._cache=t,this.index=e}buildFirst(){let t=this.generator.next();if(!t.done)try{this._entries[0]=this.builder(t.value),this._cache.push(t.value)}catch(t){console.log("Incompatible old version.")}}get memento(){let t=[];for(let e=0;e<this._prototypes.length;e++)t.push(this._entries[e]||this._cache[e]);return t}get entry(){let t=this._prototypes,e=this.index;return 0==t.length?null:this._entries[e]=this._entries[e]||this.builder(t[e])}move(t=1){let e=this.index,i=this._prototypes.length;this.index=(this.index+t+i)%i,this.onMove(this.index,e)}get size(){return this._prototypes.length}indexOf(t){return this._entries.indexOf(t)}get(t){return this._entries[t]}}t([d],X.prototype,"index",void 0),t([e],X.prototype,"_prototypes",null),t([e],X.prototype,"entry",null);class tt extends W{constructor(t){super(t),this.control=t}drawSelection(){this.mountEvents(),this.$studio&&this.renderSelection(this.control.selected)}}t([e],tt.prototype,"drawSelection",null);let et=class extends W{constructor(t){super(t),this.visible=!1,this.$addItem(Dt.drag,this._rectangle=new paper.Path.Rectangle(jt.selection))}contains(t){return this._rectangle.contains(t)}render(){if(this._rectangle.visible=this.visible){let t=new paper.Path.Rectangle({from:this.down,to:this.now});this._rectangle.set({segments:t.segments})}}};t([e],et.prototype,"visible",void 0),t([e],et.prototype,"down",void 0),t([e],et.prototype,"now",void 0),et=t([e],et);let it=class extends W{constructor(t){super(t),this._sheet=t,this._border=new paper.Path.Rectangle({point:[0,0],size:[0,0],strokeWidth:3}),this.$addItem(Dt.sheet,this._border),this._grid=new paper.CompoundPath(jt.sheet),this.$addItem(Dt.sheet,this._grid)}contains(t){return this._border.contains(t)}render(){let t=this._sheet.width,e=this._sheet.height;re.setRectangleSize(this._border,t,e),this._grid.visible=this.$studio.$display.settings.showGrid,this._grid.removeChildren();for(let i=1;i<e;i++)re.addLine(this._grid,new paper.Point(0,i),new paper.Point(t,i));for(let i=1;i<t;i++)re.addLine(this._grid,new paper.Point(i,0),new paper.Point(i,e))}};it=t([e],it);class st extends U{contains(t){return this.view.draw(),this.view.contains(t)}}let nt=class extends X{constructor(t,e,i){super(t.sheet),this._initMemento=!0,this.repository=t,this.seed=i,i&&(this.seedSignature=Q.getSignature(i));let s=[],n=new Map,r=-1;for(let[t,i]of e.partitions.entries())for(let[e,o]of i.overlaps.entries())s.push(o),n.set(r--,[t,e]);this.overlaps=s,this.overlapMap=n,this.partitions=e.partitions.map((t=>new j(this,t))),e.patterns?this.restore(e.patterns,e.index):this.generator=this.generate()}get tag(){return this.repository.tag+"."+this.repository.indexOf(this)}get shouldDispose(){return super.shouldDispose||this.repository.disposed}get isActive(){return this.repository.isActive&&this.repository.entry==this}builder(t){return new Q(this,t)}*generate(){this.seed&&(yield this.seed);yield*ie.filter(this.search([]),(t=>!this.seedSignature||this.seedSignature!=Q.getSignature(t)))}*search(t,e=0){if(e==this.partitions.length){let e=this.makePattern(he(t));e&&(yield e)}else for(let i of this.partitions[e].generate())t.push(i),yield*this.search(t,e+1),t.pop()}makePattern(t){t.forEach((t=>t.gadgets=t.gadgets.map((t=>Yt.instantiate(t)))));let e=t,i=this.repository.structure;if(1==i.length){let t=i[0].sx;if(1==e.length)return e[0].offset=Math.floor((t-e[0].gadgets[0].sx)/2),{devices:e};if(2==e.length){let[i,s]=e.map((t=>t.gadgets[0])),n=this.overlaps[0].c[2],r=this.overlaps[1].c[0],o=i.sx+s.rx(n.q,2),h=s.sx+i.rx(r.q,0);return o>t||h>t?null:(e[1].offset=t-h,{devices:e})}}if(2==i.length&&1==this.partitions.length){let[t,i]=this.overlaps,[s,n]=[t,i].map((t=>this.repository.structure[t.parent])),r=s.c[0].e==n.c[0].e,o=e[0].gadgets;return o[0].sx>s.sx||o[1].sx>n.sx?null:(r||(e[0].offset=s.sx-o[0].sx),{devices:e})}if(2==i.length&&2==this.partitions.length){let[t,i]=e.map((t=>t.gadgets[0])),[s,n]=this.overlaps,r=s.c[0].e>=0&&s.c[2].e>=0;r&&([t,i]=[i,t],[s,n]=[n,s]);let[o,h]=[s,n].map((t=>this.repository.structure[t.parent])),l=s.c[0].e<0,a=l?0:2,d=s.c[a].q,u=o.sx,c=t.sx,p=t.setupConnectionSlack(i,a,d);u-=Math.ceil(i.rx(d,a))+p;let g=l?[null!=p?p:0,0]:[u-c,h.sx-i.sx];if(r&&g.reverse(),c>u)return null;let f=this.getRelativeDelta(o,h,i);return i.intersects(f,l?K.QV[0]:K.QV[2])?null:(e.forEach(((t,e)=>t.offset=g[e])),{devices:e})}return null}getRelativeDelta(t,e,i){let s=t.c[0].e==e.c[0].e,n=I.getMaxIntersectionDistance(this.design.tree,t,e,s);e.ox>t.ox&&([t,e]=[e,t]);let r={x:n-e.ox,y:n-t.oy};return s||(r.x=i.sx-r.x,r.y=i.sy-r.y),new H(r)}onMove(){this.repository.stretch.selected=!this.entry.selected}getMemento(){let t=this._initMemento?this._prototypes:this.memento.map((t=>t instanceof Q?t.toJSON():t));return this._initMemento=!1,t}toJSON(t=!1){let e={partitions:this.partitions.map((t=>t.toJSON()))};return t&&(e.patterns=this.getMemento(),e.index=this.index),e}};t([e],nt.prototype,"isActive",null),nt=t([e],nt);class rt extends tt{drawUnscaled(){if(this.mountEvents(),!this.$studio)return;this.$studio.$display.render(),this.renderUnscaled();let t=14*Math.sqrt(this.scale);this._label.fontSize=t,this._glow.fontSize=t}get overflow(){if(this.disposed||!this.$studio)return 0;this.drawUnscaled();let t=0,e=this.$studio.$display.scale*this.control.sheet.width,{left:i,right:s}=this._label.bounds;return i<0&&(t=-i),s>e&&(t=Math.max(t,s-e)),Math.ceil(t)}}t([e],rt.prototype,"drawUnscaled",null),t([e],rt.prototype,"overflow",null);let ot=class extends W{constructor(t){super(t),this._junction=t,this.$addItem(Dt.junction,this._shade=new paper.CompoundPath(jt.junction))}render(){if(this._shade.visible=this._junction.status==bt.tooClose){let t=this._junction.f1,e=this._junction.f2,i=t.view,s=e.view,n=this._junction.$treeDistance-(t.radius+e.radius),r=[i.circleJSON,s.circleJSON];0!=n&&r.push(i.makeJSON(n),s.makeJSON(n)),Ct.processJunction(this._shade,r)}}};ot=t([e],ot);let ht=class extends tt{constructor(t){super(t),this._components=new T((()=>this.info.components),(t=>new A(this,t.split(",").map((t=>Number(t)))))),this._rendered=!1,this.$addItem(Dt.shade,this._shade=new paper.CompoundPath(jt.shade)),this.$addItem(Dt.hinge,this._hinge=new paper.CompoundPath(jt.hinge)),this.$addItem(Dt.ridge,this._ridge=new paper.CompoundPath(jt.ridge)),this.boundary=new paper.CompoundPath({})}contains(t){return this.control.sheet.view.contains(t)&&this._shade.contains(t)}get info(){this.disposeEvent();let t,e,i=this.control.edge;0==i.wrapSide?(e=this.toComponents(i.l1,i.n1).concat(this.toComponents(i.l2,i.n2)),t=i.a1.concat(i.a2)):2==i.wrapSide?(e=this.toComponents(i.l2,i.n2),t=i.a2):(e=this.toComponents(i.l1,i.n1),t=i.a1);let s=[],n=this.design;for(let e of t)if(e.isRiver){let t=n.rivers.get(e);s.push(t.view)}else{let t=n.flaps.get(1==e.n1.degree?e.n1:e.n2);s.push(t.view)}return{inner:s,length:i.length,components:e}}toComponents(t,e){return t.map((t=>t.id+","+e.id))}get design(){return this.control.sheet.design}get components(){return[...this._components.values()]}onDispose(){Shrewd.terminate(this._components),super.onDispose()}get closure(){return this.disposeEvent(),v.union(this.components.map((t=>t.contour)))}get interior(){return this.disposeEvent(),v.union(this.info.inner.map((t=>t.closure)))}get closurePath(){return new paper.CompoundPath({children:re.fromSegments(this.closure)})}get actualPath(){this.disposeEvent();let t=this.closurePath.children,e=re.fromSegments(this.interior),i=new paper.CompoundPath({children:t.concat(e).map((t=>t.clone()))});return i.reorient(!1,!0),i}render(){re.replaceContent(this.boundary,this.closurePath,!1),re.replaceContent(this._shade,this.actualPath,!1),re.replaceContent(this._hinge,this.actualPath,!1),this._rendered=!0}get corners(){var t;this.disposeEvent();let e=this.actualPath,i=(null!==(t=e.children)&&void 0!==t?t:[e]).map((t=>t.segments.map((t=>new H(t.point)))));if(0==i[0].length)return[];let{paths:s,map:n}=zt.collect(i),r=[];for(let t of s){let e=t.length,i=t[e-1],s=t[0],o=s.sub(i),h=new q(this.control.length);for(let l=0;l<e;l++){let a=t[(l+1)%e],d=a.sub(s);if(0==o.dot(d)&&o.rotate90().dot(d)>0){let t=new V(Math.sign(d.x)-Math.sign(o.x),Math.sign(d.y)-Math.sign(o.y)).scale(h),e=s.add(t);r.push([s,e,n.has(e.toString())])}i=s,s=a,o=d}}return r}renderRidge(){var t;let e=this.control.sheet.design.openAnchors;if(this.draw(),this._rendered){this._rendered=!1,this._ridge.removeChildren();for(let[i,s,n]of this.corners){let r=new Wt(i,s),o=r.slope.value,h=o+","+(i.x-o*i.y),l=(null!==(t=e.get(h))&&void 0!==t?t:[]).find((t=>r.contains(t,!0)));l?re.addLine(this._ridge,i,l):n&&re.addLine(this._ridge,i,s)}}}renderSelection(t){this._shade.visible=t}};t([e],ht.prototype,"info",null),t([e],ht.prototype,"components",null),t([l("closure")],ht.prototype,"closure",null),t([l("interior")],ht.prototype,"interior",null),t([e],ht.prototype,"closurePath",null),t([e],ht.prototype,"actualPath",null),t([e],ht.prototype,"corners",null),t([e],ht.prototype,"renderRidge",null),ht=t([e],ht);class lt extends st{constructor(){super(...arguments),this.location={x:0,y:0}}dragStart(t){this._dragOffset=t.sub(this.location)}dragConstraint(t){if(t instanceof V)return this.constraint(t,this.location);{let e=new H(this.location),i=this.constraint(t.sub(this._dragOffset).sub(e),e);return e.add(i).add(this._dragOffset)}}drag(t){(t=t instanceof H?t.sub(this._dragOffset):new H(this.location).add(t)).eq(this.location)||(O.create(this,t.toIPoint(),!1),this.onDragged())}onDragged(){}constraint(t,e){return V.ZERO}static relocate(t,e,i=!1){if(!t||!e)return;let s=t.sheet,n=e.sheet,r={x:Math.round(t.location.x/s.width*n.width),y:Math.round(t.location.y/s.height*n.height)};i?O.assign(e.location,r):O.create(e,r,!1)}}t([e],lt.prototype,"location",void 0);class at extends lt{constructor(){super(...arguments),this._isNew=!0}get isNew(){return this._isNew}set isNew(t){t||(this._isNew=t)}watchIsNew(){this._isNew&&this.sheet!=this.design.sheet&&(this._isNew=!1)}}t([e],at.prototype,"watchIsNew",null);let dt=class extends rt{constructor(t){super(t),this.jsonCache=[],this.$addItem(Dt.shade,this._shade=new paper.Path.Rectangle(jt.shade)),this.$addItem(Dt.hinge,this.hinge=new paper.Path.Rectangle(jt.hinge)),this.$addItem(Dt.shade,this._circle=new paper.Path(jt.circle)),this._dots=$t((t=>{let e=new paper.Path.Circle(jt.dot);return this.$addItem(Dt.dot,e),e})),this.$addItem(Dt.ridge,this._innerRidges=new paper.CompoundPath(jt.ridge)),this.$addItem(Dt.ridge,this._outerRidges=new paper.CompoundPath(jt.ridge)),this.$addItem(Dt.label,this._glow=new paper.PointText(jt.glow)),this.$addItem(Dt.label,this._label=new paper.PointText(jt.label)),this._component=new C(this,t)}contains(t){return this.control.sheet.view.contains(t)&&(this.hinge.contains(t)||null!=this.hinge.hitTest(t))}get circle(){return this.makeRectangle(0)}get circleJSON(){return this.circle.exportJSON()}makeRectangle(t){let e=this.control.points,i=this.control.node.radius+t;return new paper.Path.Rectangle({from:[e[2].x-i,e[2].y-i],to:[e[0].x+i,e[0].y+i],radius:i})}makeJSON(t){return this.control.selected?this.makeRectangle(t).exportJSON():this.jsonCache[t]=this.jsonCache[t]||this.makeRectangle(t).exportJSON()}clearCache(){!this.control.design.dragging&&this.jsonCache.length&&(this.jsonCache=[])}get closure(){return this._component.segment}renderHinge(){var t,e;if(this.control.disposed)return;this._circle.visible=null!==(e=null===(t=this.$studio)||void 0===t?void 0:t.$display.settings.showHinge)&&void 0!==e&&e;let i=re.fromSegments(this.closure);if(this.hinge.removeSegments(),i.length)this.hinge.add(...i[0].segments);else debugger}render(){let t=this.control.width,e=this.control.height;this._circle.copyContent(this.circle),this.renderHinge();let i=$t((t=>this.control.points[t].toPaper()));this._innerRidges.removeChildren(),this._innerRidges.moveTo(i[3]),i.forEach((t=>this._innerRidges.lineTo(t))),this._innerRidges.visible=t>0||e>0,this._outerRidges.removeChildren(),this.control.quadrants.forEach(((t,e)=>{null==t.pattern&&re.addLine(this._outerRidges,i[e],t.corner)})),this._shade.copyContent(this.hinge)}renderUnscaled(){let t=this.control.sheet.displayScale,e=this.control.width,i=this.control.height;$t((e=>{let i=this.control.points[e].toPaper();var s;return this._dots[e].position.set([(s=i).x*t,-s.y*t]),i})),this._dots[2].visible=e>0||i>0,this._dots[1].visible=this._dots[3].visible=e>0&&i>0,this._label.content=this.control.node.name,se.setLabel(this.control.sheet,this._label,this._glow,this.control.dragSelectAnchor,this._dots[0])}renderDot(){let t=3*Math.pow(this.scale,.75);$t((e=>{this._dots[e].copyContent(new paper.Path.Circle({position:this._dots[e].position,radius:t}))}))}renderSelection(t){this._shade.visible=t}};t([e],dt.prototype,"circle",null),t([e],dt.prototype,"circleJSON",null),t([e],dt.prototype,"clearCache",null),t([e],dt.prototype,"renderHinge",null),t([e],dt.prototype,"renderDot",null),dt=t([e],dt);let ut=class extends rt{constructor(t){super(t),this.$addItem(Dt.ridge,this.line=new paper.Path.Line(jt.edge)),this.$addItem(Dt.label,this._glow=new paper.PointText(jt.glow)),this.$addItem(Dt.label,this._label=new paper.PointText(jt.label)),this._lineRegion=new paper.Path.Line({strokeWidth:15})}contains(t){return!(null==this._lineRegion.hitTest(t)&&null==this._glow.hitTest(t.transform(this._glow.layer.matrix.inverted()))||this.control.v1.view.contains(t)||this.control.v2.view.contains(t))}render(){let t=this.control.v1.location,e=this.control.v2.location;this._lineRegion.segments[0].point.set([t.x,t.y]),this._lineRegion.segments[1].point.set([e.x,e.y]),this.line.copyContent(this._lineRegion)}renderSelection(t){let e=t?re.Red():re.Black();this._label.fillColor=this._label.strokeColor=this.line.strokeColor=e,this.line.strokeWidth=t?3:2}renderUnscaled(){this.draw();let t=this.control.v1.location,e=this.control.v2.location,i={x:(t.x+e.x)/2,y:(t.y+e.y)/2};this._label.content=this.control.length.toString(),se.setLabel(this.control.sheet,this._label,this._glow,i,this.line)}};ut=t([e],ut);let ct=class extends rt{constructor(t){super(t);let e=Object.assign({},jt.dot,{radius:4});this.$addItem(Dt.dot,this._dot=new paper.Path.Circle(e)),e=Object.assign({},jt.dotSelected,{radius:4}),this.$addItem(Dt.dot,this._dotSel=new paper.Path.Circle(e)),this.$addItem(Dt.label,this._glow=new paper.PointText(jt.glow)),this.$addItem(Dt.label,this._label=new paper.PointText(jt.label)),this._circle=new paper.Path.Circle({radius:.4})}contains(t){return this._circle.contains(t)||null!=this._glow.hitTest(t.transform(this._glow.layer.matrix.inverted()))}render(){let t=this.control.sheet.displayScale,e=this.control.location.x,i=this.control.location.y;this._circle.position.set([e,i]),this._dot.position.set([e*t,-i*t]),this._dotSel.position.set([e*t,-i*t])}renderSelection(t){this._dotSel.visible=t}renderDot(){let t=4*Math.sqrt(this.scale);this._dot.copyContent(new paper.Path.Circle({position:this._dot.position,radius:t}))}renderUnscaled(){let t=this.control.location.x,e=this.control.location.y,i=this.control.node.edges.map((t=>{let e=this.control.sheet.design.edges.get(t).view;return e.draw(),e.line}));this._label.content=this.control.node.name,se.setLabel(this.control.sheet,this._label,this._glow,{x:t,y:e},this._dot,...i)}};var pt;t([e],ct.prototype,"renderDot",null),ct=t([e],ct);let gt=pt=class extends at{constructor(t,e){super(t),this.mWidth=0,this.mHeight=0,this.$junctions=[],this.$junctionChanged=!1,this.node=e;let i=t.design,s=i.options.get(this);s?(this.location.x=s.x,this.location.y=s.y,this.width=s.width,this.height=s.height,this.isNew=!1):lt.relocate(i.vertices.get(this.node),this,!0),this.quadrants=$t((e=>new K(t,this,e))),this.view=new dt(this),i.history.construct(this.toMemento())}get type(){return"Flap"}get tag(){return"f"+this.node.id}get width(){return this.mWidth}set width(t){if(t>=0&&t<=this.sheet.width){let e=this.location.x+t-this.sheet.width;e>0&&O.create(this,{x:-e,y:0}),this.mWidth=t}}get height(){return this.mHeight}set height(t){if(t>=0&&t<=this.sheet.height){let e=this.location.y+t-this.sheet.height;e>0&&O.create(this,{x:0,y:-e}),this.mHeight=t}}selectableWith(t){return t instanceof pt}get dragSelectAnchor(){return{x:this.location.x+this.width/2,y:this.location.y+this.height/2}}get points(){let t=this.location.x,e=this.location.y,i=this.width,s=this.height;return[new H(t+i,e+s),new H(t,e+s),new H(t,e),new H(t+i,e)]}get name(){return this.node.name}set name(t){this.node.name=t}get radius(){return this.node.radius}set radius(t){let e=this.node.leafEdge;e&&(e.length=t)}onDragged(){this.isNew&&lt.relocate(this,this.design.vertices.get(this.node))}get shouldDispose(){return super.shouldDispose||this.node.disposed||1!=this.node.degree}onDispose(){this.design.history.destruct(this.toMemento()),super.onDispose()}toMemento(){return[this.tag,this.toJSON()]}toJSON(){return{id:this.node.id,width:this.width,height:this.height,x:this.location.x,y:this.location.y}}constraint(t,e){return this.sheet.constraint(t,e),this.sheet.constraint(t,{x:e.x+this.width,y:e.y+this.height}),t}get junctions(){return this.design.junctions,this.$junctions}get validJunctions(){return this.junctions.filter((t=>t.isValid))}};var ft;t([d],gt.prototype,"mWidth",void 0),t([d],gt.prototype,"mHeight",void 0),t([e],gt.prototype,"dragSelectAnchor",null),t([e],gt.prototype,"points",null),t([e({comparer(){let t=this.$junctionChanged;return this.$junctionChanged=!1,!t}})],gt.prototype,"junctions",null),t([r],gt.prototype,"validJunctions",null),gt=pt=t([e],gt);let yt=ft=class extends at{constructor(t,e){super(t),this.height=0,this.width=0,this.node=e;let i=t.design.options.get(this);i&&(null!=i.name&&(this.node.name=i.name),this.location.x=i.x,this.location.y=i.y,this.isNew=!!i.isNew,this.selected=!!i.selected),this.view=new ct(this),t.design.history.construct(this.toMemento())}get type(){return"Vertex"}get tag(){return"v"+this.node.id}get shouldDispose(){return super.shouldDispose||this.node.disposed}onDispose(){this.design.history.destruct(this.toMemento()),super.onDispose()}get name(){return this.node.name}set name(t){this.node.name=t}get degree(){return this.node.degree}selectableWith(t){return t instanceof ft}get dragSelectAnchor(){return this.location}onDragged(){this.isNew&&lt.relocate(this,this.design.flaps.get(this.node))}addLeaf(t=1){let e=[...this.design.vertices.values()],i=this.node.addLeaf(t),s=this.findClosestEmptyPoint(e);this.design.options.set("v"+i.id,{id:i.id,name:i.name,x:s.x,y:s.y,isNew:!0})}findClosestEmptyPoint(t){let{x:e,y:i}=this.location,s=new H(e+.125,i+.0625),n=[],r=new Set;for(let e of t)r.add(e.location.x+","+e.location.y);for(let t=e-5;t<=e+5;t++)for(let e=i-5;e<=i+5;e++)if(!r.has(t+","+e)){let i=new H(t,e);n.push([i,i.dist(s)])}return n.sort(((t,e)=>t[1]-e[1])),n[0][0]}delete(){this.node.delete()}deleteAndJoin(){if(2!=this.node.degree)return;let t=this.node.dispose(),e=t.toJSON();e.selected=!0,this.design.options.set(t.tag,e)}toMemento(){return[this.tag,this.toJSON()]}toJSON(){return{id:this.node.id,name:this.name,x:this.location.x,y:this.location.y}}constraint(t,e){return this.sheet.constraint(t,e),t}};yt=ft=t([e],yt);let vt=class{constructor(t){if(this.designMap=new Map,this.design=null,this._updating=!1,this._lastUpdate=performance.now(),"object"!=typeof paper)throw new Error("BPStudio requires paper.js.");let e=document.querySelector(t);if(null==e||!(e instanceof HTMLElement))throw new Error("selector is not valid");this.$el=e,this.$paper=new paper.PaperScope,this.$display=new qt(this),this.system=new Pt(this),this.update()}load(t){return"string"==typeof t&&(t=JSON.parse(t)),this.tryLoad(It.process(t,this.onDeprecate))}create(t){return Object.assign(t,{version:It.current,tree:{nodes:[{id:0,name:"",x:10,y:10},{id:1,name:"",x:10,y:13},{id:2,name:"",x:10,y:7}],edges:[{n1:0,n2:1,length:1},{n1:0,n2:2,length:1}]}}),this.restore(t)}restore(t){let e=new G(this,It.process(t,this.onDeprecate));return this.designMap.set(e.id,e),e}select(t){if(null!=t){let e=this.designMap.get(t);e&&(this.design=e)}else this.design=null}close(t){let e=this.designMap.get(t);e&&(this.designMap.delete(t),e.dispose())}closeAll(){this.design=null;for(let t of this.designMap.values())t.dispose();this.designMap.clear()}tryLoad(t){return this.design=new G(this,t),this.designMap.set(this.design.id,this.design),this.update(),this.design}toBPS(){if(!this.design)return"";let t=this.design.toJSON();delete t.history;let e=JSON.stringify(t),i=new Blob([e],{type:"application/octet-stream"});return URL.createObjectURL(i)}get TreeMaker(){return ee}get running(){return this._updating}async update(t){(t=null!=t?t:performance.now())-this._lastUpdate<50?requestAnimationFrame(this.update.bind(this)):this._updating||(this._updating=!0,Shrewd.commit(),this.design&&!this.design.dragging&&this.design.history.flush(this.system.selections),await Ct.done(),this.$display.project.view.update(),this.onUpdate&&(this.onUpdate(),delete this.onUpdate),this._updating=!1,this._lastUpdate=t,requestAnimationFrame(this.update.bind(this)))}};t([e],vt.prototype,"design",void 0),vt=t([e],vt);let _t=class extends y{constructor(t,e){if(super(t),this.steps=[],this.index=0,this._savedIndex=0,this._queue=[],this._construct=[],this._destruct=[],this._selection=[],this._moving=!0,this._design=t,e)try{this.steps.push(...e.steps.map((e=>mt.restore(t,e)))),this.index=e.index,this._savedIndex=e.savedIndex}catch(t){}}toJSON(){return{index:this.index,savedIndex:this._savedIndex,steps:this.steps}}queue(t){if(!this._moving){for(let e of this._queue)if(t.canAddTo(e))return t.addTo(e);this._queue.push(t)}}construct(t){this._moving||this._construct.push(t)}destruct(t){this._moving||this._destruct.push(t)}flush(t){let e=t.map((t=>t.tag));if(this._queue.length){let t=this.lastStep;if(t&&t.tryAdd(this._queue,this._construct,this._destruct))t.isVoid&&(this.steps.pop(),this.index--);else{let t=new mt(this._design,{commands:this._queue,construct:this._construct,destruct:this._destruct,mode:this._design.mode,before:this._selection,after:e});t.isVoid||this.addStep(t)}this._queue=[],this._construct=[],this._destruct=[]}this._selection=e,this._moving=!1}get modified(){return this._savedIndex!=this.index}notifySave(){this._savedIndex=this.index}addStep(t){this.steps.length>this.index&&(this.steps.length=this.index),this.steps[this.index++]=t,this.steps.length>30&&(this.steps.shift(),this.index--,this._savedIndex--)}get lastStep(){if(!(0==this.index||this.index<this.steps.length))return this.steps[this.index-1]}fieldChange(t,e,i,s){this._moving||N.create(t,e,i,s)}get canUndo(){return this.index>0}get canRedo(){return this.index<this.steps.length}undo(){this.canUndo&&(this._moving=!0,this.steps[--this.index].undo())}redo(){this.canRedo&&(this._moving=!0,this.steps[this.index++].redo())}};t([e],_t.prototype,"steps",void 0),t([e],_t.prototype,"index",void 0),t([e],_t.prototype,"_savedIndex",void 0),t([e],_t.prototype,"modified",null),t([e],_t.prototype,"canUndo",null),t([e],_t.prototype,"canRedo",null),_t=t([e],_t);class mt{constructor(t,e){var i,s;this._fixed=!1,this._design=t,this._signature=mt.signature(e.commands),this.commands=e.commands,this.construct=null!==(i=e.construct)&&void 0!==i?i:[],this.destruct=null!==(s=e.destruct)&&void 0!==s?s:[],this.before=e.before,this.after=e.after,this.mode=e.mode,this._reset()}static restore(t,e){return e.commands=e.commands.map((e=>_.restore(t,e))),new mt(t,e)}static signature(t){let e=t.concat();return e.sort(((t,e)=>t.signature.localeCompare(e.signature))),e.map((t=>t.signature)).join(";")}_reset(){this._timeout&&clearTimeout(this._timeout),this._fixed||(this._timeout=setTimeout((()=>this._fix()),1e3))}_fix(){this._design.dragging?this._reset():this._fixed=!0}tryAdd(t,e,i){if(this._fixed)return!1;if(mt.signature(t)!=this._signature)return!1;for(let e=0;e<t.length;e++)if(!t[e].canAddTo(this.commands[e]))return!1;for(let e=0;e<t.length;e++)t[e].addTo(this.commands[e]);return this.construct.push(...e),this.destruct.push(...i),this._reset(),!0}get isVoid(){return this.commands.every((t=>t.isVoid))}undo(){let t=this.commands.concat().reverse();for(let e of t)e.undo();let e=this.destruct.concat().reverse();for(let t of e)this._design.options.set(...t);this._design.mode=this.mode,this._design.restoreSelection(this.before),this._fixed=!0}redo(){for(let t of this.commands)t.redo();for(let t of this.construct)this._design.options.set(...t);this._design.mode=this.mode,this._design.restoreSelection(this.after),this._fixed=!0}toJSON(){let t=he(this);return this.construct.length||delete t.construct,this.destruct.length||delete t.destruct,t}}var xt;t([a],mt.prototype,"_design",void 0),t([a],mt.prototype,"_signature",void 0),t([a],mt.prototype,"_fixed",void 0),t([a],mt.prototype,"_timeout",void 0),function(t){t[t.field=0]="field",t[t.move=1]="move",t[t.add=2]="add",t[t.remove=3]="remove"}(xt||(xt={}));let wt=class extends st{constructor(t,e,i,s){var n;super(t),this.v1=e,this.v2=i,this.edge=s,this.view=new ut(this),(null===(n=t.design.options.get(s))||void 0===n?void 0:n.selected)&&(this.selected=!0)}get type(){return"Edge"}get tag(){return"e"+this.edge.tag}get shouldDispose(){return super.shouldDispose||this.edge.disposed}split(){this.toVertex(R.prototype.split)}deleteAndMerge(){this.toVertex(R.prototype.deleteAndMerge)}delete(){this.edge.delete()}toVertex(t){let e=this.v1.location,i=this.v2.location,s=Math.round((e.x+i.x)/2),n=Math.round((e.y+i.y)/2),r=t.apply(this.design.tree,[this.edge]);this.design.options.set("v"+r.id,{id:r.id,name:r.name,x:s,y:n,selected:!0})}get length(){return this.edge.length}set length(t){this.edge.length=t}toJSON(){return this.edge.toJSON()}};var bt;wt=t([e],wt),function(t){t[t.tooClose=0]="tooClose",t[t.overlap=1]="overlap",t[t.tooFar=2]="tooFar"}(bt||(bt={}));let St=class extends L{constructor(t,e,i){super(t),e.node.id>i.node.id&&([e,i]=[i,e]),this.f1=e,this.f2=i,e.$junctions.push(this),i.$junctions.push(this),e.$junctionChanged=!0,i.$junctionChanged=!0,this.id=e.node.id+":"+i.node.id,new ot(this)}static createTeamId(t){let e=new Set;return t.forEach((t=>{e.add(t.f1.node.id),e.add(t.f2.node.id)})),Array.from(e).sort(((t,e)=>t-e)).join(",")}static sort(t,e){let i=t.f1.node.id-e.f1.node.id;return 0!=i?i:t.f2.node.id-e.f2.node.id}get shouldDispose(){return super.shouldDispose||this.f1.disposed||this.f2.disposed}onDispose(){this.f1.$junctions.splice(this.f1.$junctions.indexOf(this),1),this.f2.$junctions.splice(this.f2.$junctions.indexOf(this),1),this.f1.$junctionChanged=!0,this.f2.$junctionChanged=!0}getBaseRectangle(t){let e=this.sx>0?this.q2:this.q1;return null==e?void 0:e.getBaseRectangle(this,t)}get _lca(){this.disposeEvent();let t=this.f1.node,e=this.f2.node;return t.tree.lca(t,e)}findIntersection(t){let e=this._lca,i=t._lca;if(e==i)return e;let s=e.tree.lca(e,i);return s!=e&&s!=i?null:s==e?i:e}get coverCandidate(){let t=[];for(let e of this.sheet.design.validJunctions){if(e==this)continue;let i=this.findIntersection(e);i&&t.push([e,i])}return t}isCoveredBy(t,e){if(this.direction%2!=t.direction%2)return!1;let[i,s]=[t.getBaseRectangle(e),this.getBaseRectangle(e)];return!!(i&&s&&i.contains(s))&&(!i.equals(s)||(Math.abs(t.sx)<Math.abs(this.sx)||Math.abs(t.sy)<Math.abs(this.sy)))}get coveredBy(){if(this.disposeEvent(),!this.isValid)return[];let t=[];for(let[e,i]of this.coverCandidate)this.isCoveredBy(e,i)&&t.push(e);return t}get isCovered(){return this.disposeEvent(),this.coveredBy.some((t=>0==t.coveredBy.length))}toJSON(){return{c:[{type:Rt.flap,e:this.f1.node.id,q:this.q1.q},{type:Rt.side},{type:Rt.flap,e:this.f2.node.id,q:this.q2.q},{type:Rt.side}],ox:this.ox,oy:this.oy,sx:this.sx<0?-this.sx:this.sx}}get neighbors(){if(this.disposeEvent(),this.direction>3)return[];let t=this.q1.activeJunctions.concat(),e=this.q2.activeJunctions.concat();return t.splice(t.indexOf(this),1),e.splice(e.indexOf(this),1),t.concat(e)}get q1(){return Lt(this.direction)?this.f1.quadrants[this.direction]:null}get q2(){return Lt(this.direction)?this.f2.quadrants[Ft(this.direction)]:null}get $treeDistance(){this.disposeEvent();let t=this.f1.node,e=this.f2.node;return t.tree.dist(t,e)}get status(){return this._flapDistance<this.$treeDistance?bt.tooClose:this.ox&&this.oy?bt.overlap:bt.tooFar}get fx(){return-Math.sign(this.sx)}get fy(){return-Math.sign(this.sy)}get ox(){let t=this.$treeDistance-Math.abs(this.sx);return t>0?t:NaN}get oy(){let t=this.$treeDistance-Math.abs(this.sy);return t>0?t:NaN}get sx(){let t=this.f1.location.x,e=this.f2.location.x,i=this.f1.width,s=t-e-this.f2.width;return s>=0?s:(s=t+i-e,s<=0?s:NaN)}get sy(){let t=this.f1.location.y,e=this.f2.location.y,i=this.f1.height,s=t-e-this.f2.height;return s>=0?s:(s=t+i-e,s<=0?s:NaN)}get signX(){return Math.sign(this.sx)}get signY(){return Math.sign(this.sy)}get direction(){let t=this.signX,e=this.signY;return t<0&&e<0?kt.UR:t>0&&e<0?kt.UL:t>0&&e>0?kt.LL:t<0&&e>0?kt.LR:t<0?kt.R:t>0?kt.L:e<0?kt.T:e>0?kt.B:kt.none}get _flapDistance(){let t=this.sx,e=this.sy,i=0!=t&&!isNaN(t),s=0!=e&&!isNaN(e);return i&&s?Math.sqrt(t*t+e*e):i?Math.abs(t):s?Math.abs(e):0}get isValid(){return this.status==bt.overlap}static findMinMax(t,e,i){let s=t[0][e],n=t[0];for(let r=1;r<t.length;r++)t[r][e]*i>s*i&&(n=t[r],s=t[r][e]);return n}};t([e],St.prototype,"_lca",null),t([e({comparer(t,e){if(!t)return!1;if(t.length!=e.length)return!1;for(let i=0;i<t.length;i++)if(t[i][0]!=e[i][0]||t[i][1]!=e[i][1])return!1;return!0}})],St.prototype,"coverCandidate",null),t([o("jcb")],St.prototype,"coveredBy",null),t([e],St.prototype,"isCovered",null),t([e],St.prototype,"neighbors",null),t([e],St.prototype,"q1",null),t([e],St.prototype,"q2",null),t([e],St.prototype,"$treeDistance",null),t([e],St.prototype,"status",null),t([e],St.prototype,"fx",null),t([e],St.prototype,"fy",null),t([e],St.prototype,"ox",null),t([e],St.prototype,"oy",null),t([e],St.prototype,"sx",null),t([e],St.prototype,"sy",null),t([e],St.prototype,"signX",null),t([e],St.prototype,"signY",null),t([e],St.prototype,"direction",null),t([e],St.prototype,"_flapDistance",null),t([e],St.prototype,"isValid",null),St=t([e],St);let Mt=class extends st{constructor(t,e){super(t),this.edge=e,this.view=new ht(this)}get type(){return"River"}get tag(){return"r"+this.edge.tag}get shouldDispose(){return super.shouldDispose||this.edge.disposed||!this.edge.isRiver}delete(){this.design.edges.get(this.edge).deleteAndMerge()}get length(){return this.edge.length}set length(t){this.edge.length=t}};Mt=t([e],Mt);let qt=class{constructor(t){this.MARGIN=30,this.DPI=null!==devicePixelRatio&&void 0!==devicePixelRatio?devicePixelRatio:1,this.lockViewport=!1,this.settings={showAxialParallel:!0,showGrid:!0,showHinge:!0,showRidge:!0,showLabel:!0,showDot:!0,includeHiddenElement:!1},this._printing=!1,this._studio=t,t.$el.appendChild(this.spaceHolder=document.createElement("div")),this.spaceHolder.style.zIndex="-10",this._canvas=document.createElement("canvas"),t.$el.appendChild(this._canvas),window.addEventListener("resize",this.setSize.bind(this)),this.setSize(),setTimeout((()=>this.setSize()),10),window.addEventListener("beforeprint",this.beforePrint.bind(this)),window.addEventListener("afterprint",this.afterPrint.bind(this));let e=matchMedia("(hover: none), (pointer: coarse)").matches;document.addEventListener("focusin",(t=>{e&&(t.target instanceof HTMLInputElement||t.target instanceof HTMLTextAreaElement)&&(this.lockViewport=!0)})),document.addEventListener("focusout",(t=>this.lockViewport=!1)),t.$paper.setup(this._canvas),t.$paper.settings.insertItems=!1,this.project=t.$paper.project,this.project.view.autoUpdate=!1,this.project.currentStyle.strokeColor=re.Black(),this.project.currentStyle.strokeScaling=!1;for(let t of Tt.values(Dt))this.project.addLayer(new paper.Layer({name:Dt[t]}));this.boundary=new paper.Path.Rectangle({from:[0,0],to:[0,0]});for(let t of Tt.values(Dt))Jt[t].clipped&&(this.project.layers[t].addChild(this.boundary.clone()),this.project.layers[t].clipped=!0)}setSize(){this.lockViewport||(this.viewWidth=this._studio.$el.clientWidth,this.viewHeight=this._studio.$el.clientHeight)}toSVG(){let t=Math.max(this.sheetWidth,this.viewWidth),e=Math.max(this.sheetHeight,this.viewHeight),i=(t-this.sheetWidth)/2-this.scroll.x,s=(e-this.sheetHeight)/2-this.scroll.y,n=new paper.Rectangle(i,s,this.sheetWidth,this.sheetHeight),r=this._studio.$paper.project.exportSVG({bounds:n,matrix:this.project.view.matrix});this.settings.includeHiddenElement||this.removeHidden(r);let o=new Blob([r.outerHTML],{type:"image/svg+xml"});return URL.createObjectURL(o)}removeHidden(t){let e=Array.from(t.children);for(let i of e)"hidden"==i.getAttribute("visibility")?t.removeChild(i):this.removeHidden(i)}get img(){return this._img||this.spaceHolder.appendChild(this._img=new Image),this._img}createPNG(){let t=document.createElement("canvas"),e=t.getContext("2d"),i=this.img;return new Promise((s=>{i.addEventListener("load",(()=>{t.width=i.clientWidth,t.height=i.clientHeight,e.fillStyle="white",e.fillRect(0,0,t.width,t.height),e.drawImage(i,0,0,i.naturalWidth,i.naturalHeight,0,0,i.clientWidth,i.clientHeight),this._printing=!1,t.toBlob((t=>s(t)))}),{once:!0}),this.beforePrint()}))}toPNG(){return this.createPNG().then((t=>URL.createObjectURL(t)))}copyPNG(){return this.createPNG().then((t=>navigator.clipboard.write([new ClipboardItem({"image/png":t})])))}beforePrint(){if(clearTimeout(this._debounce),!this._printing&&"visible"==document.visibilityState){let t=this.img.src;setTimeout((()=>URL.revokeObjectURL(t)),5e3),this.img.src=this.toSVG(),this._printing=!0}}afterPrint(){this._debounce=setTimeout((()=>{this._printing=!1,this._debounce=NaN}),1e3)}get scroll(){var t,e;return null!==(e=null===(t=this._studio.design)||void 0===t?void 0:t.sheet.scroll)&&void 0!==e?e:{x:0,y:0}}get scale(){if(this._studio.design){let t=this.getAutoScale(this._studio.design.sheet);return this._studio.design.sheet.zoom*t/100}return 100}get horMargin(){var t,e;return Math.max((null!==(e=null===(t=this._studio.design)||void 0===t?void 0:t.sheet.margin)&&void 0!==e?e:0)+10,this.MARGIN)}get sheetWidth(){var t,e,i;return(null!==(i=null===(e=null===(t=this._studio.design)||void 0===t?void 0:t.sheet)||void 0===e?void 0:e.width)&&void 0!==i?i:0)*this.scale+2*this.horMargin}get sheetHeight(){var t,e,i;return(null!==(i=null===(e=null===(t=this._studio.design)||void 0===t?void 0:t.sheet)||void 0===e?void 0:e.height)&&void 0!==i?i:0)*this.scale+2*this.MARGIN}get isXScrollable(){return this.sheetWidth>this.viewWidth+1}get isYScrollable(){return this.sheetHeight>this.viewHeight+1}getAutoScale(t){var e,i,s;t=t||(null===(e=this._studio.design)||void 0===e?void 0:e.sheet);let n=(this.viewWidth-2*this.horMargin)/(null!==(i=null==t?void 0:t.width)&&void 0!==i?i:1),r=(this.viewHeight-2*this.MARGIN)/(null!==(s=null==t?void 0:t.height)&&void 0!==s?s:1);return Math.min(n,r)}isScrollable(){return this._studio.$el.classList.toggle("scroll-x",this.isXScrollable),this._studio.$el.classList.toggle("scroll-y",this.isYScrollable),this.isXScrollable||this.isYScrollable}renderSetting(){var t,e;let i=null!==(e="layout"!=(null===(t=this._studio.design)||void 0===t?void 0:t.mode))&&void 0!==e&&e;this.project.layers[Dt.hinge].visible=this.settings.showHinge,this.project.layers[Dt.ridge].visible=this.settings.showRidge||i,this.project.layers[Dt.axisParallel].visible=this.settings.showAxialParallel,this.project.layers[Dt.label].visible=this.settings.showLabel,this.project.layers[Dt.dot].visible=this.settings.showDot||i}onSheetChange(){var t;let e=null===(t=this._studio.design)||void 0===t?void 0:t.sheet;e&&(this.spaceHolder.style.width=this.totalWidth+"px",this.spaceHolder.style.height=this.totalHeight+"px",this._studio.system.scrollTo(e.scroll.x,e.scroll.y))}get totalWidth(){return Math.max(this.sheetWidth,this.viewWidth)}get totalHeight(){return Math.max(this.sheetHeight,this.viewHeight)}get margin(){let t=this.totalWidth,e=this.totalHeight,i=(t-this.sheetWidth)/2+this.horMargin,s=(e+this.sheetHeight)/2-this.MARGIN;return{x:i-this.scroll.x,y:s-this.scroll.y}}zoom(t,e,i){if(t<100&&(t=100),!e||e.zoom==t)return;if(i){let t=this._studio.$el.getBoundingClientRect();i.x-=t.left,i.y-=t.top}else i={x:this.viewWidth/2,y:this.viewHeight/2};let s=this.margin,n=this.scale,r=(i.x-s.x)/n,o=(s.y-i.y)/n;e.mZoom=t,s=this.margin,n=this.scale,this.scrollTo(e.scroll.x+r*n+s.x-i.x,e.scroll.y+s.y-o*n-i.y)}scrollTo(t,e){let i=this._studio.design.sheet,s=this.totalWidth-this.viewWidth,n=this.totalHeight-this.viewHeight;t<0&&(t=0),e<0&&(e=0),t>s&&(t=s),e>n&&(e=n),i.scroll.x=Math.round(t),i.scroll.y=Math.round(e)}render(){let t=0,e=0,i=this.scale;this._studio.design&&this._studio.design.sheet&&({width:t,height:e}=this._studio.design.sheet),re.setRectangleSize(this.boundary,t,e);let s=this._studio.$el,{x:n,y:r}=this.margin,[o,h]=[this.viewWidth,this.viewHeight];this.isScrollable(),this.lockViewport?this.project.view.viewSize.set(o,h):this.project.view.viewSize.set(s.clientWidth,s.clientHeight),this.project.view.matrix.set(i,0,0,-i,n,r);for(let t of Tt.values(Dt)){let e=this.project.layers[t];Jt[t].clipped&&e.children[0].set({segments:this.boundary.segments}),Jt[t].scaled||(e.applyMatrix=!1,e.matrix.set(1/i,0,0,-1/i,0,0))}}};var It,Ct,Et;t([e],qt.prototype,"viewWidth",void 0),t([e],qt.prototype,"viewHeight",void 0),t([e],qt.prototype,"settings",void 0),t([e],qt.prototype,"scale",null),t([e],qt.prototype,"horMargin",null),t([e],qt.prototype,"sheetWidth",null),t([e],qt.prototype,"sheetHeight",null),t([e],qt.prototype,"isXScrollable",null),t([e],qt.prototype,"isYScrollable",null),t([e],qt.prototype,"isScrollable",null),t([e],qt.prototype,"renderSetting",null),t([e],qt.prototype,"onSheetChange",null),t([e],qt.prototype,"totalWidth",null),t([e],qt.prototype,"totalHeight",null),t([e],qt.prototype,"margin",null),t([e],qt.prototype,"render",null),qt=t([e],qt),function(t){function e(t,e){let i=[],s=new Map;for(let[e,n]of t.entries()){if(s.has(e))continue;let r=n.c.filter((t=>t.type==Rt.coincide)),o=r.find((t=>s.has(-t.e-1))),h=i.length;if(o){let t=s.get(-o.e-1);s.set(e,t),i[t].push(n)}else s.set(e,h),i.push([n]);r.forEach((n=>{e=-n.e-1,s.has(e)||(s.set(e,h),i[h].push(t[e]))}))}return i.map((t=>({overlaps:t,strategy:e})))}t.current="0.4",t.getSample=function(){return{title:"",version:t.current,mode:"layout",layout:{sheet:{width:16,height:16},flaps:[],stretches:[]},tree:{sheet:{width:20,height:20},nodes:[],edges:[]}}},t.process=function(t,i){var s;let n=!1;if("version"in t||("cp"==t.mode&&(t.mode="layout"),t.layout=t.cp,delete t.cp,t.version="beta",delete t.layout.stretches,n=!0),"beta"==t.version){t.version="rc0";let e=t.layout.stretches;if(e)for(let t of e.concat()){let i=t.configuration;!i||i.overlaps&&!i.overlaps.some((t=>t.c.some((t=>t.type==Rt.intersection&&void 0===t.e))))||(e.splice(e.indexOf(t),1),n=!0)}}if("rc0"==t.version){t.version="rc1";let i=t.layout.stretches;if(i)for(let t of i.concat()){if(t.configuration){t.configuration={partitions:e(t.configuration.overlaps,t.configuration.strategy)},t.pattern&&(1==t.configuration.partitions.length?t.pattern={devices:[{gadgets:t.pattern.gadgets,offset:null===(s=t.pattern.offsets)||void 0===s?void 0:s[0]}]}:t.pattern={devices:t.pattern.gadgets.map(((e,i)=>{var s;return{gadgets:[e],offset:null===(s=t.pattern.offsets)||void 0===s?void 0:s[i]}}))})}}}return"rc1"==t.version&&(t.version="0"),"0"==t.version&&(t.version="0.4"),n&&i&&i(t.title),t}}(It||(It={}));class Nt{constructor(t){this.options=new Map;for(let e of t.tree.nodes)this.set("v"+e.id,e);for(let e of t.layout.flaps)this.set("f"+e.id,e);for(let e of t.layout.stretches)this.set("s"+e.id,e)}get(t){let e=t.tag,i=this.options.get(e);return this.options.delete(e),i}set(t,e){this.options.set(t,e)}}!function(t){t.done=function(){return i};const e=new Worker("./lib/paper-master.js");let i=Promise.resolve(),s=null,n=0;function r(t,i){return new Promise((s=>{let n=new MessageChannel;n.port1.onmessage=t=>{let[e,i]=t.data,n=new paper.Path;n.importJSON(e),s([n,i])},e.postMessage([t,i],[n.port2])}))}function o(t){return t<.25?4:t<.5?3:t<1?2:1}t.processJunction=async function(t,e){if(s||(i=new Promise((t=>s=t))),n++,2==e.length){let[i,s]=await r(e[0],e[1]);t.removeChildren(),t.addChild(i),t.strokeWidth=o(s)}else{let[i,s]=await Promise.all([r(e[0],e[3]),r(e[1],e[2])]),[n,h]=i,[l,a]=s;t.removeChildren(),t.addChild(n),t.addChild(l),t.strokeWidth=o(h+a)}0==--n&&(s(),s=null)}}(Ct||(Ct={}));const Ot="undefined"!=typeof TouchEvent;let Pt=Et=class{constructor(t){this.dragging=!1,this._spaceDown=!1,this._touchScaling=[0,0],this._scrolled=!1,this._possiblyReselect=!1,this._scrollLock=!1,this._studio=t;let e=t.$paper.view.element,i=t.$paper.tool=new paper.Tool;i.onKeyDown=this._canvasKeydown.bind(this),i.onKeyUp=this._canvasKeyup.bind(this),i.onMouseDown=this._canvasPointerDown.bind(this),i.onMouseDrag=this._canvasMouseDrag.bind(this),i.onMouseUp=this._canvasMouseup.bind(this),e.addEventListener("wheel",this._canvasWheel.bind(this)),e.addEventListener("touchstart",this._canvasTouch.bind(this)),document.addEventListener("mousemove",this._bodyMousemove.bind(this)),document.addEventListener("touchmove",this._bodyMousemove.bind(this)),document.addEventListener("mouseup",this._bodyMouseup.bind(this)),document.addEventListener("touchend",this._bodyMouseup.bind(this)),document.addEventListener("contextmenu",this._bodyMenu.bind(this)),t.$el.addEventListener("scroll",this.onScroll.bind(this)),this._dragSelectView=new et(t)}static controlPriority(t){return t instanceof Kt||t instanceof yt?1:t instanceof gt||t instanceof wt?2:3}get _controls(){let t=this._studio.design?this._studio.design.sheet.activeControls.concat():[];return t.sort(((t,e)=>Et.controlPriority(t)-Et.controlPriority(e))),this._dragSelectables=t.filter(U.isDragSelectable),t.length||(this._ctrl=[null,null]),t}get selections(){return this._controls.filter((t=>t.selected))}draggableSelections(){this._draggableSelections=this.selections.filter((t=>t instanceof lt))}get _canvas(){return this._studio.$paper.view.element}_processSelection(t,e){let i=null,s=null,n=null,r=this._controls.filter((e=>e.contains(t)));for(let t of r)i||(i=t),t.selected?s=t:s&&!n&&(n=t);if(n||!i||i.selected||(n=i),s){let t=Et.controlPriority(s);r.some((e=>Et.controlPriority(e)<t))&&(this._possiblyReselect=!0)}e?(s&&!n&&s.toggle(),n&&this._select(n)):(s||this.$clearSelection(),!s&&n&&this._select(n)),this._ctrl=[s,n],this.draggableSelections()}_processNextSelection(){let[t,e]=this._ctrl;this._studio.design&&!this._studio.design.dragging&&(t&&e&&this.$clearSelection(),t&&!e&&this.$clearSelection(t),e&&this._select(e)),this.draggableSelections()}_select(t){t.selected||0!=this.selections.length&&!this.selections[0].selectableWith(t)||(t.selected=!0)}$clearSelection(t=null){this._dragSelectView.visible=!1;for(let e of this.selections)e!=t&&(e.selected=!1)}_isSelectEvent(t){return!(this.isTouch(t)&&t.touches.length>1)&&!(t instanceof MouseEvent&&0!=t.button)}_canvasKeydown(t){let e=document.activeElement;return e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||this.key(t.key)}key(t){let e=new V(0,0);switch(t){case"space":return this._studio.$display.isScrollable()&&(this._canvas.style.cursor="grab",this._spaceDown=!0),!1;case"delete":let t=this.selections[0];return t instanceof gt&&this._studio.design.deleteFlaps(this.selections),t instanceof yt&&this._studio.design.deleteVertices(this.selections),!1;case"up":e.set(0,1);break;case"down":e.set(0,-1);break;case"left":e.set(-1,0);break;case"right":e.set(1,0);break;default:return!0}let i=this._draggableSelections;if(0==i.length)return!0;i[0]instanceof Kt&&(e=e.scale(q.TWO));for(let t of i)e=t.dragConstraint(e);for(let t of i)t.drag(e);return!1}_canvasKeyup(){this._canvas.style.cursor="unset",this._spaceDown=!1}_canvasPointerDown(t){let e=t.event,i=document.activeElement;if(i instanceof HTMLElement&&i.blur(),t.event instanceof MouseEvent&&(this._spaceDown||2==t.event.button))return console.log(t.point.round().toString()),void this._setScroll(t.event);this._isSelectEvent(e)&&!this._scrollStart&&(this.isTouch(e)?this._canvasTouchDown(t):this._canvasMouseDown(t))}_canvasTouchDown(t){let e=t.point,i=this._draggableSelections.concat();this._processSelection(e,t.modifiers.control||t.modifiers.meta);let s=this._draggableSelections.concat();1==this.selections.length&&(this._longPressTimeout=window.setTimeout((()=>{this.onLongPress()}),750)),Shrewd.comparer.unorderedArray(i,s)&&this._initDrag(t)}_canvasMouseDown(t){let e=t.point;this._processSelection(e,t.modifiers.control||t.modifiers.meta),this._initDrag(t)}_initDrag(t){if(this._draggableSelections.length){this._lastKnownCursorLocation=new H(t.downPoint).round();for(let t of this._draggableSelections)t.dragStart(this._lastKnownCursorLocation);this.dragging=!0}}_canvasMouseup(t){let e=this._dragSelectView.visible;this._dragSelectView.visible=!1,this._isSelectEvent(t.event)&&(this._scrollStart?t.event instanceof MouseEvent&&(this._scrollStart=!1):e||t.modifiers.control||t.modifiers.meta||this._processNextSelection())}_reselect(t){this.$clearSelection(),this._processSelection(t.point,!1),this.draggableSelections();for(let t of this._draggableSelections)t.dragStart(this._lastKnownCursorLocation);this._possiblyReselect=!1}_canvasMouseDrag(t){if(!this._scrollStart)if(this._possiblyReselect&&(this._reselect(t),this.dragging=!0),this.dragging){let e=new H(t.point).round();if(this._lastKnownCursorLocation.eq(e))return;this._cancelLongPress(),this._lastKnownCursorLocation.set(e);for(let t of this._draggableSelections)e=t.dragConstraint(e);for(let t of this._draggableSelections)t.drag(e);this._studio.design.dragging=!0}else if(this._dragSelectables.length){if(!this._dragSelectView.visible){if(this.isTouch(t.event)&&t.downPoint.getDistance(t.point)<1)return;this.$clearSelection(),this._dragSelectView.visible=!0,this._dragSelectView.down=t.downPoint}this._cancelLongPress(),this._dragSelectView.now=t.point;for(let t of this._dragSelectables)t.selected=this._dragSelectView.contains(new paper.Point(t.dragSelectAnchor))}}_cancelLongPress(){var t;window.clearTimeout(this._longPressTimeout),null===(t=this.onDrag)||void 0===t||t.apply(null)}_canvasWheel(t){if(t.ctrlKey||t.metaKey){t.preventDefault();let e=this._studio.$display,i=this._studio.design;i&&e.zoom(i.sheet.zoom-5*Math.round(i.sheet.zoom*t.deltaY/1e4),i.sheet,{x:t.pageX,y:t.pageY})}}_canvasTouch(t){t.touches.length>1&&!this._scrollStart&&this._studio.design&&(this.$clearSelection(),this._setScroll(t),this._touchScaling=[this.getTouchDistance(t),this._studio.design.sheet.zoom],this._lastKnownCursorLocation=this._locate(t))}getTouchDistance(t){let e=t.touches,i=e[1].pageX-e[0].pageX,s=e[1].pageY-e[0].pageY;return Math.sqrt(i*i+s*s)}getTouchCenter(t){let e=t.touches;return{x:(e[1].pageX+e[0].pageX)/2,y:(e[1].pageY+e[0].pageY)/2}}_bodyMousemove(t){var e,i;if(this._scrollStart&&(t instanceof MouseEvent||t.touches.length>=2)){let s=this._locate(t).sub(this._lastKnownCursorLocation),n=null===(e=this._studio.design)||void 0===e?void 0:e.sheet;if(!n)return;let r=this._studio.$display,{x:o,y:h}=n.scroll;if(r.isXScrollable&&(o-=s.x),r.isYScrollable&&(h-=s.y),r.scrollTo(o,h),this._lastKnownCursorLocation=this._locate(t),this.isTouch(t)){let e=this.getTouchDistance(t),s=e-this._touchScaling[0],o=null!==(i=window.devicePixelRatio)&&void 0!==i?i:1,h=n.zoom*s/o/100;h=Math.round(h+this._touchScaling[1]),r.zoom(h,n,this.getTouchCenter(t)),this._touchScaling=[e,h]}this._scrolled=!0}}onScroll(){var t;if(this._scrollLock)return void(this._scrollLock=!1);if(this._scrollStart)return;let e=null===(t=this._studio.design)||void 0===t?void 0:t.sheet;e&&(e.scroll.x=this._studio.$el.scrollLeft,e.scroll.y=this._studio.$el.scrollTop)}scrollTo(t,e){this._scrollLock=!0,this._studio.$el.scrollTo(t,e)}_setScroll(t){window.clearTimeout(this._longPressTimeout),this._scrollStart=!0,this._scrolled=!1,this._lastKnownCursorLocation=this._locate(t)}_locate(t){return this.isTouch(t)?new H(this.getTouchCenter(t)):new H(t.pageX,t.pageY)}_bodyMouseup(t){this._dragEnd(),window.clearTimeout(this._longPressTimeout),this.isTouch(t)&&0==t.touches.length&&(this._scrollStart=!1)}_dragEnd(){this.dragging=!1,this._studio.design&&(this._studio.design.dragging=!1)}_bodyMenu(t){t.preventDefault(),this._scrollStart=!1}isTouch(t){return Ot&&t instanceof TouchEvent}};var Tt,kt,Dt,Rt;t([h()],Pt.prototype,"_controls",null),t([h()],Pt.prototype,"selections",null),t([e],Pt.prototype,"draggableSelections",null),t([e],Pt.prototype,"dragging",void 0),Pt=Et=t([e],Pt),function(t){t.values=function(t){return Object.values(t).filter((t=>!isNaN(Number(t))))}}(Tt||(Tt={})),function(t){t[t.UR=0]="UR",t[t.UL=1]="UL",t[t.LL=2]="LL",t[t.LR=3]="LR",t[t.R=4]="R",t[t.T=5]="T",t[t.L=6]="L",t[t.B=7]="B",t[t.none=8]="none"}(kt||(kt={})),function(t){t[t.sheet=0]="sheet",t[t.shade=1]="shade",t[t.hinge=2]="hinge",t[t.ridge=3]="ridge",t[t.axisParallel=4]="axisParallel",t[t.junction=5]="junction",t[t.dot=6]="dot",t[t.label=7]="label",t[t.drag=8]="drag"}(Dt||(Dt={})),function(t){t[t.socket=0]="socket",t[t.internal=1]="internal",t[t.side=2]="side",t[t.intersection=3]="intersection",t[t.flap=4]="flap",t[t.coincide=5]="coincide"}(Rt||(Rt={}));const Jt={[Dt.sheet]:{clipped:!1,scaled:!0},[Dt.shade]:{clipped:!0,scaled:!0},[Dt.hinge]:{clipped:!0,scaled:!0},[Dt.ridge]:{clipped:!0,scaled:!0},[Dt.axisParallel]:{clipped:!0,scaled:!0},[Dt.junction]:{clipped:!0,scaled:!0},[Dt.dot]:{clipped:!1,scaled:!1},[Dt.label]:{clipped:!1,scaled:!1},[Dt.drag]:{clipped:!1,scaled:!0}};var jt;!function(t){t.circle={strokeWidth:1,strokeColor:"#69F"},t.dot={fillColor:"#69F",strokeWidth:1,strokeColor:"#000",radius:3},t.dotSelected={strokeWidth:3,strokeColor:"red"},t.hinge={strokeColor:"#69F",strokeWidth:3},t.sheet={strokeWidth:.25,strokeColor:"#000"},t.label={point:[0,0],fillColor:"black",fontWeight:"normal",strokeWidth:.5,fontSize:14},t.glow={point:[0,0],fontWeight:"normal",fillColor:"white",strokeWidth:2.5,strokeColor:"white",fontSize:14},t.edge={strokeWidth:2},t.ridge={strokeWidth:1.25,strokeColor:"red"},t.selection={strokeColor:"#69f",fillColor:"rgba(102, 153, 255, 0.2)"},t.shade={fillColor:"#69F",opacity:.3,strokeWidth:0},t.junction={strokeColor:"red",fillColor:"red",opacity:.3},t.axisParallel={strokeWidth:1,strokeColor:"green"},t.top={}}(jt||(jt={}));const At=[0,1,2,3];function $t(t){return At.map(t)}function Lt(t){return t<4}function Ft(t){return(t+2)%4}class Wt{constructor(t,e){e instanceof V&&(e=t.add(e)),this.p1=t,this.p2=e}toString(){return[this.p1,this.p2].sort().toString()}get isDegenerated(){return this.p1.eq(this.p2)}eq(t){return this.p1.eq(t.p1)&&this.p2.eq(t.p2)||this.p1.eq(t.p2)&&this.p2.eq(t.p1)}contains(t,e=!1){let i=t instanceof H?t:new H(t);if(e&&(i.eq(this.p1)||i.eq(this.p2)))return!0;let s=i.sub(this.p1),n=i.sub(this.p2);return s._x.mul(n._y).eq(n._x.mul(s._y))&&s.dot(n)<0}lineContains(t){return this.vector.parallel(t.sub(this.p1))}intersection(...t){if(1==t.length)return this.intersection(t[0].p1,t[0].p2.sub(t[0].p1));let[e,i,s]=t,n=this.p2.sub(this.p1),r=new Bt(n._x,i._x,n._y,i._y).inverse;if(null==r)return null;let o=r.multiply(new H(e.sub(this.p1))),h=o._x,l=o._y.neg;return h.lt(q.ZERO)||h.gt(q.ONE)||s&&l.lt(q.ZERO)?null:e.add(i.scale(l))}transform(t,e){return new Wt(this.p1.transform(t,e),this.p2.transform(t,e))}shift(t){return new Wt(this.p1.add(t),this.p2.add(t))}static distinct(t){let e=new Set;return t.filter((t=>{let i=t.toString(),s=!e.has(i);return s&&e.add(i),s}))}static subtract(t,e){let i=[],s=new Map;for(let t of e){let e=t.slope.toString(),i=s.get(e);i||s.set(e,i=[]),i.push(t)}for(let e of t){let t=e.slope.toString();s.has(t)?i.push(...e.cancel(s.get(t))):i.push(e)}return i}cancel(t){let e=[this];for(let i of t){let t=[];for(let s of e)t.push(...s._cancel(i));e=t}return e}*_cancel(t){let e=this.contains(t.p1,!0),i=this.contains(t.p2,!0),s=t.contains(this.p1,!0),n=t.contains(this.p2,!0);if(!s||!n)if(e||i)if(e&&i){let e=new Wt(this.p1,t.p1),i=new Wt(this.p1,t.p2),s=new Wt(this.p2,t.p1),n=new Wt(this.p2,t.p2);e.isDegenerated?yield n:i.isDegenerated?yield s:s.isDegenerated?yield i:n.isDegenerated?yield e:e.contains(t.p2)?(yield i,yield s):(yield e,yield n)}else{let i=e?t.p1:t.p2,s=n?this.p1:this.p2;i.eq(s)||(yield new Wt(i,s))}else yield this}get slope(){return this.p1._y.sub(this.p2._y).d(this.p1._x.sub(this.p2._x))}xOrient(){return this.p1._x.gt(this.p2._x)?[this.p2,this.p1]:[this.p1,this.p2]}*gridPoints(){let{p1:t,p2:e}=this,i=e.x-t.x,s=e.y-t.y;if(Math.abs(i)<Math.abs(s)){let s=Math.sign(i);for(let i=ne.int(t.x,s);i*s<=e.x*s;i+=s){let t=this.xIntersection(i);t.isIntegral&&(yield t)}}else{let i=Math.sign(s);for(let s=ne.int(t.y,i);s*i<=e.y*i;s+=i){let t=this.yIntersection(s);t.isIntegral&&(yield t)}}}xIntersection(t){let e=this.p2.sub(this.p1),i=new q(t);return new H(i,this.p1._y.sub(e.slope.mul(this.p1._x.sub(i))))}yIntersection(t){let e=this.p2.sub(this.p1),i=new q(t);return new H(this.p1._x.sub(this.p1._y.sub(i).div(e.slope)),i)}reflect(t){t=t.neg;let e=new Bt(t._x,t._y.neg,t._y,t._x);return t=(t=e.inverse.multiply(this.p2.sub(this.p1))).doubleAngle(),e.multiply(t).reduce()}perpendicular(t){return 0==this.vector.dot(t)}get vector(){return this.p1.sub(this.p2)}}class Bt{constructor(t,e,i,s,n){this.a=t.c(),this.b=e.c(),this.c=i.c(),this.d=s.c(),this.det=n||this.a.mul(this.d).s(this.b.mul(this.c))}toString(){return[this.a,this.b,this.c,this.d].toString()}get determinant(){return this.det.value}get inverse(){return this.det.eq(q.ZERO)?null:new Bt(this.d.div(this.det),this.b.neg.d(this.det),this.c.neg.d(this.det),this.a.div(this.det),this.det.inv)}multiply(t){return new t.constructor(this.a.mul(t._x).a(this.b.mul(t._y)),this.c.mul(t._x).a(this.d.mul(t._y)))}static getTransformMatrix(t,e){if(t.eq(V.ZERO))throw new Error("Cannot transform zero vector.");let i=new Bt(t._x,t._y.neg,t._y,t._x),{_x:s,_y:n}=i.inverse.multiply(e);return new Bt(s,n.neg,n,s)}}var zt,Ht,Vt,Gt;!function(t){function e(t,e,i=!1){if(2==e.length)return i&&new Wt(e[0],e[1]).contains(t,!0);let s=[],n=[];for(let i of e)s.push(i._x.sub(t._x).value),n.push(i._y.sub(t._y).value);let r=!1;for(let t=0,o=e.length-1;t<e.length;o=t++){let[e,h]=[s[t],n[t]],[l,a]=[s[o],n[o]],d=e>=0,u=l>=0,c=h>=0,p=a>=0;if(!(!c&&!p||!d&&!u||d&&u)){if(!c||!p||!d&&!u||d&&u){let t=(h*l-e*a)/(l-e);if(t<0)continue;if(0==t)return i}r=!r}}return r}function i(t,e){return t.push(...t.splice(0,e)),t}t.triangleTransform=function(t,e){let[i,s,n]=t,[r,o,h]=[e,s,n].map((t=>t.sub(i))),l=Bt.getTransformMatrix(o,r);return i.add(l.multiply(h))},t.collect=function(t){let e=[],s=new Map,n=0;for(let r of t){let t=!1;for(let[o,h]of r.entries()){let l=h.toString(),a=s.get(l);if(a){if(!e[a[0]])continue;e[a[0]].splice(a[1],0,...i(r,o));for(let[t,i]of e[a[0]].entries())s.set(i.toString(),[a[0],t]);t=!0;break}s.set(l,[n,o])}t||(e.push(r),n++)}return{paths:e,map:s}},t.join=function(t,e){t=t.concat(),e=e.concat();for(let s=0;s<t.length;s++)for(let n=0;n<e.length;n++)if(t[s].eq(e[n]))return i(e,n),t.splice(s,2,...e),t;return t},t.shift=function(t,e){return t.map((t=>t.add(e)))},t.polygonIntersect=function(t,i){return t.some((t=>e(t,i)))||i.some((i=>e(i,t)))},t.lineInsidePath=function(t,i){return e(t.p1,i,!0)&&e(t.p2,i,!0)},t.pointInsidePath=function(t,i){return e(t,i)},t.toSegments=function(t){return v.segments({regions:[t.map((t=>[t.x,t.y]))],inverted:!1})}}(zt||(zt={}));class Ut{constructor(t,e){t._x.gt(e._x)&&([t,e]=[e,t]),t._y.gt(e._y)&&([t,e]=[new H(t._x,e._y),new H(e._x,t._y)]),[this.p1,this.p2]=[t,e]}contains(t){return this.p1._x.le(t.p1._x)&&this.p1._y.le(t.p1._y)&&this.p2._x.ge(t.p2._x)&&this.p2._y.ge(t.p2._y)}equals(t){return this.p1.eq(t.p1)&&this.p2.eq(t.p2)}get width(){return this.p2._x.sub(this.p1._x).value}get height(){return this.p2._y.sub(this.p1._y).value}get top(){return this.p2.y}get right(){return this.p2.x}toPolyBoolPath(){return[[this.p1.x,this.p1.y],[this.p1.x,this.p2.y],[this.p2.x,this.p2.y],[this.p2.x,this.p1.y]]}}!function(t){function e(t,e,i){let s=[],n=t.length-1;do{s.push(t[n])}while(!t[n--].eq(e));for(let t of i)zt.lineInsidePath(t,s)&&i.delete(t)}function i(t,e,i){return null==e||t.dist.lt(e.dist)||t.dist.eq(e.dist)&&t.angle*i<e.angle*i}function n(t,e,i){let s=t.p2.sub(t.p1),n=new Bt(s._x,i._x,s._y,i._y).inverse;if(null==n)return null;let o=n.multiply(e.sub(t.p1)),h=o._x,l=o._y.neg;return h.lt(q.ZERO)||h.gt(q.ONE)||l.lt(q.ZERO)?null:{point:e.add(i.scale(l)),dist:l,angle:r(i,s),interior:h.gt(q.ZERO)&&h.lt(q.ONE)}}function r(t,e){let i=t.angle-e.angle;for(;i<0;)i+=Math.PI;for(;i>Math.PI;)i-=Math.PI;return i}function o(t,e,i,s,n){let o=i.rotate90(),h=t.p1.sub(e),l=t.p2.sub(e),a=h.dot(o),d=l.dot(o),u=h.dot(i),c=l.dot(i);return(a*s>0||d*s>0)&&(u>0||c>0||!!n&&r(i,t.vector)*s>n*s)}t.create=function(t,h,l,a,d,u,c){let p,g,f,y=[],v=[],_=a,m=h,x=new Set,w=new Set(t);do{p=null;for(let t of w){let e=n(t,m,_);if(e){let n=g?r(_,g):void 0,h=d.has(e.point.toString())?-1:1;if(!e.interior&&!o(t,m,_,h,n))continue;s,i(e,p,h)&&(p=e,f=t)}}if(p){let t=p.point,i=new Wt(m,t);if(c){let t=i.intersection(c);t&&(v.push(t),c=void 0)}if(i.contains(l,!0))break;let s=i.intersection(u);if(s){v.push(s);break}let n=t.toString();x.has(n)?t.eq(y[y.length-1])||e(y,t,w):x.add(n),y.length&&y[y.length-1].eq(t)||y.push(t),c||v.length&&v[v.length-1].eq(t)||v.push(t),g=f.vector,_=f.reflect(_),m=t,w.delete(f)}}while(null!=p);return v},t.getIntersection=n}(Ht||(Ht={})),function(t){function e(t,e){return{c:he(t.c),ox:t.ox,oy:t.oy,parent:e}}t.joinOverlaps=function(t,e,i,s,n,r=!1){r&&([t,e]=[e,t],[i,s]=[s,i]);let o=n?0:2,h=((e.ox>t.ox?3:1)+o)%4;return e.c[o]={type:Rt.coincide,e:i,q:o},e.c[h]={type:Rt.intersection,e:t.c[Ft(o)].e},t.c[Ft(h)]={type:Rt.coincide,e:s,q:h},e},t.cut=function(t,i,s,n,r){let o=e(t,i),h=e(t,i);return n>0?(o.c[2]={type:Rt.internal,e:s-1,q:3},o.c[1]={type:Rt.socket,e:s-1,q:0},o.ox=n,h.c[3]={type:Rt.socket,e:s,q:2},h.c[0]={type:Rt.internal,e:s,q:1},h.ox=t.ox-n,h.shift={x:n,y:0}):(o.c[2]={type:Rt.internal,e:s-1,q:1},o.c[3]={type:Rt.socket,e:s-1,q:0},o.oy=r,h.c[1]={type:Rt.socket,e:s,q:2},h.c[0]={type:Rt.internal,e:s,q:3},h.oy=t.oy-r,h.shift={x:0,y:r}),[{overlaps:[o]},{overlaps:[h]}]},t.toOverlap=e}(Vt||(Vt={})),function(t){t.halfIntegral="HALFINTEGRAL",t.universal="UNIVERSAL",t.baseJoin="BASE_JOIN",t.standardJoin="STANDARD_JOIN",t.perfect="PERFECT"}(Gt||(Gt={}));class Zt{constructor(t,e){this.repo=t,this.seed=null==e?void 0:e.configuration,this.seedSignature=JSON.stringify(this.seed),this.pattern=null==e?void 0:e.pattern}*generate(t){if(this.seed&&this.pattern)try{let t=new nt(this.repo,this.seed,this.pattern);if(!t.entry)throw!0;yield t}catch(t){this.seedSignature=void 0,console.log("Incompatible old version.")}yield*ie.filter(this.search(),(t=>!this.seedSignature||this.seedSignature!=JSON.stringify(t))),t()}*search(){const t=this.repo.structure,e=t=>null!=t.entry;if(1==t.length){let[i]=t;yield*ie.first([this.searchSingleGadget(i),this.searchDoubleRelay(i,0),this.searchSingleGadget(i,Gt.halfIntegral),this.searchSingleGadget(i,Gt.universal)],e)}if(2==t.length){let i=t;yield*ie.first([this.searchThreeFlapJoin(i,Gt.perfect),this.searchThreeFlapRelay(i),this.searchThreeFlapJoin(i),this.searchThreeFlapRelayJoin(i),this.searchThreeFlapJoin(i,Gt.baseJoin),this.searchThreeFlapRelayJoin(i,Gt.baseJoin),this.searchThreeFlapJoin(i,Gt.standardJoin),this.searchThreeFlapRelayJoin(i,Gt.standardJoin),this.searchThreeFlapRelay(i,Gt.halfIntegral)],e)}}*searchSingleGadget(t,e){yield new nt(this.repo,{partitions:[{overlaps:[Vt.toOverlap(t,0)],strategy:e}]})}*searchDoubleRelay(t,e){if(!(t.ox*t.oy%2))if(t.ox<t.oy)for(let i=1;i<=t.oy/2;i++){let s=new nt(this.repo,{partitions:Vt.cut(t,e,-1,0,i)});s.entry&&(yield s,yield new nt(this.repo,{partitions:Vt.cut(t,e,-1,0,t.oy-i)}))}else for(let i=1;i<=t.ox/2;i++){let s=new nt(this.repo,{partitions:Vt.cut(t,e,-1,i,0)});s.entry&&(yield s,yield new nt(this.repo,{partitions:Vt.cut(t,e,-1,t.ox-i,0)}))}}*searchThreeFlapRelay(t,e){let[i,s]=t.map(((t,e)=>Vt.toOverlap(t,e))),n=i.c[2].e==s.c[2].e;i.ox>s.ox&&([i,s]=[s,i]);let[r,o]=he([i,s]);o.ox-=i.ox,r.oy-=s.oy;let[h,l,a,d]=n?[0,1,2,3]:[2,3,0,1];o.c[a]={type:Rt.internal,e:-1,q:d},o.c[l]={type:Rt.intersection,e:i.c[h].e},i.c[d]={type:Rt.socket,e:-2,q:a},r.c[a]={type:Rt.internal,e:-2,q:l},r.c[d]={type:Rt.intersection,e:s.c[h].e},s.c[l]={type:Rt.socket,e:-1,q:a},n||(o.shift={x:i.ox,y:0},r.shift={x:0,y:s.oy}),yield new nt(this.repo,{partitions:[{overlaps:[i],strategy:e},{overlaps:[o],strategy:e}]}),yield new nt(this.repo,{partitions:[{overlaps:[r],strategy:e},{overlaps:[s],strategy:e}]})}*searchThreeFlapJoin(t,e){let[i,s]=t.map(((t,e)=>Vt.toOverlap(t,e)));Vt.joinOverlaps(i,s,-1,-2,i.c[0].e==s.c[0].e),yield new nt(this.repo,{partitions:[{overlaps:[i,s],strategy:e}]})}*searchThreeFlapRelayJoin(t,e){let[i,s]=t.map(((t,e)=>Vt.toOverlap(t,e))),n=i.c[0].e==s.c[0].e,r=s.ox>i.ox,o=(r?i:s).ox,h=(r?s:i).oy;for(let t=1;t<o;t++){let[o,h]=he([i,s]),l=Vt.joinOverlaps(o,h,-1,-2,n,!r);l.ox-=t,n&&(l.shift={x:t,y:0}),yield new nt(this.repo,{partitions:[{overlaps:[o,h],strategy:e}]})}for(let t=1;t<h;t++){let[o,h]=he([i,s]),l=Vt.joinOverlaps(o,h,-1,-2,n,r);l.oy-=t,n&&(l.shift={x:0,y:t}),yield new nt(this.repo,{partitions:[{overlaps:[o,h],strategy:e}]})}}}let Kt=class extends lt{constructor(t,e,i){var s,n,r;super(t.sheet),this.pattern=t,this.partition=e;let{fx:o,fy:h}=t.stretch;this.gadgets=i.gadgets.map((t=>Yt.instantiate(t))),this.addOns=null!==(n=null===(s=i.addOns)||void 0===s?void 0:s.map((t=>x.instantiate(t))))&&void 0!==n?n:[];let l=null!==(r=i.offset)&&void 0!==r?r:0;this.location={x:l*o,y:l*h},this.view=new le(this)}get type(){return"Device"}get tag(){return this.pattern.tag+"."+this.pattern.devices.indexOf(this)}toJSON(){return{gadgets:this.gadgets.map((t=>t.toJSON())),offset:this.getOffset(),addOns:this.addOns.length?this.addOns:void 0}}get _originalDisplacement(){return this.partition.getOriginalDisplacement(this.pattern)}get _origin(){return this.pattern.stretch.origin.add(this._originalDisplacement)}get shouldDispose(){return super.shouldDispose||this.pattern.disposed}get isActive(){return this.pattern.isActive}get anchors(){let t=[],{fx:e,fy:i}=this.pattern.stretch;for(let s of this.gadgets)t.push(s.anchorMap.map((t=>{if(!t[0])debugger;return t[0].transform(e,i).add(this.delta)})));return t}get delta(){return this._origin.add(new V(this.location)).sub(H.ZERO)}get regions(){let t=[];for(let e of this.gadgets)t.push(...e.pieces);return t.push(...this.addOns),t}get regionRidges(){let t=new Map;for(let e of this.regions){let i=this.regions.filter((t=>t!=e&&t.direction.parallel(e.direction))).reduce(((t,e)=>(t.push(...e.shape.ridges.filter((t=>!t.perpendicular(e.direction)))),t)),[]);t.set(e,Wt.subtract(e.shape.ridges,i))}return t}get rawRidges(){let{fx:t,fy:e}=this.pattern.stretch,i=[],s=this.regionRidges;for(let n of this.regions)i.push(...s.get(n).map((i=>i.transform(t,e).shift(this.delta))));return Wt.distinct(i)}get ridges(){let t=this.rawRidges,e=this.neighbors.reduce(((t,e)=>(t.push(...e.rawRidges),t)),[]);return Wt.subtract(t,e)}get axisParallels(){let{fx:t,fy:e}=this.pattern.stretch,i=[];for(let s of this.regions)for(let n of s.axisParallels)i.push(n.transform(t,e).shift(this.delta));return i}get outerRidges(){if(!this.isActive)return[];let t=this.getConnectionRidges();for(let[e,i]of this.intersectionMap)i&&t.push(new Wt(e,i));return Wt.distinct(t)}get intersectionMap(){let t=[];if(!this.isActive)return t;for(let[e,i,s]of this.partition.intersectionCorners){let n=this.anchors[i][s],r=this.partition.getSideConnectionTarget(n,e);t.push([n,r])}return t}get openAnchors(){return this.intersectionMap.filter((t=>!t[1]||t[0].eq(t[1]))).map((t=>t[0]))}getConnectionRidges(t=!1){let e=[];for(let[i,s]of this.partition.overlaps.entries())for(let[n,r]of s.c.entries())(r.type==Rt.flap&&!t||r.type==Rt.internal)&&e.push(new Wt(this.anchors[i][n],this.pattern.getConnectionTarget(r)));return e}constraint(t,e){let{fx:i,fy:s}=this.pattern.stretch,n=i*s,r=Math.round((t.x+n*t.y)/2);for(let[t,e,i]of this.partition.constraints)r=this.fix(r,t,e,i);return new V(r,n*r)}get neighbors(){let t=new Set;for(let e of this.partition.overlaps)for(let i of e.c)if(i.type==Rt.socket||i.type==Rt.internal){let[e]=this.partition.configuration.overlapMap.get(i.e);t.add(this.pattern.devices[e])}return Array.from(t)}fix(t,e,i,s){let n=e.type!=Rt.socket,r=this.pattern.stretch.fx*(0==(n?s:Ft(e.q))?-1:1),o=this.pattern.getConnectionTarget(e),h=n?this.gadgets[i].slacks[s]:this.pattern.gadgets[-e.e-1].slacks[e.q],l=o.x-this.anchors[i][s].x-h*r;return t*r>l*r&&(t=l),t}getOffset(){if(this.disposeEvent(),this.design.dragging)return this._offsetCache;let t=this.partition.getOriginalDisplacement(this.pattern).x;return t-=this._originalDisplacement.x,this._offsetCache=(this.location.x-t)*this.pattern.stretch.fx}};t([p],Kt.prototype,"_originalDisplacement",null),t([e],Kt.prototype,"isActive",null),t([e],Kt.prototype,"anchors",null),t([e],Kt.prototype,"delta",null),t([p],Kt.prototype,"regions",null),t([p],Kt.prototype,"regionRidges",null),t([e],Kt.prototype,"rawRidges",null),t([e],Kt.prototype,"ridges",null),t([e],Kt.prototype,"axisParallels",null),t([e],Kt.prototype,"outerRidges",null),t([e],Kt.prototype,"intersectionMap",null),t([e],Kt.prototype,"openAnchors",null),t([e],Kt.prototype,"neighbors",null),t([e],Kt.prototype,"getOffset",null),Kt=t([e],Kt);class Yt{constructor(t){this.pieces=t.pieces.map((t=>m.instantiate(t))),this.offset=t.offset,this.pieces.forEach((t=>t.offset(this.offset))),this.anchors=t.anchors}toJSON(){return he(this)}get anchorMap(){return $t((t=>{var e,i;if(null===(i=null===(e=this.anchors)||void 0===e?void 0:e[t])||void 0===i?void 0:i.location){let e=new H(this.anchors[t].location);return this.offset&&e.addBy(new V(this.offset)),[e,null]}if(1==this.pieces.length)return[this.pieces[0].anchors[t],0];for(let[e,i]of this.pieces.entries())if(i.anchors[t])return[i.anchors[t],e];debugger;throw new Error}))}_getSlack(t){var e,i,s;return null!==(s=null===(i=null===(e=this.anchors)||void 0===e?void 0:e[t])||void 0===i?void 0:i.slack)&&void 0!==s?s:0}get slacks(){return $t((t=>this._getSlack(t)))}get sx(){return Math.ceil(this.anchorMap[2][0].x-this.anchorMap[0][0].x)}get sy(){return Math.ceil(this.anchorMap[2][0].y-this.anchorMap[0][0].y)}reverseGPS(){let t=Yt.instantiate(this.toJSON()),[e,i]=t.pieces,s=Math.ceil(Math.max(e.sx,i.sx)),n=Math.ceil(Math.max(e.sy,i.sy));return e.reverse(s,n),i.reverse(s,n),t}addSlack(t,e){var i;return this.anchors=this.anchors||[],this.anchors[t]=this.anchors[t]||{},this.anchors[t].slack=(null!==(i=this.anchors[t].slack)&&void 0!==i?i:0)+e,this}setupConnectionSlack(t,e,i){let s=this.contour,n=t.contour,r=0==e?1:-1,o=new V(r,r),h=new q(this._getSlack(e)),l=t.anchorMap[i][0].sub(H.ZERO).addBy(o.scale(h));s=zt.shift(s,0==e?l:l.add(H.ZERO.sub(this.anchorMap[2][0])));let a=0;for(;zt.polygonIntersect(s,n);)s=zt.shift(s,o),a++;return this.addSlack(e,a),a}get contour(){let t=this.pieces,e=t[0].shape.contour;for(let i=1;i<t.length;i++)e=zt.join(e,t[i].shape.contour);return e}rx(t,e){return Math.abs(this.anchorMap[t][0].x-this.anchorMap[e][0].x)}ry(t,e){return Math.abs(this.anchorMap[t][0].y-this.anchorMap[e][0].y)}intersects(t,e){return this.contour.map(((t,e,i)=>new Wt(t,i[(e+1)%i.length]))).some((i=>Ht.getIntersection(i,t,e)))}static instantiate(t){return t instanceof Yt?t:new Yt(t)}static simplify(t){if(t.offset&&0==t.offset.x&&0==t.offset.y&&delete t.offset,t.anchors){for(let[e,i]of t.anchors.entries())i&&(0===i.slack&&delete i.slack,0==Object.keys(i).length&&delete t.anchors[e]);t.anchors.some((t=>!!t))||delete t.anchors}return t}}t([p],Yt.prototype,"anchorMap",null),t([p],Yt.prototype,"slacks",null),t([p],Yt.prototype,"sx",null),t([p],Yt.prototype,"sy",null),t([p],Yt.prototype,"contour",null);class Qt{constructor(t,e){let i=[],[s,n]=t;if(s.ox==n.ox||s.oy==n.oy)return;[this.g1,this.g2]=t.map((t=>{let s=e.structure[t.parent];return i.push(s),Array.from(m.gops(t,s.sx))}));let[r,o]=i;this.oriented=r.c[0].e==o.c[0].e,this.cw=s.ox>n.ox,this.q=this.oriented?0:2,[this.q1,this.q2]=this.oriented?this.cw?[2,1]:[1,2]:this.cw?[0,3]:[3,0],this.intDist=I.getMaxIntersectionDistance(e.sheet.design.tree,r,o,this.oriented),[this.s1,this.s2]=this.oriented?[s.shift,n.shift]:[this.getReverseShift(s,r),this.getReverseShift(n,o)]}*join(t,e){let{g1:i,g2:s}=this,n=[];if(i){for(let r of i)for(let i of s){let s=m.instantiate(r,!0),o=m.instantiate(i,!0);e&&!e(s,o)||n.push(...t(new Xt(this,s,o)))}n.sort(((t,e)=>t[1]-e[1]));for(let[t]of n)yield t}}*simpleJoin(t){let{s1:e,s2:i}=this;yield*this.join((t=>t.simpleJoin()),((s,n)=>{let r=s.direction.parallel(n.direction);return!(t==Gt.perfect&&!r)&&(!e&&!i||!r)}))}*baseJoin(){yield*this.join((t=>t.baseJoin()))}*standardJoin(){let{s1:t,s2:e}=this,i=!!t||!!e,s=0;yield*this.join((t=>t.standardJoin()),((t,e)=>i||0==s++))}getReverseShift(t,e){var i,s,n,r;let o=t.ox+(null!==(s=null===(i=t.shift)||void 0===i?void 0:i.x)&&void 0!==s?s:0),h=t.oy+(null!==(r=null===(n=t.shift)||void 0===n?void 0:n.y)&&void 0!==r?r:0);if(o!=e.ox||h!=e.oy)return{x:o-e.ox,y:h-e.oy}}getRelayJoinIntersection(t,e,i){let s=this.oriented?new V(1,1):new V(-1,-1),n=t.anchors[this.q].sub(new V(e));return t.shape.ridges[i].intersection(n,s)}}class Xt{constructor(t,e,i){let{oriented:s,s1:n,s2:r,q1:o,q2:h,q:l}=this.joiner=t,a=[],d=[],u=e.sx+i.sx,c={x:0,y:0},p={x:0,y:0};if(n){let r=t.getRelayJoinIntersection(i,n,(o+2)%4);if(!r||!r.isIntegral)return;s?(e.offset(c=r.toIPoint()),u+=c.x,a[l]={location:{x:-c.x,y:-c.y}}):(i.offset(p={x:i.sx-r.x,y:i.sy-r.y}),u+=p.x,a[l]={location:{x:e.sx+p.x,y:e.sy+p.y}})}if(r){let n=t.getRelayJoinIntersection(e,r,(h+2)%4);if(!n||!n.isIntegral)return;s?(i.offset(p=n.toIPoint()),u+=p.x,d[l]={location:{x:-p.x,y:-p.y}}):(i.offset(p={x:n.x-e.sx,y:n.y-e.sy}),u-=p.x,d[l]={location:{x:i.sx-p.x,y:i.sy-p.y}})}let g,f=V.ZERO;s||(g={x:e.sx-i.sx,y:e.sy-i.sy},f=new V(g));let y=new V(c).neg,v=new V(p).addBy(f).neg,_=n?e.anchors[l]:i.anchors[l].add(f),m=_.add(y).toIPoint(),x=_.add(v).toIPoint(),w=e.shape.ridges[o],b=i.shape.ridges[h].shift(f),S=V.bisector(e.direction,i.direction),M=s?H.ZERO:n?new H(a[l].location):e.anchors[l],q=s?1:-1;this.data={p1:e,p2:i,v1:y,v2:v,a1:a,a2:d,off1:c,off2:p,offset:g,size:u,pt:_,pt1:m,pt2:x,e1:w,e2:b,bv:S,org:M,f:q}}*simpleJoin(){if(!this.data)return;let{e1:t,e2:e,p1:i,p2:s,pt:n,bv:r}=this.data,o=t.intersection(e);o&&(i.direction.parallel(s.direction)||o.sub(n).parallel(r))&&this.setupAnchor(o)&&(this.setupDetour([o],[o]),yield this.result())}get deltaPt(){let{org:t,p1:e,p2:i,f:s}=this.data,{cw:n,intDist:r}=this.joiner;return new H(t.x+(r-(n?i:e).ox)*s,t.y+(r-(n?e:i).oy)*s)}baseJoinIntersections(){let{bv:t,e1:e,e2:i,pt:s}=this.data,n=new Wt(this.deltaPt,K.QV[0]),r=new Wt(s,t);return{D1:e.intersection(n),D2:i.intersection(n),B1:e.intersection(r),B2:i.intersection(r),delta:n}}*baseJoin(){if(!this.data)return;let{D1:t,D2:e,B1:i,B2:s}=this.baseJoinIntersections();if((null==i?void 0:i.isIntegral)&&(null==e?void 0:e.isIntegral)&&!i.eq(e)){if(!this.setupAnchor(e))return;this.setupDetour([i],[e,i]),yield this.result(!0)}if((null==s?void 0:s.isIntegral)&&(null==t?void 0:t.isIntegral)&&!s.eq(t)){if(!this.setupAnchor(t))return;this.setupDetour([t,s],[s]),yield this.result()}}substituteEnd(t,e){let[i,s]=t.xOrient();return new Wt(e,this.joiner.oriented?s:i)}closestGridPoint(t,e){let i,s=Number.POSITIVE_INFINITY;for(let n of t.gridPoints()){let t=n.dist(e);t<s&&(s=t,i=n)}return i}*standardJoin(){if(!this.data)return;let{D1:t,D2:e,B1:i,B2:s,delta:n}=this.baseJoinIntersections(),{f:r}=this.data;i&&e&&!i.eq(e)&&(e.x*r>i.x*r?yield*this.obtuseStandardJoin(i,e,0):yield*this.acuteStandardJoin(i,e,1,n)),s&&t&&!s.eq(t)&&(t.x*r>s.x*r?yield*this.obtuseStandardJoin(s,t,1):yield*this.acuteStandardJoin(s,t,0,n))}*obtuseStandardJoin(t,e,i){if(t.isIntegral)return;let{e1:s,e2:n,p1:r,p2:o,pt:h,f:l}=this.data,{cw:a}=this.joiner,d=[s,n][i],u=[r,o][i];if(a!=r.direction.slope.gt(o.direction.slope))return;if(!this.setupAnchor(e))return;let c=e.sub(t).slope.gt(q.ONE)?d.xIntersection(e.x):d.yIntersection(e.y),p=this.closestGridPoint(this.substituteEnd(d,t),e);if(p.eq(d.p1)||p.eq(d.p2))return;let g=zt.triangleTransform([e,c,t],p);if(g.x*l<h.x*l)return;d=this.substituteEnd([s,n][1-i],e);let f=d.intersection(new Wt(p,g));(!f||f.eq(p)||f.eq(g))&&(this.data.addOns=[{contour:[e,p,g].map((t=>t.toIPoint())),dir:new Wt(p,g).reflect(u.direction).toIPoint()}],this.setupDetour([0==i?p:e,g],[0==i?e:p,g]),yield this.result(!0,g.dist(p)))}*acuteStandardJoin(t,e,i,s){if(e.isIntegral)return;let{e1:n,e2:r,p1:o,p2:h}=this.data,l=[n,r][i],a=[o,h][i],d=this.closestGridPoint(this.substituteEnd(l,e),t);if(d.eq(l.p1)||d.eq(l.p2))return;let u=e.sub(t).slope.gt(q.ONE)?s.yIntersection(d.y):s.xIntersection(d.x),c=zt.triangleTransform([d,e,u],t);this.setupAnchor(c)&&(this.data.addOns=[{contour:[t,d,c].map((t=>t.toIPoint())),dir:new Wt(d,t).reflect(a.direction).toIPoint()}],this.setupDetour(0==i?[d,t]:[t],0==i?[t]:[d,t]),yield this.result(!0,t.dist(d)))}setupDetour(t,e){let{p1:i,p2:s,v1:n,v2:r,pt1:o,pt2:h}=this.data,l=t.map((t=>t.add(n).toIPoint()));l.push(o);let a=e.map((t=>t.add(r).toIPoint()));a.push(h),(this.joiner.cw?a:l).reverse(),i.clearDetour(),i.addDetour(l),s.clearDetour(),s.addDetour(a)}setupAnchor(t){let{a1:e,a2:i,v1:s,v2:n,f:r}=this.data,{oriented:o,cw:h}=this.joiner;if(t.x*r>this.deltaPt.x*r)return!1;let l=o==h;return e[l?3:1]={location:t.add(s).toIPoint()},i[l?1:3]={location:t.add(n).toIPoint()},!0}result(t=!1,e){let{p1:i,p2:s,a1:n,a2:r,off1:o,off2:h,offset:l,size:a,addOns:d}=this.data;return this.data.addOns=void 0,l&&(h={x:h.x+l.x,y:h.y+l.y}),[{gadgets:[{pieces:[t?i.toJSON():i],offset:this.simplifyIPoint(o),anchors:n.concat()},{pieces:[t?s.toJSON():s],offset:this.simplifyIPoint(h),anchors:r.concat()}],addOns:d},a+10*(null!=e?e:0)]}simplifyIPoint(t){return t&&0==t.x&&0==t.y?void 0:t}}t([p],Xt.prototype,"deltaPt",null);let te=class extends X{constructor(t,e,i){super(t.sheet),this.joinerCache=new Map,this._everActive=!1,this.stretch=t,this.signature=e,this.structure=JSON.parse(e);let s=t.design.options.get(this);s?this.restore(s.configurations.map((t=>new nt(this,t))),s.index):this.generator=new Zt(this,i).generate((()=>this.joinerCache.clear()))}get tag(){return"r"+this.stretch.signature}builder(t){return t}_onSettle(){this._everActive||!this.isActive||this.design.dragging||(this._everActive=!0,this.design.history.construct(this.toMemento()))}get shouldDispose(){return super.shouldDispose||this.stretch.disposed||!this.isActive&&!this.design.dragging}onDispose(){this._everActive&&this.design.history.destruct(this.toMemento()),super.onDispose()}get isActive(){return this.stretch.isActive&&this.stretch.repository==this}onMove(){this.stretch.selected=!this.entry.entry.selected}getJoiner(t){let e=JSON.stringify(t),i=this.joinerCache.get(e);return i||this.joinerCache.set(e,i=new Qt(t,this)),i}toJSON(){return{configurations:this.memento.map((t=>t.toJSON(!0))),index:this.index}}toMemento(){return[this.tag,this.toJSON()]}};var ee,ie,se,ne,re;function oe(t,...e){for(let i of e)if(i instanceof Object){let e=Object.keys(i);for(let s of e){let e=i[s];e instanceof Object?t[s]instanceof Object&&t[s]!=e?t[s]=oe(t[s],e):t[s]=he(e):t[s]=e}}return t}function he(t){return oe(t instanceof Array?[]:{},t)}t([e],te.prototype,"_onSettle",null),t([e],te.prototype,"isActive",null),te=t([e],te),function(t){t.parse=function(t,s){try{let n=new e(s),{result:r}=new i(n);return r.title=t,r}catch(t){throw"string"==typeof t?new Error(t):new Error("plugin.TreeMaker.invalid")}};class e{constructor(t){this.lines=t.split("\n").values()}get next(){return this.lines.next().value.trim()}get int(){return parseInt(this.next)}get float(){return parseFloat(this.next)}get bool(){return"true"==this.next}skip(t){for(let e=0;e<t;e++)this.lines.next()}skipArray(){this.skip(this.int)}}class i{constructor(t){if(this.result=It.getSample(),this.set=new Set,this._visitor=t,"tree"!=t.next||"5.0"!=t.next)throw"plugin.TreeMaker.not5";let e=t.float,i=t.float,s=1/t.float;t.skip(11);let n=t.int,r=t.int;t.skip(6);for(let t=0;t<n;t++)this.parseNode();for(let t=0;t<r;t++)this.parseEdge();let o=ne.LCM(Array.from(this.set)),h=Math.ceil(e*s*o-.25),l=Math.ceil(i*s*o-.25);if(h<8||l<8)throw"plugin.TreeMaker.size8";let a=h/e,d=l/i;for(let t of this.result.layout.flaps)t.x=Math.round(t.x*a),t.y=Math.round(t.y*d);for(let t of this.result.tree.nodes)t.x=Math.round(t.x*a),t.y=Math.round(t.y*d);for(let t of this.result.tree.edges)t.length=Math.max(Math.round(t.length*o),1);let u={width:h,height:l,zoom:20};this.result.layout.sheet=u,this.result.tree.sheet=u}parseNode(){let t=this._visitor;if("node"!=t.next)throw new Error;let e={id:t.int,name:t.next,x:t.float,y:t.float};t.skip(2),t.bool&&this.result.layout.flaps.push({id:e.id,x:e.x,y:e.y,height:0,width:0}),this.result.tree.nodes.push(e),t.skip(6),t.skipArray(),t.skipArray(),t.skipArray(),"1"==t.next&&t.next}parseEdge(){let t=this._visitor;if("edge"!=t.next)throw new Error;t.skip(2);let e=t.float;this.set.add(Number(q.toFraction(e,1,0,.1).$denominator)),this.result.tree.edges.push({length:e*(1+t.float),n1:(t.skip(4),t.int),n2:t.int})}}}(ee||(ee={})),function(t){t.first=function*(t,e){for(let i of t){let t=!1;for(let s of i)e(s)&&(yield s,t=!0);if(t)return}},t.filter=function*(t,e){for(let i of t)e(i)&&(yield i)}}(ie||(ie={})),function(t){let e=new WeakMap;function i(t,e,i,s,n,r){t.justification=0==n?"center":1==n?"left":"right";let o=0==r?-s/5:-1==r?-s/2:0,h=Math.sqrt(n*n+r*r),l=0==h?0:s/2/h;t.point.set(e+n*l,i-r*l-o)}t.setLabel=function(t,s,n,r,...o){if(n.content=s.content,!s.content)return;let h=r.x,l=r.y,a=t.displayScale,d=t.width,u=t.height,c=s.bounds.height,p=h*a,g=-l*a;if(0==h||0==l||h==d||l==u){i(s,p,g,c,0==h?-1:h==d?1:0,0==l?-1:l==u?1:0)}else!function(t,s,n,r,o){let h=[[0,0],[0,-1],[-1,0],[0,1],[1,0],[-1,-1],[-1,1],[1,1],[1,-1]],l=o.map((t=>{let e=t.clone({insert:!1});return t.layer&&e.transform(t.layer.matrix),e})),a=0,d=0;for([a,d]of h){i(t,s,n,r,a,d);let e=new paper.Path.Rectangle(t.bounds);if(t.layer&&e.transform(t.layer.matrix),l.every((t=>{let i=e.intersect(t,{insert:!1}).isEmpty(),s=!e.intersects(t);return i&&s})))break}e.set(t,{dx:a,dy:d,timeout:void 0})}(s,p,g,c,o);!function(t,e){e.point.set(t.point),e.justification=t.justification}(s,n)}}(se||(se={})),function(t){function e(t,e){if("number"==typeof t&&!Number.isSafeInteger(t))return 1;if("number"==typeof e&&!Number.isSafeInteger(e))return 1;if(0==t&&0==e)return 1;for(t<0&&(t=-t),e<0&&(e=-e);t&&e;)(t%=e)&&(e%=t);return t||e}t.GCD=e,t.LCM=function(t){let i=t[0];for(let s=1;s<t.length;s++){let n=e(i,t[s]);i=i*t[s]/n}return i},t.reduce=function(t,e){if("number"==typeof t&&!Number.isInteger(t)||"number"==typeof e&&!Number.isInteger(e)){let i=new q(t),s=new q(e);t=Number(i.$numerator*s.$denominator),e=Number(i.$denominator*s.$numerator)}let i=this.GCD(t,e);return[t/i,e/i,i]},t.int=function(t,e){return e>0?Math.ceil(t):Math.floor(t)}}(ne||(ne={})),function(t){let e,i;t.replaceContent=function(t,e,i){t.removeChildren(),e instanceof paper.CompoundPath?t.copyContent(e):(i&&(e=e.clone({insert:!1})),t.addChild(e))},t.setRectangleSize=function(t,e,i){t.segments[1].point.set(e,0),t.segments[2].point.set(e,i),t.segments[3].point.set(0,i)},t.addLine=function(t,e,i){e instanceof H&&(e=e.toPaper()),i instanceof H&&(i=i.toPaper()),t.moveTo(e),t.lineTo(i)},t.setLines=function(e,...i){e.removeChildren();for(let s of i)for(let i of s)t.addLine(e,i.p1,i.p2)},t.unite=function(t,e){return t.isEmpty()?e:t.unite(e,{insert:!1})},t.Black=function(){return e=e||new paper.Color("black")},t.Red=function(){return i=i||new paper.Color("red")},t.fromSegments=function(t){return v.polygon(t).regions.map((t=>new paper.Path({segments:t,closed:!0})))}}(re||(re={}));let le=class extends tt{constructor(t){super(t),this.$addItem(Dt.axisParallel,this._axisParallels=new paper.CompoundPath(jt.axisParallel)),this.$addItem(Dt.ridge,this._ridges=new paper.CompoundPath(jt.ridge)),this.$addItem(Dt.shade,this._shade=new paper.CompoundPath(jt.shade))}contains(t){return this._shade.contains(t)}render(){let t=null;for(let e of this.control.regions){let i=this.contourToPath(e.shape.contour);t=t?t.unite(i,{insert:!1}):i}re.replaceContent(this._shade,t,!1),re.setLines(this._ridges,this.control.ridges,this.control.outerRidges),re.setLines(this._axisParallels,this.control.axisParallels)}contourToPath(t){let e=new paper.Path({closed:!0}),{fx:i,fy:s}=this.control.pattern.stretch,n=this.control.delta;return t.forEach((t=>e.add(t.transform(i,s).add(n).toPaper()))),e}renderSelection(t){this._shade.visible=t||this.control.pattern.configuration.repository.stretch.selected}};return le=t([e],le),vt}));